<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SportAI Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables - Dark Theme by Default */
        :root {
            /* Dark Theme (Default) */
            --bg-primary: #000000;
            --bg-secondary: #111111;
            --bg-tertiary: #1A1A1A;
            --text-primary: #FFFFFF;
            --text-secondary: #CCCCCC;
            --text-tertiary: #999999;
            --border-color: #333333;
            --border-light: #444444;
            --accent-color: #FFFFFF;
            --accent-secondary: #666666;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --info-color: #3B82F6;
            --calendar-today: #3B82F6;
            --calendar-workout: #10B981;
            --calendar-rest: #8B5CF6;
            
            /* Spacing - Уменьшено для компактности */
            --spacing-xs: 3px;
            --spacing-sm: 6px;
            --spacing-md: 10px;
            --spacing-lg: 14px;
            --spacing-xl: 18px;
            --spacing-xxl: 24px;
            
            /* Typography - Уменьшено для компактности */
            --font-xs: 11px;
            --font-sm: 13px;
            --font-base: 16px;
            --font-lg: 18px;
            --font-xl: 22px;
            --font-xxl: 26px;
            
            /* Border Radius */
            --radius-sm: 3px;
            --radius: 6px;
            --radius-lg: 10px;
            
            /* Line Height */
            --line-height: 1.3;
            
            /* Transitions */
            --transition-fast: 0.12s ease;
            --transition-base: 0.25s ease;
            --transition-slow: 0.4s ease;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 2px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        /* Light Theme Variables */
        [data-theme="light"] {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F5F5F5;
            --bg-tertiary: #EEEEEE;
            --text-primary: #000000;
            --text-secondary: #333333;
            --text-tertiary: #666666;
            --border-color: #DDDDDD;
            --border-light: #EEEEEE;
            --accent-color: #000000;
            --accent-secondary: #888888;
            --success-color: #059669;
            --warning-color: #D97706;
            --danger-color: #DC2626;
            --info-color: #2563EB;
            --calendar-today: #2563EB;
            --calendar-workout: #059669;
            --calendar-rest: #7C3AED;
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            font-size: 14px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: var(--line-height);
            font-weight: 400;
            font-size: var(--font-base);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* App Container */
        .app-container {
            min-height: 100vh;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px; /* Для нижней навигации */
        }

        /* Header - Компактный */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-md);
            z-index: 1000;
            backdrop-filter: blur(20px);
            background-color: rgba(17, 17, 17, 0.95);
        }

        [data-theme="light"] .header {
            background-color: rgba(245, 245, 245, 0.95);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo-icon {
            width: 24px;
            height: 24px;
        }

        .logo-text {
            font-size: var(--font-base);
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* Profile button in header - уменьшен */
        .profile-btn-header {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-base);
            padding: 0;
        }

        .profile-btn-header:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        /* Main Content */
        .main {
            flex: 1;
            padding: 52px var(--spacing-md) var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        /* Navigation - Исправлено */
        .nav {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            width: 100% !important;
            background: var(--bg-secondary) !important;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-sm) 0;
            z-index: 1000;
        }

        .nav-btn {
            background: transparent !important;
            border: none;
            color: var(--text-tertiary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-xs);
            padding: var(--spacing-xs);
            transition: var(--transition-base);
        }

        .nav-btn.active {
            color: var(--accent-color) !important;
            border-top: 2px solid var(--accent-color);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        /* Sections */
        .section {
            display: none;
            flex-direction: column;
            gap: var(--spacing-lg);
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Sport Test Modal */
        .sport-test-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 5000;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: none;
        }

        .sport-test-modal.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .sport-test-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .sport-test-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .test-instruction {
            background: var(--bg-tertiary);
            padding: var(--spacing-md);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-lg);
            border-left: 3px solid var(--info-color);
        }

        .test-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }

        .metric-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--spacing-sm);
            text-align: center;
            font-size: var(--font-base);
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-label {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            text-align: center;
            margin-top: var(--spacing-xs);
        }

        /* Mini Calendar */
        .calendar-mini {
            margin: var(--spacing-sm) 0 var(--spacing-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--spacing-sm);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            padding: 0 var(--spacing-xs);
        }

        .calendar-title {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--text-primary);
        }

        .calendar-nav {
            display: flex;
            gap: var(--spacing-xs);
        }

        .calendar-nav-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .calendar-nav-btn:hover {
            background: var(--border-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            padding: var(--spacing-xs) 0;
            font-weight: 500;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-xs);
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            border: 1px solid transparent;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-tertiary);
        }

        .calendar-day.today {
            background: var(--calendar-today);
            color: white;
            border-color: var(--calendar-today);
        }

        .calendar-day.workout {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .calendar-day.rest {
            background: rgba(139, 92, 246, 0.15);
            color: var(--calendar-rest);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .calendar-day.other-month {
            color: var(--text-tertiary);
            opacity: 0.5;
        }

        .calendar-day.active {
            border: 2px solid var(--accent-color);
        }

        /* Calendar Modal */
        .calendar-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 4000;
            overflow-y: auto;
            padding: 0;
            display: none;
        }

        .calendar-modal.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .calendar-modal-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .calendar-modal-content {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }

        .calendar-modal-day {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-secondary);
        }

        .calendar-modal-title {
            font-size: var(--font-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--accent-color);
        }

        .calendar-modal-subtitle {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .workout-schedule {
            margin: var(--spacing-md) 0;
        }

        .schedule-item {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-xs);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .schedule-time {
            font-weight: 600;
            color: var(--success-color);
            min-width: 60px;
            font-size: var(--font-sm);
        }

        .schedule-activity {
            flex: 1;
            font-size: var(--font-sm);
        }

        /* Onboarding */
        .onboarding {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-md);
            gap: var(--spacing-md);
            overflow-y: auto;
        }

        .onboarding.hidden {
            display: none;
        }

        .onboarding-step {
            display: none;
            flex-direction: column;
            gap: var(--spacing-md);
            flex: 1;
        }

        .onboarding-step.active {
            display: flex;
        }

        .onboarding-progress {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
        }

        .progress-step {
            flex: 1;
            height: 2px;
            background: var(--border-color);
            border-radius: 1px;
            transition: var(--transition-base);
        }

        .progress-step.active {
            background: var(--accent-color);
        }

        /* Test Grid Layout - уменьшен */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-xs);
            margin: var(--spacing-sm) 0;
        }

        .test-option-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--font-xs);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-base);
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .test-option-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-color);
        }

        .test-option-btn.selected {
            background: var(--accent-color);
            color: var(--bg-primary);
            border-color: var(--accent-color);
        }

        /* Typography */
        .h1 {
            font-size: var(--font-xxl);
            font-weight: 700;
            letter-spacing: -0.03em;
            line-height: 1.2;
            margin-bottom: var(--spacing-xs);
        }

        .h2 {
            font-size: var(--font-xl);
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: var(--spacing-sm);
        }

        .h3 {
            font-size: var(--font-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .subtitle {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            line-height: var(--line-height);
            margin-bottom: var(--spacing-sm);
        }

        .caption {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--spacing-sm);
            transition: var(--transition-base);
        }

        .card:hover {
            border-color: var(--border-light);
            box-shadow: var(--shadow-sm);
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--spacing-sm);
        }

        .form-label {
            display: block;
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: var(--font-base);
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition-base);
            line-height: var(--line-height);
            height: 36px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        [data-theme="light"] .form-input:focus {
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        .form-row {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }

        .form-col {
            flex: 1;
        }

        /* Buttons - уменьшены */
        .btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: var(--font-sm);
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: var(--transition-base);
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            text-align: center;
            text-decoration: none;
            min-height: 36px;
            line-height: var(--line-height);
        }

        .btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--accent-color);
            color: var(--bg-primary);
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background: var(--text-secondary);
            border-color: var(--text-secondary);
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-xs);
            min-height: 30px;
        }

        .icon-btn {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Test Components - уменьшены */
        .test-area {
            width: 100%;
            height: 200px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
            margin: var(--spacing-sm) 0;
        }

        .reaction-target {
            position: absolute;
            width: 44px;
            height: 44px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: transform 0.1s;
        }

        .test-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .stat-box {
            padding: var(--spacing-xs);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            text-align: center;
        }

        .stat-value {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Home - Main Hub */
        .welcome-section {
            margin-bottom: var(--spacing-md);
        }

        .greeting {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .time-based-section {
            margin-bottom: var(--spacing-md);
        }

        .time-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            font-size: var(--font-sm);
        }

        .time-icon {
            width: 14px;
            height: 14px;
        }

        .favorite-sport {
            margin-bottom: var(--spacing-md);
        }

        .sport-card-large {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transition: var(--transition-base);
            cursor: pointer;
        }

        .sport-card-large:hover {
            border-color: var(--border-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .sport-icon-large {
            width: 44px;
            height: 44px;
            flex-shrink: 0;
        }

        .sport-info {
            flex: 1;
        }

        .sport-name {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .sport-desc {
            color: var(--text-secondary);
            font-size: var(--font-xs);
            line-height: var(--line-height);
        }

        /* Sports Grid */
        .sports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: var(--spacing-xs);
            margin: var(--spacing-sm) 0;
        }

        .sport-card {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            position: relative;
        }

        .sport-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .sport-card.favorite {
            border-color: var(--warning-color);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent);
        }

        .favorite-star {
            position: absolute;
            top: var(--spacing-xs);
            right: var(--spacing-xs);
            width: 16px;
            height: 16px;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .favorite-star:hover {
            transform: scale(1.1);
        }

        .sport-icon {
            width: 32px;
            height: 32px;
            margin-bottom: var(--spacing-xs);
        }

        /* Today Recommendations */
        .today-recommendations {
            margin: var(--spacing-md) 0;
        }

        .recommendation-card {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-xs);
            background: var(--bg-secondary);
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
        }

        .recommendation-icon {
            width: 20px;
            height: 20px;
        }

        .recommendation-title {
            font-size: var(--font-sm);
            font-weight: 600;
        }

        .recommendation-list {
            list-style: none;
        }

        .recommendation-item {
            padding: var(--spacing-xs) 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            line-height: var(--line-height);
            font-size: var(--font-xs);
        }

        .recommendation-item:last-child {
            border-bottom: none;
        }

        .check-icon {
            width: 14px;
            height: 14px;
            color: var(--success-color);
            flex-shrink: 0;
        }

        /* Profile Section */
        .profile-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-base);
            font-weight: 600;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .profile-meta {
            color: var(--text-secondary);
            font-size: var(--font-xs);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-xs);
            margin: var(--spacing-md) 0;
        }

        .profile-stat-card {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            text-align: center;
            background: var(--bg-secondary);
        }

        .profile-stat-value {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .personal-records {
            margin: var(--spacing-md) 0;
        }

        .record-list {
            list-style: none;
        }

        .record-item {
            padding: var(--spacing-xs);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-xs);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
        }

        .record-info {
            flex: 1;
        }

        .record-name {
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            font-size: var(--font-sm);
        }

        .record-date {
            color: var(--text-tertiary);
            font-size: var(--font-xs);
        }

        .record-value {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--success-color);
        }

        /* Analysis Section */
        .analysis-tabs {
            display: flex;
            gap: var(--spacing-xs);
            background: var(--bg-tertiary);
            padding: var(--spacing-xs);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-sm);
        }

        .analysis-tab {
            flex: 1;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            font-size: var(--font-xs);
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition-base);
        }

        .analysis-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .analysis-content {
            display: none;
            opacity: 0;
            transform: translateY(5px);
            transition: opacity var(--transition-base), transform var(--transition-base);
        }

        .analysis-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Sport Details Modal */
        .sport-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 3000;
            overflow-y: auto;
            padding: 0;
            display: none;
        }

        .sport-details-modal.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .sport-details-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sport-details-content {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }

        .sport-details-section {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-secondary);
        }

        .sport-details-section h3 {
            margin-bottom: var(--spacing-sm);
            color: var(--accent-color);
            font-size: var(--font-base);
            border-bottom: 1px solid var(--border-light);
            padding-bottom: var(--spacing-xs);
        }

        /* Workout list */
        .workout-list {
            list-style: none;
            margin: var(--spacing-sm) 0;
        }

        .workout-item {
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            background: var(--bg-tertiary);
            border-left: 3px solid var(--info-color);
        }

        .workout-item:last-child {
            margin-bottom: 0;
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-xs);
        }

        .workout-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-sm);
        }

        .workout-details {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            display: flex;
            gap: var(--spacing-sm);
        }

        .workout-detail-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .workout-tip {
            font-size: var(--font-xs);
            color: var(--success-color);
            font-style: italic;
            margin-top: var(--spacing-xs);
            padding: var(--spacing-xs);
            background: rgba(16, 185, 129, 0.1);
            border-radius: var(--radius-sm);
            border-left: 2px solid var(--success-color);
        }

        .adaptive-note {
            display: inline-block;
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-xs);
            margin-top: var(--spacing-xs);
            border-left: 2px solid var(--warning-color);
        }

        .dumbbell-weight {
            font-weight: 600;
            color: var(--warning-color);
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
            margin: var(--spacing-sm) 0;
        }

        .nutrition-item {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            text-align: center;
            background: var(--bg-tertiary);
            border-top: 2px solid var(--success-color);
        }

        .nutrition-value {
            font-size: var(--font-base);
            font-weight: 600;
            color: var(--success-color);
            margin-bottom: var(--spacing-xs);
        }

        .nutrition-label {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        .nutrition-dynamic-note {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            margin-top: var(--spacing-xs);
            font-style: italic;
        }

        /* Supplements */
        .supplements-categories {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin: var(--spacing-sm) 0;
        }

        .supplement-category {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            background: var(--bg-tertiary);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
            padding-bottom: var(--spacing-xs);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .category-icon {
            width: 20px;
            height: 20px;
            color: var(--warning-color);
        }

        .category-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-sm);
        }

        .supplements-list {
            list-style: none;
        }

        .supplement-item {
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            background: var(--bg-primary);
        }

        .supplement-item:last-child {
            margin-bottom: 0;
        }

        .supplement-name {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-sm);
        }

        .supplement-desc {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            line-height: 1.4;
        }

        .disclaimer {
            padding: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            border: 1px solid var(--warning-color);
            border-radius: var(--radius);
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            font-size: var(--font-xs);
            text-align: center;
        }

        .gym-goal-selector {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .goal-btn {
            flex: 1;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: var(--font-xs);
            font-weight: 500;
            transition: var(--transition-base);
        }

        .goal-btn.active {
            background: var(--accent-color);
            color: var(--bg-primary);
            border-color: var(--accent-color);
        }

        /* Mark workout button */
        .mark-workout-btn {
            margin-top: var(--spacing-md);
            width: 100%;
        }

        /* Тренировки в день */
        .workout-frequency-selector {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .frequency-btn {
            flex: 1;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: var(--font-xs);
            font-weight: 500;
            transition: var(--transition-base);
        }

        .frequency-btn.active {
            background: var(--info-color);
            color: var(--bg-primary);
            border-color: var(--info-color);
        }

        .position-badge {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            color: var(--info-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: var(--font-xs);
            font-weight: 500;
            margin-top: 4px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .menu-item {
            padding: var(--spacing-xs);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-xs);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-food {
            font-weight: 500;
            color: var(--text-primary);
        }

        .menu-weight {
            color: var(--success-color);
            font-weight: 600;
        }

        .menu-time {
            color: var(--text-tertiary);
            font-size: 10px;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-md);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility Classes */
        .mt-1 { margin-top: var(--spacing-xs); }
        .mt-2 { margin-top: var(--spacing-sm); }
        .mt-3 { margin-top: var(--spacing-md); }
        .mt-4 { margin-top: var(--spacing-lg); }
        .mt-6 { margin-top: var(--spacing-xl); }
        .mb-1 { margin-bottom: var(--spacing-xs); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mb-4 { margin-bottom: var(--spacing-lg); }
        .mb-6 { margin-bottom: var(--spacing-xl); }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-tertiary); }
        .d-none { display: none !important; }
        .d-flex { display: flex; }
        .d-block { display: block; }
        .flex-column { flex-direction: column; }
        .align-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: var(--spacing-sm); }
        .gap-4 { gap: var(--spacing-md); }
        .gap-6 { gap: var(--spacing-lg); }
        .w-100 { width: 100%; }

        /* Responsive */
        @media (max-width: 768px) {
            .main {
                padding: 52px var(--spacing-sm) var(--spacing-sm);
            }
            
            .header {
                padding: 0 var(--spacing-sm);
            }
            
            .form-row {
                flex-direction: column;
                gap: var(--spacing-xs);
            }
            
            .sports-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
            
            .nutrition-grid {
                grid-template-columns: 1fr;
            }
            
            .gym-goal-selector {
                flex-direction: column;
            }
            
            .nav {
                padding: var(--spacing-xs) 0;
            }
        }

        @media (max-width: 480px) {
            .main {
                padding: 52px var(--spacing-xs) var(--spacing-xs);
            }
            
            .onboarding {
                padding: var(--spacing-sm);
            }
            
            .sport-card-large {
                flex-direction: column;
                text-align: center;
                gap: var(--spacing-xs);
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: var(--spacing-xs);
            }
            
            .sports-grid {
                grid-template-columns: 1fr;
            }
            
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                gap: 1px;
            }
            
            .nav-btn {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Onboarding Screen (Fullscreen) -->
        <div class="onboarding" id="onboarding">
            <!-- Step 1: Welcome -->
            <div class="onboarding-step active" id="onboardingStep1">
                <div class="onboarding-progress">
                    <div class="progress-step active"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                </div>
                
                <div class="card">
                    <h1 class="h1">Добро пожаловать в SportAI Pro</h1>
                    <p class="subtitle">Персональный тренер, который подберет идеальный спорт и программу тренировок на основе ваших данных.</p>
                    
                    <div class="mt-4">
                        <h3 class="h3">Как это работает:</h3>
                        <div class="d-flex flex-column gap-4 mt-2">
                            <div class="d-flex gap-3 align-center">
                                <div style="width: 28px; height: 28px; background: var(--bg-tertiary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">1</div>
                                <div>
                                    <div style="font-weight: 500;">Ввод данных</div>
                                    <div class="text-muted">Рост, вес, возраст и замеры тела</div>
                                </div>
                            </div>
                            <div class="d-flex gap-3 align-center">
                                <div style="width: 28px; height: 28px; background: var(--bg-tertiary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">2</div>
                                <div>
                                    <div style="font-weight: 500;">Тестирование</div>
                                    <div class="text-muted">Реакция и упражнения с весом тела</div>
                                </div>
                            </div>
                            <div class="d-flex gap-3 align-center">
                                <div style="width: 28px; height: 28px; background: var(--bg-tertiary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">3</div>
                                <div>
                                    <div style="font-weight: 500;">Анализ</div>
                                    <div class="text-muted">Алгоритм подбирает лучший спорт и программу</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary btn-block mt-4" onclick="SportAI.onboardingNext()">
                        Начать настройку →
                    </button>
                </div>
            </div>

            <!-- Step 2: Basic Data -->
            <div class="onboarding-step" id="onboardingStep2">
                <div class="onboarding-progress">
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                </div>
                
                <div class="card">
                    <h2 class="h2">Ваши базовые данные</h2>
                    <p class="subtitle">Эти данные нужны для точного расчета соматотипа и рекомендаций</p>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Возраст</label>
                            <input type="number" class="form-input" id="age" min="14" max="80" placeholder="25">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Пол</label>
                            <select class="form-input" id="gender">
                                <option value="">Выбрать</option>
                                <option value="male">Мужской</option>
                                <option value="female">Женский</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Рост (см)</label>
                            <input type="number" class="form-input" id="height" min="120" max="220" placeholder="175">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Вес (кг)</label>
                            <input type="number" class="form-input" id="weight" min="30" max="150" placeholder="70">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Обхват запястья (см)</label>
                            <input type="number" class="form-input" id="wrist" min="12" max="25" step="0.1" placeholder="16.5">
                            <div class="caption mt-1">Измерьте самую тонкую часть запястья</div>
                        </div>
                        <div class="form-col">
                            <label class="form-label">Обхват щиколотки (см)</label>
                            <input type="number" class="form-input" id="ankle" min="15" max="30" step="0.1" placeholder="22.5">
                            <div class="caption mt-1">Над косточкой щиколотки</div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3 mt-4">
                        <button class="btn" onclick="SportAI.onboardingPrev()">
                            ← Назад
                        </button>
                        <button class="btn btn-primary" onclick="SportAI.onboardingNext()">
                            Далее: Тест реакции →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Reaction Test -->
            <div class="onboarding-step" id="onboardingStep3">
                <div class="onboarding-progress">
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                    <div class="progress-step"></div>
                </div>
                
                <div class="card">
                    <h2 class="h2">Тест на скорость реакции</h2>
                    <p class="subtitle">Нажимайте на появляющиеся круги как можно быстрее. Тест займет 30 секунд.</p>
                    
                    <div class="test-area" id="reactionArea">
                        <div class="text-center" style="margin-top: 80px; color: var(--text-tertiary); font-size: var(--font-sm);" id="reactionMessage">
                            Нажмите "Начать тест"
                        </div>
                    </div>
                    
                    <div class="test-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="reactionAvg">-</div>
                            <div class="stat-label">Среднее время (мс)</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="reactionBest">-</div>
                            <div class="stat-label">Лучшее время (мс)</div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3">
                        <button class="btn" onclick="SportAI.onboardingPrev()">
                            ← Назад
                        </button>
                        <button class="btn btn-primary" id="startReaction" onclick="SportAI.startReactionTest()">
                            Начать тест
                        </button>
                        <button class="btn btn-primary d-none" id="continueBtn" onclick="SportAI.onboardingNext()">
                            Продолжить →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Bodyweight Test -->
            <div class="onboarding-step" id="onboardingStep4">
                <div class="onboarding-progress">
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                </div>
                
                <div class="card">
                    <h2 class="h2">Тест с весом тела</h2>
                    <p class="subtitle">Введите свои максимальные результаты. Если не можете выполнить - введите 0.</p>
                    
                    <div class="form-group">
                        <label class="form-label">Сколько раз можете отжаться? (полные отжимания)</label>
                        <input type="number" class="form-input" id="pushups" placeholder="0" min="0" value="0">
                        <div class="caption mt-1">Лягте на пол, руки на ширине плеч, опуститесь до угла 90° в локтях</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Сколько секунд можете простоять в планке?</label>
                        <input type="number" class="form-input" id="plank" placeholder="0" min="0" value="0">
                        <div class="caption mt-1">На локтях, тело прямое, таз не провисает</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Сколько раз можете подтянуться?</label>
                        <input type="number" class="form-input" id="pullups" placeholder="0" min="0" value="0">
                        <div class="caption mt-1">Если не можете - введите 0. Используйте прямой хват</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Сколько раз присядете за 1 минуту?</label>
                        <input type="number" class="form-input" id="squats" placeholder="0" min="0" value="0">
                        <div class="caption mt-1">Без веса, бедра параллельны полу, спина прямая</div>
                    </div>
                    
                    <!-- Тест выбора спортивных предпочтений -->
                    <div class="form-group mt-4">
                        <label class="form-label">Какие виды активности вам больше нравятся? (можно выбрать несколько)</label>
                        <div class="test-grid" id="sportPreferences">
                            <button class="test-option-btn" data-value="team">Командные игры</button>
                            <button class="test-option-btn" data-value="strength">Силовые</button>
                            <button class="test-option-btn" data-value="endurance">Выносливость</button>
                            <button class="test-option-btn" data-value="coordination">Координация</button>
                            <button class="test-option-btn" data-value="water">Водные виды</button>
                            <button class="test-option-btn" data-value="martial">Боевые искусства</button>
                        </div>
                    </div>
                    
                    <!-- Настройка частоты тренировок -->
                    <div class="form-group mt-4">
                        <label class="form-label">Количество тренировок в день:</label>
                        <div class="workout-frequency-selector" id="workoutFrequency">
                            <button class="frequency-btn active" data-frequency="1">1 тренировка</button>
                            <button class="frequency-btn" data-frequency="2">2 тренировки</button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="caption mb-1">Уровень подготовки:</div>
                        <div class="stat-value" id="fitnessLevel">Не определен</div>
                        <div class="text-muted mt-1" id="fitnessDescription"></div>
                    </div>
                    
                    <div class="d-flex gap-3 mt-4">
                        <button class="btn" onclick="SportAI.onboardingPrev()">
                            ← Назад
                        </button>
                        <button class="btn btn-primary btn-block" onclick="SportAI.completeOnboarding()">
                            Завершить настройку
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sport Test Modal -->
        <div class="sport-test-modal" id="sportTestModal">
            <div class="sport-test-header">
                <button class="btn btn-sm" onclick="SportAI.closeSportTest()" style="background: var(--bg-tertiary); border-color: var(--border-light);">
                    ← Назад
                </button>
                <h2 class="h2" id="sportTestTitle">Проверка навыков атлета</h2>
            </div>
            
            <div class="sport-test-content">
                <div class="test-instruction">
                    <h3 class="h3" id="sportTestSportName">Название спорта</h3>
                    <p class="subtitle" id="sportTestDescription">Пройдите базовые тесты для этого вида спорта, чтобы получить точные рекомендации по позиции и программе тренировок.</p>
                </div>
                
                <div class="test-metrics" id="sportTestMetrics">
                    <!-- Заполняется JavaScript -->
                </div>
                
                <button class="btn btn-primary btn-block mt-4" onclick="SportAI.saveSportTestResults()">
                    Сохранить результаты и получить рекомендации
                </button>
            </div>
        </div>

        <!-- Sport Details Modal -->
        <div class="sport-details-modal" id="sportDetailsModal">
            <div class="sport-details-header">
                <button class="btn btn-sm" onclick="SportAI.closeSportDetails()" style="background: var(--bg-tertiary); border-color: var(--border-light);">
                    ← Назад к спортам
                </button>
                <h2 class="h2" id="sportDetailsTitle">Название спорта</h2>
            </div>
            
            <div class="sport-details-content">
                <!-- Для зала показываем переключатель целей -->
                <div class="gym-goal-selector d-none" id="gymGoalSelector">
                    <button class="goal-btn active" data-goal="muscle">Набор мышц</button>
                    <button class="goal-btn" data-goal="shape">Форма и рельеф</button>
                </div>
                
                <!-- Рекомендованная позиция (для командных видов) -->
                <div class="sport-details-section d-none" id="positionSection">
                    <h3 class="h3">Рекомендованная позиция</h3>
                    <div class="position-badge" id="positionBadge">Позиция</div>
                    <p class="subtitle mt-2" id="positionDescription">Описание позиции и требований</p>
                </div>
                
                <!-- Тренировки -->
                <div class="sport-details-section">
                    <h3 class="h3">Тренировочная программа</h3>
                    <ul class="workout-list" id="workoutList">
                        <!-- Заполняется JavaScript -->
                    </ul>
                </div>
                
                <!-- Питание -->
                <div class="sport-details-section">
                    <h3 class="h3">Питание на день</h3>
                    <div class="nutrition-grid" id="nutritionGrid">
                        <!-- Заполняется JavaScript -->
                    </div>
                    <div class="mt-3">
                        <strong>Примерное меню на день:</strong>
                        <div id="dailyMenu"></div>
                    </div>
                </div>
                
                <!-- Добавки -->
                <div class="sport-details-section">
                    <h3 class="h3">Добавки и БАДы</h3>
                    <div class="supplements-categories" id="supplementsCategories">
                        <!-- Заполняется JavaScript -->
                    </div>
                    <div class="disclaimer">
                        <strong>Важно:</strong> Перед приемом любых добавок проконсультируйтесь с врачом. 
                        Данные рекомендации носят ознакомительный характер.
                    </div>
                </div>

                <!-- Кнопка отметки тренировки -->
                <button class="btn btn-primary mark-workout-btn" onclick="SportAI.markWorkoutToday()">
                    <svg class="icon-btn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Отметить тренировку сегодня
                </button>
            </div>
        </div>

        <!-- Calendar Modal -->
        <div class="calendar-modal" id="calendarModal">
            <div class="calendar-modal-header">
                <button class="btn btn-sm" onclick="SportAI.closeCalendarModal()" style="background: var(--bg-tertiary); border-color: var(--border-light);">
                    ← Назад
                </button>
                <h2 class="h2" id="calendarModalTitle">Календарь тренировок</h2>
            </div>
            
            <div class="calendar-modal-content">
                <div class="calendar-modal-day" id="calendarDayInfo">
                    <!-- Заполняется JavaScript -->
                </div>
            </div>
        </div>

        <!-- Main App (Hidden until onboarding complete) -->
        <div id="mainApp" class="d-none">
            <!-- Header -->
            <header class="header">
                <div class="logo">
                    <svg class="logo-icon" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 3C9.72 3 3 9.72 3 18C3 26.28 9.72 33 18 33C26.28 33 33 26.28 33 18C33 9.72 26.28 3 18 3Z" stroke="currentColor" stroke-width="2.5"/>
                        <path d="M18 24C21.3137 24 24 21.3137 24 18C24 14.6863 21.3137 12 18 12C14.6863 12 12 14.6863 12 18C12 21.3137 14.6863 24 18 24Z" stroke="currentColor" stroke-width="2.5"/>
                        <path d="M18 30C23.5228 30 28 25.5228 28 20C28 14.4772 23.5228 10 18 10C12.4772 10 8 14.4772 8 20C8 25.5228 12.4772 30 18 30Z" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span class="logo-text">SportAI Pro</span>
                </div>
                
                <div class="header-actions">
                    <div class="profile-btn-header" onclick="SportAI.showSection('profile')" title="Профиль">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 12C14.2091 12 16 10.2091 16 8C16 5.79086 14.2091 4 12 4C9.79086 4 8 5.79086 8 8C8 10.2091 9.79086 12 12 12Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main">
                <!-- Home Section -->
                <section id="home" class="section active">
                    <!-- Welcome Section -->
                    <div class="welcome-section">
                        <div class="greeting" id="greetingText">Доброе утро!</div>
                        <p class="subtitle">Ваши рекомендации на сегодня</p>
                    </div>

                    <!-- Mini Calendar -->
                    <div class="card">
                        <div class="calendar-mini">
                            <div class="calendar-header">
                                <div class="calendar-title" id="calendarMonthTitle">Январь 2025</div>
                                <div class="calendar-nav">
                                    <button class="calendar-nav-btn" onclick="SportAI.changeCalendarMonth(-1)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                    <button class="calendar-nav-btn" onclick="SportAI.changeCalendarMonth(1)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="miniCalendar">
                                <!-- Заполняется JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Time-Based Section -->
                    <div class="time-based-section">
                        <div class="time-indicator" id="timeIndicator">
                            <svg class="time-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span id="timePeriod">Утренние рекомендации</span>
                        </div>
                        
                        <div class="today-recommendations" id="todayRecommendations">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>

                    <!-- Favorite Sport -->
                    <div class="favorite-sport" id="favoriteSportSection">
                        <!-- Filled by JavaScript -->
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <h3 class="h3">Быстрые действия</h3>
                        <div class="d-flex gap-3 mt-2">
                            <button class="btn btn-primary" onclick="SportAI.showSection('analysis')">
                                <svg class="icon-btn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 21H13V15H21V21ZM11 21H3V11H11V21ZM21 13H13V3H21V13ZM11 9H3V3H11V9Z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Анализ
                            </button>
                            <button class="btn" onclick="SportAI.showSection('sports')">
                                <svg class="icon-btn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 8V16M8 12H16" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Виды спорта
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Sports Section -->
                <section id="sports" class="section">
                    <div class="card">
                        <h2 class="h2">Рекомендованные виды спорта</h2>
                        <p class="subtitle">Нажмите на карточку для получения подробной программы. Звездочка - добавить в избранное.</p>
                        
                        <div class="sports-grid" id="sportsGrid">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>
                </section>

                <!-- Analysis Section -->
                <section id="analysis" class="section">
                    <div class="card">
                        <h2 class="h2">Анализ и тестирование</h2>
                        <p class="subtitle">Обновите данные или пройдите тесты заново</p>
                        
                        <div class="analysis-tabs">
                            <button class="analysis-tab active" onclick="SportAI.showAnalysisTab('data')">Данные</button>
                            <button class="analysis-tab" onclick="SportAI.showAnalysisTab('tests')">Тесты</button>
                            <button class="analysis-tab" onclick="SportAI.showAnalysisTab('results')">Результаты</button>
                        </div>
                        
                        <!-- Data Tab -->
                        <div class="analysis-content active" id="analysisData">
                            <div class="form-group">
                                <label class="form-label">Рост (см)</label>
                                <input type="number" class="form-input" id="updateHeight" placeholder="175">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Вес (кг)</label>
                                <input type="number" class="form-input" id="updateWeight" placeholder="70">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <label class="form-label">Обхват запястья (см)</label>
                                    <input type="number" class="form-input" id="updateWrist" step="0.1" placeholder="16.5">
                                </div>
                                <div class="form-col">
                                    <label class="form-label">Обхват щиколотки (см)</label>
                                    <input type="number" class="form-input" id="updateAnkle" step="0.1" placeholder="22.5">
                                </div>
                            </div>
                            
                            <button class="btn btn-primary btn-block mt-3" onclick="SportAI.updateUserData()">
                                Обновить данные и пересчитать питание
                            </button>
                        </div>
                        
                        <!-- Tests Tab -->
                        <div class="analysis-content" id="analysisTests">
                            <div class="card">
                                <h3 class="h3">Тест на реакцию</h3>
                                <p class="subtitle">Проверьте скорость реакции</p>
                                <button class="btn btn-block mt-3" onclick="SportAI.startReactionTest()">
                                    Пройти тест заново
                                </button>
                            </div>
                            
                            <div class="card mt-3">
                                <h3 class="h3">Тест с весом тела</h3>
                                <p class="subtitle">Обновите свои рекорды</p>
                                
                                <div class="form-group mt-3">
                                    <label class="form-label">Отжимания (раз)</label>
                                    <input type="number" class="form-input" id="updatePushups" placeholder="0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Планка (секунд)</label>
                                    <input type="number" class="form-input" id="updatePlank" placeholder="0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Подтягивания (раз)</label>
                                    <input type="number" class="form-input" id="updatePullups" placeholder="0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Приседания за минуту (раз)</label>
                                    <input type="number" class="form-input" id="updateSquats" placeholder="0">
                                </div>
                                
                                <button class="btn btn-primary btn-block mt-3" onclick="SportAI.updateBodyweightTest()">
                                    Обновить рекорды
                                </button>
                            </div>
                        </div>
                        
                        <!-- Results Tab -->
                        <div class="analysis-content" id="analysisResults">
                            <div class="test-stats">
                                <div class="stat-box">
                                    <div class="stat-value" id="analysisReaction">-</div>
                                    <div class="stat-label">Скорость реакции</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="analysisStrength">-</div>
                                    <div class="stat-label">Уровень силы</div>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <h3 class="h3">Соматотип</h3>
                                <div class="stat-value mt-1" id="analysisBodyType">Не определен</div>
                                <div class="text-muted mt-1" id="analysisBodyTypeDesc"></div>
                            </div>
                            
                            <div class="card mt-3">
                                <h3 class="h3">Индекс массы тела (BMI)</h3>
                                <div class="stat-value mt-1" id="analysisBmi">-</div>
                                <div class="text-muted mt-1" id="analysisBmiCategory"></div>
                            </div>
                            
                            <div class="card mt-3">
                                <h3 class="h3">Спортивные навыки</h3>
                                <div id="sportSkillsList">
                                    <!-- Заполняется JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Profile Section -->
                <section id="profile" class="section">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">
                            U
                        </div>
                        <div class="profile-info">
                            <div class="profile-name" id="profileName">Пользователь</div>
                            <div class="profile-meta">
                                <div id="profileAge">Возраст не указан</div>
                                <div id="profileGender">Пол не указан</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="profile-stat-card">
                            <div class="profile-stat-value" id="profileBmi">-</div>
                            <div class="caption">Индекс массы тела</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="profile-stat-value" id="profileBodyType">-</div>
                            <div class="caption">Соматотип</div>
                        </div>
                    </div>
                    
                    <div class="personal-records">
                        <h3 class="h3">Личные рекорды</h3>
                        <p class="subtitle">Ваши лучшие результаты в тестах</p>
                        
                        <div class="record-list" id="personalRecords">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <button class="btn btn-block" onclick="SportAI.resetApp()">
                            <svg class="icon-btn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 18V22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 4.93L7.76 7.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 16.24L19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M2 12H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M18 12H22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 19.07L7.76 16.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 7.76L19.07 4.93" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Сбросить и начать заново
                        </button>
                    </div>
                </section>
            </main>

            <!-- Navigation -->
            <nav class="nav">
                <button class="nav-btn active" onclick="SportAI.showSection('home')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Главная
                </button>
                <button class="nav-btn" onclick="SportAI.showSection('sports')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 8V16M8 12H16" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Спорт
                </button>
                <button class="nav-btn" onclick="SportAI.showSection('analysis')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 21H13V15H21V21ZM11 21H3V11H11V21ZM21 13H13V3H21V13ZM11 9H3V3H11V9Z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Анализ
                </button>
            </nav>
        </div>
    </div>

    <script>
        /**
         * SportAI Pro - Enhanced Version with Deep Personalization
         * Версия 12.0: Продвинутая система расчета нагрузки с биомеханическими формулами
         */

        // Проверяем наличие Telegram WebApp
        const isTelegramApp = typeof window.Telegram !== 'undefined' && 
                              typeof window.Telegram.WebApp !== 'undefined' &&
                              typeof window.Telegram.WebApp.CloudStorage !== 'undefined';

        // Конфигурация тренировочных дней
        const TRAINING_SCHEDULE = {
            workoutDays: [1, 3, 5], // Пн=1, Ср=3, Пт=5
            workoutTime: "18:00-20:00",
            restDays: [0, 2, 4, 6]  // Вс=0, Вт=2, Чт=4, Сб=6
        };

        // ============ КЛАСС РАСЧЕТА НАГРУЗКИ ============
        class LoadCalculator {
            constructor(userData, testResults, sportId = null, goal = null) {
                this.userData = userData;
                this.testResults = testResults;
                this.sportId = sportId;
                this.goal = goal;
                this.athleteModifiers = this.getAthleteModifiers();
                this.sportModifiers = this.getSportModifiers();
            }

            // ЭТАП 1: Определение коэффициентов атлета
            getAthleteModifiers() {
                const modifiers = {
                    strengthLevel: 1.0,
                    bmiMod: 1.0,
                    somatotype: { name: 'Нормостеник', volumeMod: 1.0, intensityMod: 1.0, restMod: 1.0 },
                    hasEquipment: true
                };

                // Расчет уровня силы на основе отжиманий
                if (this.testResults && this.testResults.bodyweight) {
                    const pushups = this.testResults.bodyweight.pushups || 0;
                    if (pushups < 10) modifiers.strengthLevel = 0.6; // Новичок
                    else if (pushups >= 10 && pushups <= 30) modifiers.strengthLevel = 1.0; // Средний
                    else if (pushups > 30) modifiers.strengthLevel = 1.3; // Атлет
                    else modifiers.strengthLevel = 0.8; // по умолчанию для новичков
                    
                    // Также учитываем подтягивания
                    const pullups = this.testResults.bodyweight.pullups || 0;
                    if (pullups > 0) {
                        modifiers.strengthLevel = Math.max(modifiers.strengthLevel, 0.7 + (pullups * 0.05));
                    }
                }

                // Расчет ИМТ и модификатора
                if (this.userData.height && this.userData.weight) {
                    const heightM = this.userData.height / 100;
                    const bmi = this.userData.weight / (heightM * heightM);
                    
                    if (bmi > 28) {
                        modifiers.bmiMod = 0.7; // Снижаем объем на 30% при лишнем весе
                    } else if (bmi < 18.5) {
                        modifiers.bmiMod = 1.2; // Увеличиваем объем для набора массы
                    }
                }

                // Определение соматотипа по формуле (Рост - 100) к Весу
                if (this.userData.height && this.userData.weight) {
                    const normWeight = this.userData.height - 100;
                    const weightDiff = this.userData.weight - normWeight;
                    
                    if (weightDiff < -5) {
                        // Эктоморф (худой)
                        modifiers.somatotype = {
                            name: 'Эктоморф',
                            volumeMod: 0.8,
                            intensityMod: 1.1,
                            restMod: 1.1
                        };
                    } else if (weightDiff > 5) {
                        // Эндоморф (плотный)
                        modifiers.somatotype = {
                            name: 'Эндоморф',
                            volumeMod: 1.2,
                            intensityMod: 0.9,
                            restMod: 0.8 // -20 сек отдыха
                        };
                    } else {
                        // Нормостеник
                        modifiers.somatotype = {
                            name: 'Нормостеник',
                            volumeMod: 1.0,
                            intensityMod: 1.0,
                            restMod: 1.0
                        };
                    }
                }

                return modifiers;
            }

            // ЭТАП 2: Модификаторы спорта
            getSportModifiers() {
                const modifiers = {
                    legWeightReduction: 0,
                    addExercises: [],
                    replaceExercises: {},
                    intervalMode: false,
                    powerMode: false,
                    enduranceFocus: false
                };

                switch(this.sportId) {
                    case 'football':
                        modifiers.legWeightReduction = 0.2; // Снизить вес на ноги на 20%
                        modifiers.addExercises = [
                            { name: 'Планка', type: 'static' },
                            { name: 'Ягодичный мостик', type: 'compound' }
                        ];
                        modifiers.enduranceFocus = true;
                        break;
                    case 'basketball':
                        modifiers.replaceExercises = {
                            'Приседания': 'Приседания с выпрыгиванием'
                        };
                        modifiers.powerMode = true;
                        break;
                    case 'boxing':
                        modifiers.intervalMode = true;
                        break;
                    case 'volleyball':
                        modifiers.powerMode = true;
                        modifiers.addExercises = [
                            { name: 'Прыжки на скакалке', type: 'plyometric' }
                        ];
                        break;
                }

                return modifiers;
            }

            // ЭТАП 3: Расчет подходов и повторений
            calculateSetsAndReps(exerciseType, exerciseName) {
                let baseSets, baseReps;
                
                // Применяем спортивные модификаторы
                if (this.sportModifiers.replaceExercises[exerciseName]) {
                    exerciseName = this.sportModifiers.replaceExercises[exerciseName];
                }
                
                // БАЗОВЫЕ ЗНАЧЕНИЯ ПО ТИПУ УПРАЖНЕНИЯ
                switch(exerciseType) {
                    case 'compound':
                        baseReps = 8;
                        baseSets = 4;
                        
                        if (this.goal === 'muscle') {
                            // Набор массы
                            baseReps = 8;
                            baseSets = 4;
                        } else if (this.goal === 'strength') {
                            // Развитие силы
                            baseReps = 5;
                            baseSets = 5;
                        } else if (this.goal === 'endurance' || this.sportModifiers.enduranceFocus) {
                            // Выносливость
                            baseReps = 15;
                            baseSets = 3;
                        }
                        
                        // Баскетбольный режим мощности
                        if (this.sportModifiers.powerMode && exerciseName.includes('Приседания')) {
                            baseReps = 7; // 6-8 повторений для мощности
                            baseSets = 4;
                        }
                        break;
                        
                    case 'isolation':
                        baseReps = 12;
                        baseSets = 3;
                        
                        // Никогда не меньше 10 повторений для изоляции
                        if (baseReps < 10) baseReps = 10;
                        if (baseSets < 3) baseSets = 3;
                        break;
                        
                    case 'plyometric':
                        baseReps = 10;
                        baseSets = 4;
                        
                        // Ограничения при высоком ИМТ
                        if (this.athleteModifiers.bmiMod < 1.0) {
                            if (this.userData.height && this.userData.weight) {
                                const heightM = this.userData.height / 100;
                                const bmi = this.userData.weight / (heightM * heightM);
                                if (bmi > 30) {
                                    // Заменяем прыжки на ходьбу для ИМТ >30
                                    return {
                                        sets: 3,
                                        reps: 0,
                                        note: 'Ходьба в гору 20-30 мин (замена из-за ИМТ >30)',
                                        originalName: exerciseName,
                                        replaced: true,
                                        type: 'cardio'
                                    };
                                } else if (bmi > 28) {
                                    baseReps = 5; // Снижаем повторения для ИМТ >28
                                }
                            }
                        }
                        
                        // Максимум 12 повторений для прыжков
                        if (baseReps > 12) baseReps = 12;
                        break;
                        
                    case 'static':
                        baseSets = 3;
                        baseReps = 1;
                        break;
                        
                    case 'cardio':
                        baseSets = 1;
                        baseReps = 1;
                        break;
                        
                    default:
                        baseSets = 3;
                        baseReps = 10;
                }
                
                // ПРИМЕНЯЕМ МОДИФИКАТОРЫ АТЛЕТА
                let finalReps = Math.round(baseReps * this.athleteModifiers.somatotype.volumeMod * this.athleteModifiers.bmiMod);
                let finalSets = Math.round(baseSets * this.athleteModifiers.somatotype.volumeMod);
                
                // ОГРАНИЧЕНИЯ
                if (exerciseType === 'plyometric' && finalReps > 12) finalReps = 12;
                if (exerciseType === 'isolation' && finalReps < 10) finalReps = 10;
                if (finalSets < 2) finalSets = 2;
                if (finalSets > 6) finalSets = 6;
                
                // Футбольная выносливость: увеличиваем повторения для ног
                if (this.sportModifiers.enduranceFocus && 
                    (exerciseName.includes('Приседания') || exerciseName.includes('Ноги') || exerciseName.includes('Выпады'))) {
                    finalReps = Math.round(finalReps * 1.3); // +30% повторений
                }
                
                return {
                    sets: finalSets,
                    reps: finalReps,
                    originalName: exerciseName,
                    type: exerciseType
                };
            }

            // ЭТАП 4: Расчет веса отягощения
            calculateWeight(exerciseType, exerciseName) {
                if (!this.userData.weight) return "Собственный вес";
                
                const bw = this.userData.weight; // Масса тела
                let weight = 0;
                let note = "";
                
                // Определяем базовый процент от веса тела
                if (exerciseName.includes('Приседания') || exerciseName.includes('Становая')) {
                    weight = bw * 0.5; // 50% от массы тела
                } else if (exerciseName.includes('Жим лежа') || exerciseName.includes('Жим штанги лежа')) {
                    weight = bw * 0.3; // 30% от массы тела
                } else if (exerciseName.includes('Тяга') || exerciseName.includes('Подтягивания')) {
                    weight = bw * 0.4; // 40% от массы тела
                } else if (exerciseName.includes('Махи') || exerciseName.includes('Разводка') || exerciseName.includes('Бицепс')) {
                    weight = bw * 0.15; // 15% от массы тела для изоляции
                } else if (exerciseName.includes('Плечи') || exerciseName.includes('Жим стоя')) {
                    weight = bw * 0.2; // 20% от массы тела
                } else {
                    weight = bw * 0.25; // По умолчанию 25%
                }
                
                // Применяем модификатор силы
                weight *= this.athleteModifiers.strengthLevel;
                
                // Применяем модификатор соматотипа
                weight *= this.athleteModifiers.somatotype.intensityMod;
                
                // Спортивные модификаторы: футбол - снижаем вес ног
                if (this.sportModifiers.legWeightReduction > 0 && 
                    (exerciseName.includes('Приседания') || exerciseName.includes('Ноги') || 
                     exerciseName.includes('Выпады') || exerciseName.includes('Ягодичный мостик'))) {
                    weight *= (1 - this.sportModifiers.legWeightReduction);
                    note = "Вес снижен на 20% для футбольной выносливости";
                }
                
                // Округляем до ближайших 2.5 кг (стандартные блины)
                weight = Math.round(weight / 2.5) * 2.5;
                
                // Минимальный вес
                if (weight < 5) weight = 5;
                
                // Максимальный разумный вес
                if (weight > bw * 1.2) weight = bw * 1.2;
                
                // Для дома или отсутствия оборудования
                if (!this.athleteModifiers.hasEquipment) {
                    if (weight > 20) {
                        return "Рюкзак с книгами/Бутылки с водой";
                    } else {
                        return "Собственный вес";
                    }
                }
                
                return {
                    kg: Math.round(weight * 10) / 10, // Округляем до 0.1 кг
                    note: note
                };
            }

            // ЭТАП 5: Расчет времени отдыха
            calculateRestTime(exerciseType, exerciseName) {
                let baseRest = 120; // секунд для compound упражнений
                
                switch(exerciseType) {
                    case 'isolation':
                        baseRest = 60;
                        break;
                    case 'plyometric':
                        baseRest = 90;
                        break;
                    case 'static':
                        baseRest = 45;
                        break;
                    case 'cardio':
                        baseRest = 30;
                        break;
                }
                
                // Применяем модификатор соматотипа
                let rest = baseRest * this.athleteModifiers.somatotype.restMod;
                
                // При высоком ИМТ увеличиваем отдых
                if (this.athleteModifiers.bmiMod < 1.0) {
                    rest *= 1.3; // +30% отдыха
                }
                
                // Футбольная выносливость: уменьшаем отдых для ног
                if (this.sportModifiers.enduranceFocus && 
                    (exerciseName.includes('Приседания') || exerciseName.includes('Ноги'))) {
                    rest *= 0.8; // -20% отдыха
                }
                
                // Интервальный режим для бокса
                if (this.sportModifiers.intervalMode) {
                    return "45 сек работы / 15 сек отдыха";
                }
                
                // Округляем до 5 секунд
                rest = Math.round(rest / 5) * 5;
                
                return Math.round(rest) + " сек";
            }

            // Генерация полной тренировки
            generateWorkout(exercises, count = 5) {
                const workout = [];
                
                // Выбираем упражнения
                const selectedExercises = this.selectRandomExercises(exercises, count);
                
                // Добавляем дополнительные упражнения для спорта
                if (this.sportModifiers.addExercises.length > 0) {
                    selectedExercises.push(...this.sportModifiers.addExercises);
                }
                
                // Генерируем параметры для каждого упражнения
                selectedExercises.forEach(exercise => {
                    const setsReps = this.calculateSetsAndReps(exercise.type, exercise.name);
                    
                    // Если упражнение заменено из-за ИМТ
                    if (setsReps.replaced) {
                        workout.push({
                            name: setsReps.note,
                            sets: setsReps.sets,
                            reps: setsReps.reps,
                            weight: "Собственный вес",
                            rest: "60 сек",
                            tip: "Замена прыжков из-за высокого ИМТ для безопасности суставов",
                            type: setsReps.type,
                            adaptiveNote: "Адаптировано под ваш ИМТ"
                        });
                        return;
                    }
                    
                    const weightInfo = this.calculateWeight(exercise.type, exercise.name);
                    const restTime = this.calculateRestTime(exercise.type, exercise.name);
                    
                    workout.push({
                        name: setsReps.originalName,
                        sets: setsReps.sets,
                        reps: setsReps.reps,
                        weight: typeof weightInfo === 'object' ? weightInfo.kg + " кг" : weightInfo,
                        weightNote: typeof weightInfo === 'object' ? weightInfo.note : "",
                        rest: restTime,
                        tip: this.getExerciseTip(exercise.name),
                        type: exercise.type
                    });
                });
                
                return workout;
            }

            // Вспомогательные методы
            selectRandomExercises(pool, count) {
                const shuffled = [...pool].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, Math.min(count, shuffled.length));
            }

            getExerciseTip(exerciseName) {
                const tips = {
                    'Приседания': 'Держите спину прямо, колени над стопами, глубина до параллели',
                    'Жим лежа': 'Сводите лопатки, контролируйте опускание, не отрывайте таз',
                    'Подтягивания': 'В верхней точке касайтесь перекладины грудью, полная амплитуда',
                    'Становая тяга': 'Сохраняйте естественный прогиб в пояснице, поднимайте плавно',
                    'Планка': 'Напрягайте ягодицы и пресс, не провисайте, держите тело прямо',
                    'Приседания с выпрыгиванием': 'Приземляйтесь мягко на полные стопы, амортизируйте коленями',
                    'Ягодичный мостик': 'В верхней точке сжимайте ягодицы, держите корпус напряженным',
                    'Берпи': 'Сохраняйте высокий темп, но следите за техникой, не сутультесь',
                    'Выпады': 'Переднее колено не выходит за носок, заднее почти касается пола',
                    'Отжимания': 'Локти под углом 45°, тело прямое, касайтесь грудью пола'
                };
                
                for (const [key, tip] of Object.entries(tips)) {
                    if (exerciseName.includes(key)) {
                        return tip;
                    }
                }
                
                return "Сосредоточьтесь на правильной технике выполнения, дышите правильно";
            }
        }

        // СПОРТИВНЫЕ ТЕСТЫ
        const SPORT_SPECIFIC_TESTS = {
            football: {
                name: "Футбол",
                tests: [
                    { id: "shuttle", name: "Челночный бег 4x10м", unit: "сек", min: 8, max: 15 },
                    { id: "sprint30", name: "Спринт 30м", unit: "сек", min: 3.5, max: 6 },
                    { id: "dribble", name: "Дриблинг на 20м", unit: "сек", min: 5, max: 12 },
                    { id: "jump", name: "Прыжок в высоту", unit: "см", min: 30, max: 70 }
                ],
                positions: [
                    {
                        name: "Вратарь",
                        requirements: { reaction: 250, jump: 45, height: 185 },
                        description: "Отличная реакция и прыгучесть. Ответственная позиция."
                    },
                    {
                        name: "Центральный защитник",
                        requirements: { height: 180, strength: "high", jump: 40 },
                        description: "Силовая игра, борьба в воздухе, лидерство в обороне."
                    },
                    {
                        name: "Крайний защитник",
                        requirements: { sprint30: 4.5, endurance: "high" },
                        description: "Скорость и выносливость для поддержки атак."
                    },
                    {
                        name: "Центральный полузащитник",
                        requirements: { shuttle: 10.5, endurance: "very high" },
                        description: "Выносливость и видение поля, контроль игры."
                    },
                    {
                        name: "Крайний нападающий (Вингер)",
                        requirements: { sprint30: 4.2, dribble: 7, agility: "high" },
                        description: "Скорость, дриблинг, завершение атак."
                    },
                    {
                        name: "Центральный нападающий",
                        requirements: { jump: 50, strength: "high", height: 180 },
                        description: "Игра в штрафной, завершение атак, игра головой."
                    }
                ]
            },
            
            basketball: {
                name: "Баскетбол",
                tests: [
                    { id: "vertical", name: "Вертикальный прыжок", unit: "см", min: 30, max: 80 },
                    { id: "sprint20", name: "Спринт 20м", unit: "сек", min: 2.8, max: 4.5 },
                    { id: "shooting", name: "Точность бросков из-под кольца", unit: "из 10", min: 0, max: 10 },
                    { id: "dribble", name: "Ведение мяча на скорость", unit: "сек", min: 5, max: 12 }
                ],
                positions: [
                    {
                        name: "Разыгрывающий",
                        requirements: { dribble: 7, reaction: 250, height: 175 },
                        description: "Контроль мяча, видение площадки, организация атак."
                    },
                    {
                        name: "Атакующий защитник",
                        requirements: { shooting: 7, vertical: 50, sprint20: 3.5 },
                        description: "Завершение атак, скорость, прыгучесть."
                    },
                    {
                        name: "Легкий форвард",
                        requirements: { vertical: 55, height: 195, shooting: 6 },
                        description: "Универсальность, защита, подборы, быстрые прорывы."
                    },
                    {
                        name: "Тяжелый форвард",
                        requirements: { height: 200, vertical: 60, strength: "high" },
                        description: "Силовая игра под кольцом, подборы, защита."
                    },
                    {
                        name: "Центровой",
                        requirements: { height: 205, vertical: 65, strength: "very high" },
                        description: "Доминирование под кольцом, блок-шоты, подборы."
                    }
                ]
            },
            
            volleyball: {
                name: "Волейбол",
                tests: [
                    { id: "vertical", name: "Вертикальный прыжок", unit: "см", min: 30, max: 80 },
                    { id: "reaction", name: "Скорость реакции", unit: "мс", min: 150, max: 350 },
                    { id: "serve", name: "Точность подачи", unit: "из 10", min: 0, max: 10 },
                    { id: "block", name: "Высота блока", unit: "см", min: 200, max: 300 }
                ],
                positions: [
                    {
                        name: "Связующий",
                        requirements: { reaction: 220, height: 185 },
                        description: "Тактическое мышление, точные передачи, лидерство."
                    },
                    {
                        name: "Доигровщик",
                        requirements: { vertical: 60, height: 190 },
                        description: "Атакующие действия, завершение атак, прыгучесть."
                    },
                    {
                        name: "Центральный блокирующий",
                        requirements: { height: 195, block: 260, vertical: 55 },
                        description: "Блокирование атак, быстрые атаки, высота."
                    },
                    {
                        name: "Диагональный",
                        requirements: { vertical: 65, height: 195, strength: "high" },
                        description: "Сильнейший нападающий, мощные удары, завершение."
                    },
                    {
                        name: "Либеро",
                        requirements: { reaction: 200, agility: "very high" },
                        description: "Защита, прием мяча, стабильность в защите."
                    }
                ]
            },
            
            boxing: {
                name: "Бокс",
                tests: [
                    { id: "punch_speed", name: "Скорость ударов за 30 сек", unit: "ударов", min: 30, max: 80 },
                    { id: "reaction", name: "Скорость реакции", unit: "мс", min: 150, max: 350 },
                    { id: "endurance", name: "Скакалка за 3 мин", unit: "раз", min: 200, max: 500 },
                    { id: "power", name: "Удар по мешку (сила)", unit: "кг", min: 100, max: 300 }
                ],
                positions: [
                    {
                        name: "Аутфайтер (Дальний бой)",
                        requirements: { height: 180, reach: "long", endurance: 400 },
                        description: "Работа на дистанции, скорость, техника, выносливость."
                    },
                    {
                        name: "Инфайтер (Ближний бой)",
                        requirements: { power: 200, punch_speed: 60, strength: "high" },
                        description: "Мощные удары, работа в клинче, силовая подготовка."
                    },
                    {
                        name: "Свормер (Давящий стиль)",
                        requirements: { endurance: 450, punch_speed: 70, reaction: 220 },
                        description: "Постоянное давление, высокая активность, выносливость."
                    },
                    {
                        name: "Контрпанчер (Контр-ударчик)",
                        requirements: { reaction: 180, timing: "excellent" },
                        description: "Точность, работа на контратаках, скорость реакции."
                    }
                ]
            },
            
            gym: {
                name: "Тренажерный зал",
                tests: [],
                positions: []
            }
        };

        // Расширенная база упражнений с типами
        const EXERCISE_DATABASE = {
            strength: [
                { name: 'Приседания со штангой', type: 'compound', primary: 'ноги', secondary: ['спина', 'пресс'] },
                { name: 'Жим штанги лежа', type: 'compound', primary: 'грудь', secondary: ['трицепс', 'передние дельты'] },
                { name: 'Становая тяга', type: 'compound', primary: 'спина', secondary: ['ноги', 'предплечья'] },
                { name: 'Жим штанги стоя', type: 'compound', primary: 'плечи', secondary: ['трицепс'] },
                { name: 'Подтягивания', type: 'compound', primary: 'спина', secondary: ['бицепс', 'предплечья'] },
                { name: 'Отжимания на брусьях', type: 'compound', primary: 'грудь', secondary: ['трицепс', 'передние дельты'] },
                { name: 'Тяга штанги в наклоне', type: 'compound', primary: 'спина', secondary: ['бицепс', 'задние дельты'] },
                { name: 'Армейский жим', type: 'compound', primary: 'плечи', secondary: ['трицепс'] },
                { name: 'Румынская тяга', type: 'compound', primary: 'задняя поверхность бедра', secondary: ['ягодицы', 'спина'] },
                { name: 'Выпады с гантелями', type: 'compound', primary: 'ноги', secondary: ['ягодицы', 'пресс'] },
                { name: 'Сгибания рук на бицепс', type: 'isolation', primary: 'бицепс', secondary: [] },
                { name: 'Разгибания на трицепс', type: 'isolation', primary: 'трицепс', secondary: [] },
                { name: 'Махи гантелями в стороны', type: 'isolation', primary: 'плечи', secondary: [] },
                { name: 'Подъем на носки', type: 'isolation', primary: 'икры', secondary: [] }
            ],
            
            endurance: [
                { name: 'Берпи', type: 'plyometric', primary: 'все тело', secondary: ['кардио'] },
                { name: 'Скакалка', type: 'cardio', primary: 'ноги', secondary: ['кардио', 'икры'] },
                { name: 'Бег на месте с высоким подниманием бедра', type: 'cardio', primary: 'ноги', secondary: ['кардио'] },
                { name: 'Прыжки на тумбу', type: 'plyometric', primary: 'ноги', secondary: ['взрывная сила'] },
                { name: 'Планка', type: 'static', primary: 'пресс', secondary: ['кора', 'плечи'] },
                { name: 'Боковая планка', type: 'static', primary: 'косые мышцы', secondary: ['кора'] },
                { name: 'Приседания с выпрыгиванием', type: 'plyometric', primary: 'ноги', secondary: ['взрывная сила'] },
                { name: 'Альпинист', type: 'cardio', primary: 'пресс', secondary: ['кардио', 'ноги'] },
                { name: 'Велосипедные скручивания', type: 'isolation', primary: 'пресс', secondary: ['косые мышцы'] },
                { name: 'Русские скручивания', type: 'isolation', primary: 'пресс', secondary: ['косые мышцы'] },
                { name: 'Отжимания', type: 'compound', primary: 'грудь', secondary: ['трицепс', 'плечи'] },
                { name: 'Воздушные приседания', type: 'compound', primary: 'ноги', secondary: ['ягодицы'] }
            ],
            
            team_sports: [
                { name: 'Спринты 30м', type: 'plyometric', primary: 'ноги', secondary: ['скорость'] },
                { name: 'Бег с ускорением', type: 'plyometric', primary: 'ноги', secondary: ['взрывная сила'] },
                { name: 'Прыжки в длину', type: 'plyometric', primary: 'ноги', secondary: ['взрывная сила'] },
                { name: 'Боковые перемещения', type: 'plyometric', primary: 'ноги', secondary: ['координация'] },
                { name: 'Приседания с весом', type: 'compound', primary: 'ноги', secondary: ['сила'] },
                { name: 'Выпады с поворотом', type: 'plyometric', primary: 'ноги', secondary: ['координация'] },
                { name: 'Прыжки на одной ноге', type: 'plyometric', primary: 'ноги', secondary: ['баланс'] },
                { name: 'Бег спиной вперед', type: 'cardio', primary: 'ноги', secondary: ['координация'] },
                { name: 'Бег с высоким подниманием коленей', type: 'plyometric', primary: 'ноги', secondary: ['скорость'] },
                { name: 'Прыжки через барьеры', type: 'plyometric', primary: 'ноги', secondary: ['взрывная сила'] }
            ]
        };

        // База данных спорта
        const SPORTS_DATABASE = {
            football: {
                id: 'football',
                name: 'Футбол',
                description: 'Командная игра, кардио, выносливость',
                icon: '<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2"/><path d="M20 8V32M32 20H8M28 12L12 28M28 28L12 12" stroke="currentColor" stroke-width="2"/></svg>',
                category: 'team',
                activityMultiplier: 1.725,
                nutritionFormula: {
                    proteinPerKg: 1.6,
                    carbsPerKg: 6,
                    fatPerKg: 1,
                    calorieSurplus: 0.15
                },
                testConfig: SPORT_SPECIFIC_TESTS.football
            },
            basketball: {
                id: 'basketball',
                name: 'Баскетбол',
                description: 'Координация, прыжки, скорость',
                icon: '<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2"/><path d="M20 12V28M12 20H28" stroke="currentColor" stroke-width="2"/><circle cx="20" cy="20" r="6" stroke="currentColor" stroke-width="2"/></svg>',
                category: 'team',
                activityMultiplier: 1.725,
                nutritionFormula: {
                    proteinPerKg: 1.7,
                    carbsPerKg: 5.5,
                    fatPerKg: 1,
                    calorieSurplus: 0.15
                },
                testConfig: SPORT_SPECIFIC_TESTS.basketball
            },
            volleyball: {
                id: 'volleyball',
                name: 'Волейбол',
                description: 'Реакция, команда, прыгучесть',
                icon: '<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2"/><path d="M12 16L28 24M28 16L12 24M20 10V30" stroke="currentColor" stroke-width="2"/></svg>',
                category: 'team',
                activityMultiplier: 1.725,
                nutritionFormula: {
                    proteinPerKg: 1.6,
                    carbsPerKg: 5,
                    fatPerKg: 1,
                    calorieSurplus: 0.15
                },
                testConfig: SPORT_SPECIFIC_TESTS.volleyball
            },
            boxing: {
                id: 'boxing',
                name: 'Бокс',
                description: 'Реакция, скорость, выносливость',
                icon: '<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="8" y="8" width="24" height="24" rx="4" stroke="currentColor" stroke-width="2"/><path d="M16 16L24 24M24 16L16 24" stroke="currentColor" stroke-width="2"/></svg>',
                category: 'martial',
                activityMultiplier: 1.8,
                nutritionFormula: {
                    proteinPerKg: 1.8,
                    carbsPerKg: 5,
                    fatPerKg: 0.9,
                    calorieSurplus: 0.1
                },
                testConfig: SPORT_SPECIFIC_TESTS.boxing
            },
            gym: {
                id: 'gym',
                name: 'Тренажерный зал',
                description: 'Сила, здоровье, эстетика',
                icon: '<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="8" y="8" width="24" height="24" rx="4" stroke="currentColor" stroke-width="2"/><path d="M16 12V28M24 12V28M12 16H28M12 24H28" stroke="currentColor" stroke-width="2"/></svg>',
                category: 'strength',
                goals: {
                    muscle: {
                        name: 'Набор мышечной массы',
                        activityMultiplier: 1.55,
                        nutritionFormula: {
                            proteinPerKg: 2.2,
                            carbsPerKg: 4,
                            fatPerKg: 1,
                            calorieSurplus: 0.20
                        }
                    },
                    shape: {
                        name: 'Форма и рельеф',
                        activityMultiplier: 1.55,
                        nutritionFormula: {
                            proteinPerKg: 2.2,
                            carbsPerKg: 2.5,
                            fatPerKg: 0.8,
                            calorieSurplus: 0
                        }
                    }
                },
                testConfig: SPORT_SPECIFIC_TESTS.gym
            }
        };

        class SportAIPro {
            constructor() {
                console.log('SportAIPro constructor called');
                this.state = {
                    userData: {},
                    testResults: { reaction: [], bodyweight: {} },
                    sportStats: {},
                    preferences: [],
                    favorites: [],
                    hasCompletedOnboarding: false,
                    theme: 'dark',
                    currentSportDetails: null,
                    currentGymGoal: 'muscle',
                    lastWorkoutDate: null,
                    todayWorkoutCompleted: false,
                    workoutHistory: {},
                    calendarCurrentMonth: new Date().getMonth(),
                    calendarCurrentYear: new Date().getFullYear(),
                    workoutFrequency: 1,
                    completedSportTests: {}
                };
                
                this.currentOnboardingStep = 1;
                this.reactionTest = null;
                this.reactionTimeouts = [];
                this.isTelegram = isTelegramApp;
                this.currentSportTest = null;
                this.loadCalculator = null;
                
                this.init();
            }
            
            async init() {
                console.log('SportAIPro init called');
                if (this.isTelegram) {
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                }
                
                await this.loadState();
                this.checkOnboarding();
                this.setupEventListeners();
                this.initTimeBasedContent();
                this.checkWorkoutStatus();
                this.initMiniCalendar();
                console.log('SportAIPro init completed');
            }
            
            async saveState() {
                const stateString = JSON.stringify(this.state);
                
                if (this.isTelegram) {
                    try {
                        await window.Telegram.WebApp.CloudStorage.setItem('sportAIState', stateString);
                    } catch (error) {
                        localStorage.setItem('sportAIState', stateString);
                    }
                } else {
                    localStorage.setItem('sportAIState', stateString);
                    localStorage.setItem('user_tested', 'true');
                }
            }
            
            async loadState() {
                try {
                    let savedData = null;
                    
                    if (this.isTelegram) {
                        const cloudData = await window.Telegram.WebApp.CloudStorage.getItem('sportAIState');
                        if (cloudData) {
                            savedData = JSON.parse(cloudData);
                        }
                    }
                    
                    if (!savedData) {
                        const localData = localStorage.getItem('sportAIState');
                        if (localData) {
                            savedData = JSON.parse(localData);
                        }
                    }
                    
                    if (savedData) {
                        this.state = { 
                            ...this.state, 
                            ...savedData,
                            workoutHistory: savedData.workoutHistory || {},
                            calendarCurrentMonth: savedData.calendarCurrentMonth !== undefined ? 
                                savedData.calendarCurrentMonth : new Date().getMonth(),
                            calendarCurrentYear: savedData.calendarCurrentYear !== undefined ? 
                                savedData.calendarCurrentYear : new Date().getFullYear(),
                            workoutFrequency: savedData.workoutFrequency || 1,
                            sportStats: savedData.sportStats || {},
                            completedSportTests: savedData.completedSportTests || {}
                        };
                    }
                } catch (e) {
                    console.error('Ошибка загрузки данных:', e);
                }
            }
            
            // ============ НОВАЯ ФУНКЦИЯ: ГЕНЕРАЦИЯ ТРЕНИРОВКИ С РАСЧЕТОМ НАГРУЗКИ ============
            calculateWorkoutProgram(sportId, goal = null) {
                const userData = this.state.userData;
                const testResults = this.state.testResults;
                
                // Создаем калькулятор нагрузки
                this.loadCalculator = new LoadCalculator(
                    userData, 
                    testResults, 
                    sportId, 
                    goal || (sportId === 'gym' ? this.state.currentGymGoal : null)
                );
                
                let exercisePool;
                let workoutCount = 5;
                
                // Выбираем пул упражнений в зависимости от спорта
                if (sportId === 'gym') {
                    const isStrengthGoal = goal === 'muscle';
                    exercisePool = isStrengthGoal ? EXERCISE_DATABASE.strength : EXERCISE_DATABASE.endurance;
                    workoutCount = 6;
                } else if (sportId === 'boxing') {
                    exercisePool = [
                        { name: 'Бой с тенью', type: 'cardio', primary: 'все тело' },
                        { name: 'Скакалка', type: 'cardio', primary: 'ноги' },
                        { name: 'Работа на мешке', type: 'compound', primary: 'руки, корпус' },
                        { name: 'Спарринг', type: 'compound', primary: 'все тело' },
                        { name: 'Бурпи', type: 'plyometric', primary: 'все тело' }
                    ];
                } else {
                    exercisePool = EXERCISE_DATABASE.team_sports;
                    workoutCount = 6;
                }
                
                // Генерируем тренировку через калькулятор
                const workouts = this.loadCalculator.generateWorkout(exercisePool, workoutCount);
                
                // Добавляем адаптивные заметки
                workouts.forEach(workout => {
                    if (!workout.adaptiveNote) {
                        // Заметка о соматотипе
                        const somatype = this.loadCalculator.athleteModifiers.somatotype;
                        if (somatype.name === 'Эктоморф') {
                            workout.adaptiveNote = `Эктоморф: объем уменьшен, вес увеличен`;
                        } else if (somatype.name === 'Эндоморф') {
                            workout.adaptiveNote = `Эндоморф: объем увеличен, отдых сокращен`;
                        }
                        
                        // Заметка о силе
                        const strength = this.loadCalculator.athleteModifiers.strengthLevel;
                        if (strength < 0.8) {
                            workout.adaptiveNote = (workout.adaptiveNote ? workout.adaptiveNote + ' | ' : '') + `Новичок: начинайте с легких весов`;
                        } else if (strength > 1.2) {
                            workout.adaptiveNote = (workout.adaptiveNote ? workout.adaptiveNote + ' | ' : '') + `Атлет: используйте максимальные веса`;
                        }
                        
                        // Заметка об ИМТ
                        if (this.loadCalculator.athleteModifiers.bmiMod < 1.0) {
                            workout.adaptiveNote = (workout.adaptiveNote ? workout.adaptiveNote + ' | ' : '') + `ИМТ >28: нагрузка адаптирована`;
                        }
                    }
                });
                
                return workouts;
            }
            
            // ============ НОВАЯ ФУНКЦИЯ: ПОКАЗ ТЕСТОВ СПОРТА ============
            showSportTest(sportId) {
                console.log('showSportTest called for:', sportId);
                const sport = SPORTS_DATABASE[sportId];
                if (!sport || !sport.testConfig || sport.testConfig.tests.length === 0) {
                    // Если тестов нет, сразу показываем детали
                    this.showSportDetails(sportId);
                    return;
                }
                
                // Проверяем, проходил ли пользователь уже тест для этого спорта
                if (this.state.completedSportTests[sportId]) {
                    this.showSportDetails(sportId);
                    return;
                }
                
                this.currentSportTest = sportId;
                
                document.getElementById('sportTestTitle').textContent = `Тест: ${sport.name}`;
                document.getElementById('sportTestSportName').textContent = sport.name;
                document.getElementById('sportTestDescription').textContent = 
                    `Пройдите ${sport.testConfig.tests.length} базовых теста для получения точных рекомендаций по позиции и программе тренировок.`;
                
                const metricsContainer = document.getElementById('sportTestMetrics');
                metricsContainer.innerHTML = '';
                
                sport.testConfig.tests.forEach(test => {
                    const metricHtml = `
                        <div>
                            <input type="number" 
                                   class="metric-input" 
                                   id="test_${test.id}"
                                   placeholder="${test.min}"
                                   min="${test.min}"
                                   max="${test.max}"
                                   step="${test.unit === 'см' || test.unit === 'кг' ? '1' : '0.1'}">
                            <div class="metric-label">${test.name} (${test.unit})</div>
                        </div>
                    `;
                    metricsContainer.innerHTML += metricHtml;
                });
                
                document.getElementById('sportTestModal').classList.add('active');
            }
            
            closeSportTest() {
                document.getElementById('sportTestModal').classList.remove('active');
                this.currentSportTest = null;
            }
            
            async saveSportTestResults() {
                const sportId = this.currentSportTest;
                const sport = SPORTS_DATABASE[sportId];
                
                if (!sport || !sport.testConfig) {
                    this.closeSportTest();
                    return;
                }
                
                // Собираем результаты тестов
                const testResults = {};
                let allFilled = true;
                
                sport.testConfig.tests.forEach(test => {
                    const input = document.getElementById(`test_${test.id}`);
                    const value = parseFloat(input.value);
                    
                    if (isNaN(value) || value < test.min || value > test.max) {
                        allFilled = false;
                        input.style.borderColor = 'var(--danger-color)';
                    } else {
                        testResults[test.id] = value;
                        input.style.borderColor = '';
                    }
                });
                
                if (!allFilled) {
                    alert('Пожалуйста, заполните все поля корректными значениями.');
                    return;
                }
                
                // Сохраняем результаты
                if (!this.state.sportStats[sportId]) {
                    this.state.sportStats[sportId] = {};
                }
                
                this.state.sportStats[sportId].testResults = testResults;
                this.state.sportStats[sportId].lastTestDate = new Date().toISOString();
                this.state.completedSportTests[sportId] = true;
                
                // Определяем позицию
                const position = this.determineSportPosition(sportId, testResults);
                if (position) {
                    this.state.sportStats[sportId].recommendedPosition = position;
                }
                
                await this.saveState();
                this.closeSportTest();
                this.showSportDetails(sportId);
            }
            
            // ============ НОВАЯ ФУНКЦИЯ: ОПРЕДЕЛЕНИЕ ПОЗИЦИИ ============
            determineSportPosition(sportId, testResults) {
                const sport = SPORTS_DATABASE[sportId];
                if (!sport || !sport.testConfig || !sport.testConfig.positions) {
                    return null;
                }
                
                const userData = this.state.userData;
                const height = userData.height || 175;
                const reaction = this.state.testResults.reaction && this.state.testResults.reaction.length > 0 ? 
                    Math.min(...this.state.testResults.reaction) : 300;
                
                let bestMatch = null;
                let bestScore = -1;
                
                sport.testConfig.positions.forEach(position => {
                    let score = 0;
                    const req = position.requirements;
                    
                    // Проверяем требования
                    if (req.height && height >= req.height) score += 30;
                    if (req.reaction && reaction <= req.reaction) score += 25;
                    
                    // Проверяем тестовые результаты
                    Object.keys(req).forEach(key => {
                        if (testResults[key] !== undefined) {
                            if (typeof req[key] === 'number') {
                                // Для числовых значений
                                if (key === 'sprint30' || key === 'sprint20' || key === 'shuttle' || key === 'dribble') {
                                    // Меньше = лучше
                                    if (testResults[key] <= req[key]) score += 20;
                                } else {
                                    // Больше = лучше
                                    if (testResults[key] >= req[key]) score += 20;
                                }
                            } else if (req[key] === 'high') {
                                // Качественные оценки
                                score += 15;
                            } else if (req[key] === 'very high') {
                                score += 20;
                            }
                        }
                    });
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = position;
                    }
                });
                
                return bestMatch;
            }
            
            // ============ НОВАЯ ФУНКЦИЯ: РАСЧЕТ ВОДЫ ============
            calculateWaterIntake() {
                const weight = this.state.userData.weight || 70;
                const workoutFrequency = this.state.workoutFrequency;
                const sportTime = workoutFrequency === 2 ? 120 : 60; // минут в день
                
                // Формула: (Вес * 0.033) + (Время_спорта_в_мин * 0.01)
                const waterLiters = (weight * 0.033) + (sportTime * 0.01);
                return Math.round(waterLiters * 10) / 10; // Округляем до 0.1
            }
            
            // ============ ОБНОВЛЕННАЯ ФУНКЦИЯ: ПОКАЗ ДЕТАЛЕЙ СПОРТА ============
            showSportDetails(sportId) {
                console.log('showSportDetails called for:', sportId);
                
                // Проверяем, нужны ли тесты для этого вида спорта
                const sportData = SPORTS_DATABASE[sportId];
                if (sportData && sportData.testConfig && sportData.testConfig.tests.length > 0 && 
                    !this.state.completedSportTests[sportId]) {
                    this.showSportTest(sportId);
                    return;
                }
                
                this.state.currentSportDetails = sportId;
                const sport = SPORTS_DATABASE[sportId];
                
                if (!sport) return;
                
                document.getElementById('sportDetailsTitle').textContent = sport.name;
                
                // Позиция для видов спорта с тестами
                const positionSection = document.getElementById('positionSection');
                const sportStats = this.state.sportStats[sportId];
                
                if (sportStats && sportStats.recommendedPosition) {
                    positionSection.classList.remove('d-none');
                    document.getElementById('positionBadge').textContent = sportStats.recommendedPosition.name;
                    document.getElementById('positionDescription').textContent = sportStats.recommendedPosition.description;
                } else {
                    positionSection.classList.add('d-none');
                }
                
                // Переключатель целей для зала
                const goalSelector = document.getElementById('gymGoalSelector');
                if (sportId === 'gym') {
                    goalSelector.classList.remove('d-none');
                    document.querySelectorAll('.goal-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.goal === this.state.currentGymGoal);
                    });
                    this.updateGymDetails(sport, this.state.currentGymGoal);
                } else {
                    goalSelector.classList.add('d-none');
                    this.updateRegularSportDetails(sport);
                }
                
                document.getElementById('sportDetailsModal').classList.add('active');
            }
            
            // ============ ОБНОВЛЕННАЯ ФУНКЦИЯ: ОБНОВЛЕНИЕ ДЕТАЛЕЙ СПОРТА ============
            updateRegularSportDetails(sport) {
                // Тренировки
                const workouts = this.calculateWorkoutProgram(sport.id);
                const workoutList = document.getElementById('workoutList');
                
                if (workouts.length === 0) {
                    workoutList.innerHTML = '<li class="workout-item"><div class="workout-name">Тренировка адаптирована под ваш ИМТ</div><div class="workout-tip">При высоком ИМТ исключены прыжковые упражнения для безопасности суставов</div></li>';
                } else {
                    workoutList.innerHTML = workouts.map(workout => `
                        <li class="workout-item">
                            <div class="workout-header">
                                <div class="workout-name">${workout.name}</div>
                                <div class="text-muted" style="font-size: var(--font-xs);">
                                    ${workout.type === 'plyometric' ? '⚡ Взрывное' : 
                                      workout.type === 'compound' ? '🏋️ База' : 
                                      workout.type === 'isolation' ? '🔬 Изоляция' :
                                      workout.type === 'static' ? '⏱️ Статика' : '🏃 Кардио'}
                                </div>
                            </div>
                            <div class="workout-details">
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                        <path d="M8 12H16M12 8V16" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    Подходы: ${workout.sets}
                                </span>
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    Повторения: ${workout.reps}
                                </span>
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 20V10M8 20V14M16 20V14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    Отдых: ${workout.rest}
                                </span>
                            </div>
                            ${workout.weight ? `<div class="dumbbell-weight">🏋️ Вес: ${workout.weight} ${workout.weightNote ? '(' + workout.weightNote + ')' : ''}</div>` : ''}
                            ${workout.tip ? `<div class="workout-tip">💡 ${workout.tip}</div>` : ''}
                            ${workout.adaptiveNote ? `<div class="adaptive-note">⚡ ${workout.adaptiveNote}</div>` : ''}
                        </li>
                    `).join('');
                }
                
                // Питание
                const nutritionProgram = this.calculateNutritionProgram(sport.id);
                if (nutritionProgram) {
                    const waterIntake = this.calculateWaterIntake();
                    
                    const nutritionGrid = document.getElementById('nutritionGrid');
                    nutritionGrid.innerHTML = `
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionProgram.nutritionData.calories} ккал</div>
                            <div class="nutrition-label">Калории</div>
                            <div class="nutrition-dynamic-note">Рассчитано под ваш вес</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionProgram.nutritionData.protein} г</div>
                            <div class="nutrition-label">Белок</div>
                            <div class="nutrition-dynamic-note">${sport.nutritionFormula.proteinPerKg} г/кг</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionProgram.nutritionData.carbs} г</div>
                            <div class="nutrition-label">Углеводы</div>
                            <div class="nutrition-dynamic-note">${sport.nutritionFormula.carbsPerKg} г/кг</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${waterIntake} л</div>
                            <div class="nutrition-label">Вода</div>
                            <div class="nutrition-dynamic-note">Формула: (вес × 0.033) + (спорт × 0.01)</div>
                        </div>
                    `;
                    
                    // Меню на день
                    const dailyMenu = document.getElementById('dailyMenu');
                    let menuHtml = '<div style="margin-top: var(--spacing-sm);">';
                    
                    Object.entries(nutritionProgram.dailyMenu).forEach(([meal, foods]) => {
                        const mealNames = {
                            breakfast: 'Завтрак',
                            lunch: 'Обед',
                            dinner: 'Ужин',
                            snacks: 'Перекусы'
                        };
                        
                        menuHtml += `<div style="margin-bottom: var(--spacing-sm);"><strong>${mealNames[meal]}:</strong><br>`;
                        foods.forEach(food => {
                            menuHtml += `<div class="menu-item">
                                <span class="menu-food">${food.name}</span>
                                <span class="menu-weight">${food.weight} г</span>
                            </div>`;
                        });
                        menuHtml += '</div>';
                    });
                    
                    menuHtml += `<div class="text-muted" style="margin-top: var(--spacing-sm);">
                        💧 Вода: ${waterIntake} л в день<br>
                        ⏱️ ${this.state.workoutFrequency} тренировка(и) в день
                    </div></div>`;
                    dailyMenu.innerHTML = menuHtml;
                }
                
                // Добавки
                const supplements = this.calculateSupplements(this.state.userData, null, sport.id);
                this.updateSupplementsByCategory(supplements);
            }
            
            // ============ ОБНОВЛЕННАЯ ФУНКЦИЯ: КАЛЕНДАРЬ ДЛЯ 2 ТРЕНИРОВОК ============
            showDayInfo(day, month, year) {
                const date = new Date(year, month, day);
                const dateString = date.toDateString();
                const dayOfWeek = date.getDay();
                const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
                const monthNames = [
                    'Января', 'Февраля', 'Марта', 'Апреля', 'Мая', 'Июня',
                    'Июля', 'Августа', 'Сентября', 'Октября', 'Ноября', 'Декабря'
                ];
                
                const dayName = dayNames[dayOfWeek];
                const monthName = monthNames[month];
                const isWorkoutDay = TRAINING_SCHEDULE.workoutDays.includes(dayOfWeek);
                const hasWorkout = this.state.workoutHistory[dateString];
                const workoutFrequency = this.state.workoutFrequency || 1;
                
                let dayInfoHTML = '';
                
                if (isWorkoutDay) {
                    dayInfoHTML = `
                        <div class="calendar-modal-day workout">
                            <h3 class="calendar-modal-title">${day} ${monthName} - ${dayName}</h3>
                            <p class="calendar-modal-subtitle">🏋️ Тренировочный день (${workoutFrequency} тренировка${workoutFrequency > 1 ? 'и' : ''})</p>
                            
                            ${hasWorkout ? 
                                `<div style="background: rgba(16, 185, 129, 0.2); padding: var(--spacing-sm); border-radius: var(--radius); margin-bottom: var(--spacing-sm);">
                                    <strong>✓ Тренировка выполнена</strong>
                                </div>` : 
                                `<div style="background: rgba(245, 158, 11, 0.2); padding: var(--spacing-sm); border-radius: var(--radius); margin-bottom: var(--spacing-sm);">
                                    <strong>📝 Запланирована тренировка</strong>
                                </div>`
                            }
                            
                            <div class="workout-schedule">
                                <h4 style="margin-bottom: var(--spacing-sm);">Расписание тренировок:</h4>
                                ${workoutFrequency === 2 ? `
                                <div class="schedule-item">
                                    <div class="schedule-time">07:00-08:00</div>
                                    <div class="schedule-activity">Утренняя кардио-сессия</div>
                                </div>
                                ` : ''}
                                <div class="schedule-item">
                                    <div class="schedule-time">${TRAINING_SCHEDULE.workoutTime}</div>
                                    <div class="schedule-activity">Основная силовая тренировка</div>
                                </div>
                                <div class="schedule-item">
                                    <div class="schedule-time">20:00-20:15</div>
                                    <div class="schedule-activity">Растяжка и заминка</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: var(--spacing-md);">
                                <h4 style="margin-bottom: var(--spacing-sm);">Рекомендации:</h4>
                                <ul style="list-style: none; padding-left: 0;">
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• Прием пищи за 2-3 часа до тренировки</li>
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• ${this.calculateWaterIntake()} л воды в течение дня</li>
                                    <li style="padding: var(--spacing-xs) 0;">• Протеиновый коктейль в течение 30 минут после</li>
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    const proteinTarget = this.state.userData.weight ? 
                        Math.round(this.state.userData.weight * 2.2) : 'X';
                    const waterIntake = this.calculateWaterIntake();
                    
                    dayInfoHTML = `
                        <div class="calendar-modal-day rest">
                            <h3 class="calendar-modal-title">${day} ${monthName} - ${dayName}</h3>
                            <p class="calendar-modal-subtitle">🧘 День отдыха и восстановления</p>
                            
                            <div style="background: rgba(139, 92, 246, 0.2); padding: var(--spacing-sm); border-radius: var(--radius); margin-bottom: var(--spacing-sm);">
                                <strong>Важно дать мышцам восстановиться!</strong>
                            </div>
                            
                            <div style="margin-top: var(--spacing-md);">
                                <h4 style="margin-bottom: var(--spacing-sm);">Цели на день:</h4>
                                <ul style="list-style: none; padding-left: 0;">
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• <strong>Белок:</strong> ${proteinTarget} грамм</li>
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• <strong>Сон:</strong> не менее 8 часов</li>
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• <strong>Вода:</strong> ${waterIntake} литра</li>
                                    <li style="padding: var(--spacing-xs) 0;">• <strong>Активность:</strong> легкая прогулка 30-40 минут</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                const today = new Date();
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                if (isToday && isWorkoutDay && !hasWorkout) {
                    dayInfoHTML += `
                        <button class="btn btn-primary btn-block mt-4" onclick="SportAI.markWorkoutToday(); SportAI.closeCalendarModal();">
                            Отметить тренировку сегодня
                        </button>
                    `;
                }
                
                document.getElementById('calendarDayInfo').innerHTML = dayInfoHTML;
                document.getElementById('calendarModal').classList.add('active');
            }
            
            // ============ ОСТАЛЬНЫЕ ФУНКЦИИ ============
            checkOnboarding() {
                console.log('checkOnboarding called, hasCompletedOnboarding:', this.state.hasCompletedOnboarding);
                if (this.state.hasCompletedOnboarding) {
                    document.getElementById('onboarding').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('d-none');
                    this.updateHomeContent();
                    this.updateProfile();
                    this.updateSportsGrid();
                } else {
                    document.getElementById('onboarding').classList.remove('hidden');
                    document.getElementById('mainApp').classList.add('d-none');
                    this.showOnboardingStep(1);
                }
            }
            
            setupEventListeners() {
                console.log('setupEventListeners called');
                
                document.querySelectorAll('.test-option-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        btn.classList.toggle('selected');
                        const value = btn.dataset.value;
                        const index = this.state.preferences.indexOf(value);
                        
                        if (index > -1) {
                            this.state.preferences.splice(index, 1);
                        } else {
                            this.state.preferences.push(value);
                        }
                    });
                });

                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('goal-btn')) {
                        const goal = e.target.dataset.goal;
                        this.state.currentGymGoal = goal;
                        
                        document.querySelectorAll('.goal-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        
                        if (this.state.currentSportDetails === 'gym') {
                            this.showSportDetails('gym');
                        }
                    }
                    
                    if (e.target.classList.contains('frequency-btn')) {
                        const frequency = parseInt(e.target.dataset.frequency);
                        this.state.workoutFrequency = frequency;
                        
                        document.querySelectorAll('.frequency-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        e.target.classList.add('active');
                    }
                });
            }
            
            onboardingNext() {
                console.log('onboardingNext called, current step:', this.currentOnboardingStep);
                
                if (this.currentOnboardingStep === 2 && !this.validateBasicData()) {
                    console.log('Validation failed for step 2');
                    return;
                }
                
                this.currentOnboardingStep++;
                console.log('Moving to step:', this.currentOnboardingStep);
                
                if (this.currentOnboardingStep <= 4) {
                    this.showOnboardingStep(this.currentOnboardingStep);
                } else {
                    console.log('All onboarding steps completed');
                }
            }
            
            onboardingPrev() {
                console.log('onboardingPrev called, current step:', this.currentOnboardingStep);
                this.currentOnboardingStep = Math.max(1, this.currentOnboardingStep - 1);
                this.showOnboardingStep(this.currentOnboardingStep);
            }
            
            showOnboardingStep(step) {
                console.log('showOnboardingStep called with step:', step);
                
                document.querySelectorAll('.onboarding-step').forEach(stepEl => {
                    stepEl.classList.remove('active');
                });
                
                document.querySelectorAll('.progress-step').forEach((stepEl, index) => {
                    stepEl.classList.toggle('active', index < step);
                });
                
                const stepElement = document.getElementById(`onboardingStep${step}`);
                if (stepElement) {
                    stepElement.classList.add('active');
                    console.log('Activated step:', step);
                } else {
                    console.error('Step element not found for step:', step);
                }
            }
            
            validateBasicData() {
                const age = document.getElementById('age').value;
                const gender = document.getElementById('gender').value;
                const height = document.getElementById('height').value;
                const weight = document.getElementById('weight').value;
                const wrist = document.getElementById('wrist').value;
                const ankle = document.getElementById('ankle').value;
                
                console.log('validateBasicData values:', { age, gender, height, weight, wrist, ankle });
                
                if (!age || !gender || !height || !weight || !wrist || !ankle) {
                    alert('Пожалуйста, заполните все поля');
                    return false;
                }
                
                this.state.userData = {
                    age: parseInt(age),
                    gender: gender,
                    height: parseInt(height),
                    weight: parseInt(weight),
                    wrist: parseFloat(wrist),
                    ankle: parseFloat(ankle)
                };
                
                console.log('User data saved:', this.state.userData);
                return true;
            }
            
            startReactionTest() {
                console.log('startReactionTest called');
                this.clearAllTimeouts();
                
                this.state.testResults.reaction = [];
                document.getElementById('reactionAvg').textContent = '-';
                document.getElementById('reactionBest').textContent = '-';
                document.getElementById('reactionMessage').textContent = 'Приготовьтесь...';
                document.getElementById('startReaction').classList.add('d-none');
                document.getElementById('continueBtn').classList.add('d-none');
                
                const area = document.getElementById('reactionArea');
                area.innerHTML = '';
                area.style.cursor = 'pointer';
                
                this.reactionTest = {
                    startTime: null,
                    targetsShown: 0,
                    totalTargets: 5,
                    times: [],
                    completed: false
                };
                
                setTimeout(() => {
                    this.showNextReactionTarget();
                }, 1000);
            }
            
            showNextReactionTarget() {
                if (this.reactionTest.completed || this.reactionTest.targetsShown >= this.reactionTest.totalTargets) {
                    this.endReactionTest();
                    return;
                }
                
                const area = document.getElementById('reactionArea');
                area.innerHTML = '';
                
                const target = document.createElement('div');
                target.className = 'reaction-target';
                
                const margin = 30;
                const x = margin + Math.random() * (area.offsetWidth - margin * 2);
                const y = margin + Math.random() * (area.offsetHeight - margin * 2);
                
                target.style.left = `${x}px`;
                target.style.top = `${y}px`;
                
                target.addEventListener('mousedown', () => this.handleReactionHit(target));
                target.addEventListener('touchstart', (e) => {
                    this.handleReactionHit(target);
                    e.preventDefault();
                });
                
                area.appendChild(target);
                this.reactionTest.startTime = Date.now();
                this.reactionTest.targetsShown++;
                
                const timeout = setTimeout(() => {
                    if (target.parentElement && !this.reactionTest.completed) {
                        target.style.display = 'none';
                        const nextTimeout = setTimeout(() => {
                            this.showNextReactionTarget();
                        }, 300);
                        this.reactionTimeouts.push(nextTimeout);
                    }
                }, 1500);
                
                this.reactionTimeouts.push(timeout);
            }
            
            handleReactionHit(target) {
                if (this.reactionTest.completed) return;
                
                const reactionTime = Date.now() - this.reactionTest.startTime;
                this.reactionTest.times.push(reactionTime);
                
                const avg = this.reactionTest.times.length > 0 ? 
                    Math.round(this.reactionTest.times.reduce((a, b) => a + b) / this.reactionTest.times.length) : 0;
                const best = this.reactionTest.times.length > 0 ? Math.min(...this.reactionTest.times) : 0;
                
                document.getElementById('reactionAvg').textContent = `${avg}мс`;
                document.getElementById('reactionBest').textContent = `${best}мс`;
                
                this.clearAllTimeouts();
                
                target.style.display = 'none';
                
                const timeout = setTimeout(() => {
                    this.showNextReactionTarget();
                }, 300);
                this.reactionTimeouts.push(timeout);
            }
            
            endReactionTest() {
                this.reactionTest.completed = true;
                this.clearAllTimeouts();
                
                document.getElementById('reactionArea').innerHTML = 
                    '<div class="text-center" style="margin-top: 80px; color: var(--text-tertiary); font-size: var(--font-sm);">Тест завершен!</div>';
                
                this.state.testResults.reaction = this.reactionTest.times;
                this.saveState();
                
                document.getElementById('continueBtn').classList.remove('d-none');
            }
            
            clearAllTimeouts() {
                this.reactionTimeouts.forEach(timeout => clearTimeout(timeout));
                this.reactionTimeouts = [];
            }
            
            calculateFitnessLevel() {
                const bodyweight = this.state.testResults.bodyweight;
                if (!bodyweight) return;
                
                let score = 0;
                if (bodyweight.pushups >= 30) score += 30;
                else if (bodyweight.pushups >= 20) score += 25;
                else if (bodyweight.pushups >= 15) score += 20;
                else if (bodyweight.pushups >= 10) score += 15;
                else if (bodyweight.pushups >= 5) score += 10;
                else if (bodyweight.pushups >= 1) score += 5;
                
                if (bodyweight.plank >= 180) score += 30;
                else if (bodyweight.plank >= 120) score += 25;
                else if (bodyweight.plank >= 90) score += 20;
                else if (bodyweight.plank >= 60) score += 15;
                else if (bodyweight.plank >= 30) score += 10;
                else if (bodyweight.plank >= 10) score += 5;
                
                if (bodyweight.pullups >= 10) score += 20;
                else if (bodyweight.pullups >= 5) score += 15;
                else if (bodyweight.pullups >= 3) score += 10;
                else if (bodyweight.pullups >= 1) score += 5;
                
                if (bodyweight.squats >= 50) score += 20;
                else if (bodyweight.squats >= 40) score += 15;
                else if (bodyweight.squats >= 30) score += 10;
                else if (bodyweight.squats >= 20) score += 5;
                
                let level, description;
                if (score >= 90) {
                    level = "Продвинутый";
                    description = "Отличная физическая форма!";
                } else if (score >= 70) {
                    level = "Выше среднего";
                    description = "Хорошая база для развития.";
                } else if (score >= 50) {
                    level = "Средний";
                    description = "Нормальный уровень для начала.";
                } else if (score >= 30) {
                    level = "Начинающий";
                    description = "Начнем с основ, главное - регулярность!";
                } else {
                    level = "Новичок";
                    description = "Идеальное время для начала тренировок!";
                }
                
                document.getElementById('fitnessLevel').textContent = level;
                document.getElementById('fitnessDescription').textContent = description;
            }
            
            async completeOnboarding() {
                console.log('completeOnboarding called');
                
                this.state.testResults.bodyweight = {
                    pushups: parseInt(document.getElementById('pushups').value) || 0,
                    plank: parseInt(document.getElementById('plank').value) || 0,
                    pullups: parseInt(document.getElementById('pullups').value) || 0,
                    squats: parseInt(document.getElementById('squats').value) || 0
                };
                
                // Сохраняем частоту тренировок
                const frequencyBtn = document.querySelector('.frequency-btn.active');
                if (frequencyBtn) {
                    this.state.workoutFrequency = parseInt(frequencyBtn.dataset.frequency) || 1;
                }
                
                this.calculateFitnessLevel();
                this.state.hasCompletedOnboarding = true;
                
                await this.saveState();
                
                document.getElementById('onboarding').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('d-none');
                
                this.updateHomeContent();
                this.updateProfile();
                this.updateSportsGrid();
                this.initMiniCalendar();
                
                console.log('Onboarding completed successfully');
            }
            
            initTimeBasedContent() {
                this.updateTimeBasedContent();
                setInterval(() => this.updateTimeBasedContent(), 60000);
            }
            
            updateTimeBasedContent() {
                const hours = new Date().getHours();
                let period, greeting;
                
                if (hours >= 6 && hours < 11) {
                    period = 'morning';
                    greeting = 'Доброе утро!';
                } else if (hours >= 11 && hours < 18) {
                    period = 'day';
                    greeting = 'Добрый день!';
                } else {
                    period = 'evening';
                    greeting = 'Добрый вечер!';
                }
                
                document.getElementById('greetingText').textContent = greeting;
                document.getElementById('timePeriod').textContent = 
                    period === 'morning' ? 'Утренние рекомендации' :
                    period === 'day' ? 'Дневные рекомендации' : 'Вечерние рекомендации';
                
                this.updateTodayRecommendations(period);
            }
            
            updateTodayRecommendations(period) {
                const container = document.getElementById('todayRecommendations');
                let recommendations = [];
                
                // Базовые рекомендации по времени суток
                if (period === 'morning') {
                    recommendations = [
                        'Выпейте 500 мл воды комнатной температуры',
                        'Подготовьте спортивную форму и экипировку',
                        'Легкий завтрак за 30-60 минут до активности',
                        'Разминка 10-15 минут перед тренировкой'
                    ];
                } else if (period === 'day') {
                    recommendations = [
                        'Время обеда по плану питания',
                        'Не забудьте про углеводы для энергии',
                        'Пейте воду регулярно, не дожидаясь жажды',
                        'Если тренировка вечером - легкий перекус за 2 часа'
                    ];
                } else {
                    if (this.state.todayWorkoutCompleted) {
                        recommendations = [
                            'Восстановление: теплый душ и растяжка',
                            'Выпейте протеиновый коктейль или съешьте творог',
                            'Отложите телефон за час до сна',
                            'Примите магний для улучшения качества сна'
                        ];
                    } else {
                        recommendations = [
                            'Если тренировка завершена - выпейте протеин',
                            'Сделайте легкую растяжку для расслабления',
                            'Подготовьтесь к завтрашнему дню',
                            'Отложите телефон за час до сна'
                        ];
                    }
                }
                
                // Добавляем рекомендации по количеству тренировок
                if (this.state.workoutFrequency === 2) {
                    if (period === 'morning') {
                        recommendations.push('Запланируйте вторую тренировку на вечер');
                    } else if (period === 'day') {
                        recommendations.push('Восстановитесь после утренней тренировки');
                    }
                }
                
                // Добавляем рекомендацию по воде
                const waterIntake = this.calculateWaterIntake();
                recommendations.push(`Выпейте ${waterIntake} л воды в течение дня`);
                
                let html = `
                    <div class="recommendation-card">
                        <div class="recommendation-header">
                            <svg class="recommendation-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 4.93L7.76 7.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M2 12H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 19.07L7.76 16.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 18V22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 16.24L19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M18 12H22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 7.76L19.07 4.93" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <div class="recommendation-title">Рекомендации на ${period === 'morning' ? 'утро' : period === 'day' ? 'день' : 'вечер'}</div>
                        </div>
                        <ul class="recommendation-list">
                `;
                
                recommendations.forEach(rec => {
                    html += `
                        <li class="recommendation-item">
                            <svg class="check-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            ${rec}
                        </li>
                    `;
                });
                
                html += `</ul></div>`;
                container.innerHTML = html;
            }
            
            checkWorkoutStatus() {
                const today = new Date().toDateString();
                if (this.state.lastWorkoutDate === today) {
                    this.state.todayWorkoutCompleted = true;
                } else {
                    this.state.todayWorkoutCompleted = false;
                }
            }
            
            markWorkoutToday() {
                const today = new Date();
                const todayString = today.toDateString();
                
                this.state.lastWorkoutDate = todayString;
                this.state.todayWorkoutCompleted = true;
                
                if (!this.state.workoutHistory[todayString]) {
                    this.state.workoutHistory[todayString] = {
                        date: todayString,
                        sport: this.state.currentSportDetails,
                        completed: true
                    };
                }
                
                this.saveState();
                this.updateTimeBasedContent();
                this.initMiniCalendar();
                
                alert('Тренировка отмечена! Рекомендации обновлены.');
                this.closeSportDetails();
            }
            
            showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById(sectionId).classList.add('active');
                document.querySelector(`[onclick="SportAI.showSection('${sectionId}')"]`).classList.add('active');
            }
            
            updateHomeContent() {
                const favoriteSport = this.getFavoriteSport();
                const favoriteSection = document.getElementById('favoriteSportSection');
                
                if (favoriteSport) {
                    const sportStats = this.state.sportStats[favoriteSport.id];
                    const position = sportStats && sportStats.recommendedPosition ? 
                        `<div class="position-badge">${sportStats.recommendedPosition.name}</div>` : '';
                    
                    favoriteSection.innerHTML = `
                        <h3 class="h3">Твой основной спорт</h3>
                        <div class="sport-card-large mt-2" onclick="SportAI.showSportDetails('${favoriteSport.id}')">
                            <div class="sport-icon-large">
                                ${favoriteSport.icon}
                            </div>
                            <div class="sport-info">
                                <div class="sport-name">${favoriteSport.name}</div>
                                <div class="sport-desc">${favoriteSport.description}</div>
                                ${position}
                            </div>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    `;
                } else {
                    favoriteSection.innerHTML = `
                        <h3 class="h3">Выберите основной спорт</h3>
                        <p class="subtitle">Отметьте спорт звездочкой, чтобы закрепить его здесь</p>
                        <button class="btn btn-primary mt-2" onclick="SportAI.showSection('sports')">
                            Выбрать спорт
                        </button>
                    `;
                }
            }
            
            updateSportsGrid() {
                const container = document.getElementById('sportsGrid');
                container.innerHTML = '';
                
                Object.values(SPORTS_DATABASE).forEach(sport => {
                    const isFavorite = this.state.favorites.includes(sport.id);
                    const sportStats = this.state.sportStats[sport.id];
                    const position = sportStats && sportStats.recommendedPosition ? sportStats.recommendedPosition : null;
                    
                    const card = document.createElement('div');
                    card.className = `sport-card ${isFavorite ? 'favorite' : ''}`;
                    card.innerHTML = `
                        <div class="favorite-star" onclick="event.stopPropagation(); SportAI.toggleFavorite('${sport.id}')">
                            ${isFavorite ? 
                                '<svg viewBox="0 0 24 24" fill="#F59E0B" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="#F59E0B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' :
                                '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
                            }
                        </div>
                        <div class="sport-icon">
                            ${sport.icon}
                        </div>
                        <div class="sport-name">${sport.name}</div>
                        <div class="text-muted" style="font-size: var(--font-xs);">${sport.description}</div>
                        ${position ? `<div class="position-badge">${position.name}</div>` : ''}
                        ${this.state.completedSportTests[sport.id] ? 
                            '<div style="font-size: 10px; color: var(--success-color); margin-top: 2px;">✓ Тест пройден</div>' : 
                            ''}
                    `;
                    
                    card.addEventListener('click', () => {
                        this.showSportDetails(sport.id);
                    });
                    
                    container.appendChild(card);
                });
            }
            
            getFavoriteSport() {
                if (this.state.favorites.length > 0) {
                    return SPORTS_DATABASE[this.state.favorites[0]];
                }
                return null;
            }
            
            async toggleFavorite(sportId) {
                const index = this.state.favorites.indexOf(sportId);
                
                if (index > -1) {
                    this.state.favorites.splice(index, 1);
                } else {
                    if (this.state.favorites.length < 3) {
                        this.state.favorites.push(sportId);
                    } else {
                        alert('Можно выбрать не более 3 избранных видов спорта');
                        return;
                    }
                }
                
                await this.saveState();
                this.updateSportsGrid();
                this.updateHomeContent();
            }
            
            closeSportDetails() {
                document.getElementById('sportDetailsModal').classList.remove('active');
                this.state.currentSportDetails = null;
            }
            
            initMiniCalendar() {
                const monthNames = [
                    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                ];
                
                const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                
                const today = new Date();
                const currentMonth = this.state.calendarCurrentMonth;
                const currentYear = this.state.calendarCurrentYear;
                
                document.getElementById('calendarMonthTitle').textContent = 
                    `${monthNames[currentMonth]} ${currentYear}`;
                
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                let calendarHTML = '';
                
                dayNames.forEach(day => {
                    calendarHTML += `<div class="calendar-day-header">${day}</div>`;
                });
                
                for (let i = 0; i < startingDay; i++) {
                    calendarHTML += `<div class="calendar-day other-month"></div>`;
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const dayOfWeek = date.getDay();
                    const dateString = date.toDateString();
                    
                    let dayClass = 'calendar-day';
                    let isToday = false;
                    let isWorkoutDay = false;
                    let isRestDay = false;
                    let hasWorkout = false;
                    
                    if (date.getDate() === today.getDate() && 
                        date.getMonth() === today.getMonth() && 
                        date.getFullYear() === today.getFullYear()) {
                        dayClass += ' today';
                        isToday = true;
                    }
                    
                    if (TRAINING_SCHEDULE.workoutDays.includes(dayOfWeek)) {
                        dayClass += ' workout';
                        isWorkoutDay = true;
                    } else if (TRAINING_SCHEDULE.restDays.includes(dayOfWeek)) {
                        dayClass += ' rest';
                        isRestDay = true;
                    }
                    
                    if (this.state.workoutHistory[dateString]) {
                        hasWorkout = true;
                    }
                    
                    let indicator = '';
                    if (hasWorkout) {
                        indicator = ' ✓';
                    }
                    
                    calendarHTML += `
                        <div class="${dayClass}" 
                             data-day="${day}" 
                             data-month="${currentMonth}" 
                             data-year="${currentYear}"
                             onclick="SportAI.showDayInfo(${day}, ${currentMonth}, ${currentYear})">
                            ${day}${indicator}
                            ${this.state.workoutFrequency === 2 && isWorkoutDay ? '<div style="font-size: 8px; margin-top: -2px;">2×</div>' : ''}
                        </div>
                    `;
                }
                
                const totalCells = 42;
                const filledCells = startingDay + daysInMonth;
                const remainingCells = totalCells - filledCells;
                
                for (let i = 0; i < remainingCells; i++) {
                    calendarHTML += `<div class="calendar-day other-month"></div>`;
                }
                
                document.getElementById('miniCalendar').innerHTML = calendarHTML;
            }
            
            changeCalendarMonth(direction) {
                let newMonth = this.state.calendarCurrentMonth + direction;
                let newYear = this.state.calendarCurrentYear;
                
                if (newMonth < 0) {
                    newMonth = 11;
                    newYear--;
                } else if (newMonth > 11) {
                    newMonth = 0;
                    newYear++;
                }
                
                this.state.calendarCurrentMonth = newMonth;
                this.state.calendarCurrentYear = newYear;
                
                this.saveState();
                this.initMiniCalendar();
            }
            
            closeCalendarModal() {
                document.getElementById('calendarModal').classList.remove('active');
            }
            
            isBeginnerLevel() {
                const bodyweight = this.state.testResults.bodyweight;
                if (!bodyweight) return true;
                
                const isLowStrength = bodyweight.pullups <= 5;
                const isLowWeight = this.state.userData.weight < 65;
                
                return isLowStrength || isLowWeight;
            }
            
            updateProfile() {
                const avatar = document.getElementById('profileAvatar');
                const name = document.getElementById('profileName');
                
                if (this.state.userData.gender) {
                    avatar.textContent = this.state.userData.gender === 'male' ? 'М' : 'Ж';
                }
                
                const age = document.getElementById('profileAge');
                const gender = document.getElementById('profileGender');
                
                if (this.state.userData.age) {
                    age.textContent = `${this.state.userData.age} лет`;
                }
                
                if (this.state.userData.gender) {
                    gender.textContent = this.state.userData.gender === 'male' ? 'Мужской' : 'Женский';
                }
                
                const bmi = this.calculateBMI();
                const bmiElement = document.getElementById('profileBmi');
                if (bmi) {
                    bmiElement.textContent = bmi.toFixed(1);
                }
                
                const bodyType = this.calculateBodyType();
                const bodyTypeElement = document.getElementById('profileBodyType');
                if (bodyType) {
                    bodyTypeElement.textContent = bodyType.name;
                }
                
                this.updatePersonalRecords();
            }
            
            calculateBMI() {
                if (!this.state.userData.height || !this.state.userData.weight) {
                    return null;
                }
                
                const heightM = this.state.userData.height / 100;
                return this.state.userData.weight / (heightM * heightM);
            }
            
            calculateBodyType() {
                if (!this.state.userData.wrist || !this.state.userData.height || !this.state.userData.gender) {
                    return null;
                }
                
                const solovyovIndex = (this.state.userData.wrist * this.state.userData.height) / 240;
                
                let bodyType;
                if (this.state.userData.gender === 'male') {
                    if (solovyovIndex < 15) bodyType = { name: 'Астеник', desc: 'Худощавое телосложение' };
                    else if (solovyovIndex <= 17) bodyType = { name: 'Нормостеник', desc: 'Среднее телосложение' };
                    else bodyType = { name: 'Гиперстеник', desc: 'Крупное телосложение' };
                } else {
                    if (solovyovIndex < 13) bodyType = { name: 'Астеник', desc: 'Худощавое телосложение' };
                    else if (solovyovIndex <= 15) bodyType = { name: 'Нормостеник', desc: 'Среднее телосложение' };
                    else bodyType = { name: 'Гиперстеник', desc: 'Крупное телосложение' };
                }
                
                return bodyType;
            }
            
            updatePersonalRecords() {
                const container = document.getElementById('personalRecords');
                
                if (!this.state.testResults.bodyweight || Object.keys(this.state.testResults.bodyweight).length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted" style="padding: var(--spacing-md);">
                            Пройдите тестирование
                        </div>
                    `;
                    return;
                }
                
                const records = [
                    { name: 'Отжимания', value: this.state.testResults.bodyweight.pushups, unit: 'раз' },
                    { name: 'Планка', value: this.state.testResults.bodyweight.plank, unit: 'сек' },
                    { name: 'Подтягивания', value: this.state.testResults.bodyweight.pullups, unit: 'раз' },
                    { name: 'Приседания', value: this.state.testResults.bodyweight.squats, unit: 'раз' }
                ];
                
                let html = '';
                records.forEach(record => {
                    if (record.value > 0) {
                        html += `
                            <li class="record-item">
                                <div class="record-info">
                                    <div class="record-name">${record.name}</div>
                                    <div class="record-date">Последний тест</div>
                                </div>
                                <div class="record-value">${record.value} ${record.unit}</div>
                            </li>
                        `;
                    }
                });
                
                // Добавляем спортивные навыки
                Object.entries(this.state.sportStats).forEach(([sportId, stats]) => {
                    if (stats.testResults) {
                        const sport = SPORTS_DATABASE[sportId];
                        if (sport) {
                            Object.entries(stats.testResults).forEach(([testId, value]) => {
                                const testConfig = sport.testConfig.tests.find(t => t.id === testId);
                                if (testConfig) {
                                    html += `
                                        <li class="record-item">
                                            <div class="record-info">
                                                <div class="record-name">${sport.name}: ${testConfig.name}</div>
                                                <div class="record-date">Спортивный тест</div>
                                            </div>
                                            <div class="record-value">${value} ${testConfig.unit}</div>
                                        </li>
                                    `;
                                }
                            });
                        }
                    }
                });
                
                if (html === '') {
                    html = `
                        <div class="text-center text-muted" style="padding: var(--spacing-md);">
                            Пока нет рекордов
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }
            
            showAnalysisTab(tabId) {
                document.querySelectorAll('.analysis-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.analysis-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const tabName = tabId.charAt(0).toUpperCase() + tabId.slice(1);
                document.getElementById('analysis' + tabName).classList.add('active');
                document.querySelector(`[onclick="SportAI.showAnalysisTab('${tabId}')"]`).classList.add('active');
                
                if (tabId === 'data') {
                    this.populateUpdateForm();
                } else if (tabId === 'results') {
                    this.updateAnalysisResults();
                }
            }
            
            populateUpdateForm() {
                if (this.state.userData.height) {
                    document.getElementById('updateHeight').value = this.state.userData.height;
                }
                if (this.state.userData.weight) {
                    document.getElementById('updateWeight').value = this.state.userData.weight;
                }
                if (this.state.userData.wrist) {
                    document.getElementById('updateWrist').value = this.state.userData.wrist;
                }
                if (this.state.userData.ankle) {
                    document.getElementById('updateAnkle').value = this.state.userData.ankle;
                }
                if (this.state.testResults.bodyweight.pushups !== undefined) {
                    document.getElementById('updatePushups').value = this.state.testResults.bodyweight.pushups;
                }
                if (this.state.testResults.bodyweight.plank !== undefined) {
                    document.getElementById('updatePlank').value = this.state.testResults.bodyweight.plank;
                }
                if (this.state.testResults.bodyweight.pullups !== undefined) {
                    document.getElementById('updatePullups').value = this.state.testResults.bodyweight.pullups;
                }
                if (this.state.testResults.bodyweight.squats !== undefined) {
                    document.getElementById('updateSquats').value = this.state.testResults.bodyweight.squats;
                }
            }
            
            async updateUserData() {
                const height = parseInt(document.getElementById('updateHeight').value);
                const weight = parseInt(document.getElementById('updateWeight').value);
                const wrist = parseFloat(document.getElementById('updateWrist').value);
                const ankle = parseFloat(document.getElementById('updateAnkle').value);
                
                if (!height || !weight || !wrist || !ankle) {
                    alert('Заполните все поля');
                    return;
                }
                
                this.state.userData.height = height;
                this.state.userData.weight = weight;
                this.state.userData.wrist = wrist;
                this.state.userData.ankle = ankle;
                
                await this.saveState();
                this.updateProfile();
                
                if (this.state.currentSportDetails) {
                    this.showSportDetails(this.state.currentSportDetails);
                }
                
                alert('Данные обновлены! Питание пересчитано под ваш новый вес.');
            }
            
            async updateBodyweightTest() {
                const pushups = parseInt(document.getElementById('updatePushups').value) || 0;
                const plank = parseInt(document.getElementById('updatePlank').value) || 0;
                const pullups = parseInt(document.getElementById('updatePullups').value) || 0;
                const squats = parseInt(document.getElementById('updateSquats').value) || 0;
                
                this.state.testResults.bodyweight = {
                    pushups: pushups,
                    plank: plank,
                    pullups: pullups,
                    squats: squats
                };
                
                await this.saveState();
                this.calculateFitnessLevel();
                this.updateProfile();
                alert('Рекорды обновлены!');
            }
            
            updateAnalysisResults() {
                if (this.state.testResults.reaction && this.state.testResults.reaction.length > 0) {
                    const avg = Math.round(this.state.testResults.reaction.reduce((a, b) => a + b) / this.state.testResults.reaction.length);
                    let reactionLevel;
                    if (avg < 200) reactionLevel = 'Отличная';
                    else if (avg < 250) reactionLevel = 'Хорошая';
                    else if (avg < 300) reactionLevel = 'Средняя';
                    else reactionLevel = 'Низкая';
                    
                    document.getElementById('analysisReaction').textContent = reactionLevel;
                } else {
                    document.getElementById('analysisReaction').textContent = 'Не тестирована';
                }
                
                const strength = this.calculateStrengthScore();
                if (strength) {
                    let strengthLevel;
                    if (strength >= 80) strengthLevel = 'Высокий';
                    else if (strength >= 60) strengthLevel = 'Выше среднего';
                    else if (strength >= 40) strengthLevel = 'Средний';
                    else if (strength >= 20) strengthLevel = 'Ниже среднего';
                    else strengthLevel = 'Низкий';
                    
                    document.getElementById('analysisStrength').textContent = strengthLevel;
                } else {
                    document.getElementById('analysisStrength').textContent = 'Не тестирован';
                }
                
                const bodyType = this.calculateBodyType();
                if (bodyType) {
                    document.getElementById('analysisBodyType').textContent = bodyType.name;
                    document.getElementById('analysisBodyTypeDesc').textContent = bodyType.desc;
                }
                
                const bmi = this.calculateBMI();
                if (bmi) {
                    document.getElementById('analysisBmi').textContent = bmi.toFixed(1);
                    
                    let category;
                    if (bmi < 18.5) category = 'Недостаточный вес';
                    else if (bmi < 25) category = 'Нормальный вес';
                    else if (bmi < 30) category = 'Избыточный вес';
                    else category = 'Ожирение';
                    
                    document.getElementById('analysisBmiCategory').textContent = category;
                }
                
                // Обновляем спортивные навыки
                const skillsContainer = document.getElementById('sportSkillsList');
                if (Object.keys(this.state.sportStats).length === 0) {
                    skillsContainer.innerHTML = '<p class="text-muted">Пройдите спортивные тесты для отображения навыков</p>';
                } else {
                    let skillsHtml = '';
                    Object.entries(this.state.sportStats).forEach(([sportId, stats]) => {
                        const sport = SPORTS_DATABASE[sportId];
                        if (sport && stats.recommendedPosition) {
                            skillsHtml += `
                                <div style="margin-bottom: var(--spacing-sm);">
                                    <strong>${sport.name}:</strong> ${stats.recommendedPosition.name}
                                    <div class="text-muted" style="font-size: var(--font-xs);">
                                        ${stats.recommendedPosition.description}
                                    </div>
                                </div>
                            `;
                        }
                    });
                    skillsContainer.innerHTML = skillsHtml || '<p class="text-muted">Пройдите спортивные тесты для отображения навыков</p>';
                }
            }
            
            calculateStrengthScore() {
                const bodyweight = this.state.testResults.bodyweight;
                if (!bodyweight) return null;
                
                let score = 0;
                if (bodyweight.pushups > 0) score += Math.min(30, bodyweight.pushups * 1.5);
                if (bodyweight.pullups > 0) score += Math.min(30, bodyweight.pullups * 8);
                if (bodyweight.plank > 0) score += Math.min(20, bodyweight.plank / 3);
                if (bodyweight.squats > 0) score += Math.min(20, bodyweight.squats / 2);
                
                return Math.min(100, score);
            }
            
            async resetApp() {
                if (confirm('Сбросить все данные и начать заново?')) {
                    if (this.isTelegram) {
                        try {
                            await window.Telegram.WebApp.CloudStorage.removeItem('sportAIState');
                        } catch (error) {
                            console.error('Ошибка удаления из CloudStorage:', error);
                        }
                    }
                    
                    localStorage.removeItem('sportAIState');
                    localStorage.removeItem('user_tested');
                    location.reload();
                }
            }
            
            // ============ ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ============
            calculateBMR() {
                const { age, gender, height, weight } = this.state.userData;
                
                if (!age || !gender || !height || !weight) {
                    return null;
                }
                
                if (gender === 'male') {
                    return (10 * weight) + (6.25 * height) - (5 * age) + 5;
                } else {
                    return (10 * weight) + (6.25 * height) - (5 * age) - 161;
                }
            }
            
            calculateTDEE(activityMultiplier = 1.55) {
                const bmr = this.calculateBMR();
                if (!bmr) return null;
                
                return Math.round(bmr * activityMultiplier);
            }
            
            calculateSportCalories(sportId, goal = null) {
                const tdee = this.calculateTDEE();
                if (!tdee) return null;
                
                let sportData = SPORTS_DATABASE[sportId];
                
                if (!sportData) return null;
                
                let formula;
                let activityMultiplier;
                
                if (sportId === 'gym' && goal) {
                    formula = sportData.goals[goal].nutritionFormula;
                    activityMultiplier = sportData.goals[goal].activityMultiplier;
                } else {
                    formula = sportData.nutritionFormula;
                    activityMultiplier = sportData.activityMultiplier;
                }
                
                if (!formula) return null;
                
                const adjustedTDEE = this.calculateTDEE(activityMultiplier);
                const calories = Math.round(adjustedTDEE * (1 + formula.calorieSurplus));
                
                return {
                    calories: calories,
                    protein: Math.round(formula.proteinPerKg * this.state.userData.weight),
                    carbs: Math.round(formula.carbsPerKg * this.state.userData.weight),
                    fat: Math.round(formula.fatPerKg * this.state.userData.weight)
                };
            }
            
            calculateNutritionProgram(sportId, goal = null) {
                const nutritionData = this.calculateSportCalories(sportId, goal);
                if (!nutritionData) return null;
                
                const userData = this.state.userData;
                const weight = userData.weight || 70;
                
                const foodDatabase = {
                    breakfast: [
                        { name: 'Овсянка', calories: 350, protein: 13, carbs: 60, fat: 6 },
                        { name: 'Яйца', calories: 155, protein: 13, carbs: 1, fat: 11 },
                        { name: 'Творог', calories: 120, protein: 17, carbs: 3, fat: 5 },
                        { name: 'Бананы', calories: 89, protein: 1, carbs: 23, fat: 0 }
                    ],
                    lunch: [
                        { name: 'Куриная грудка', calories: 165, protein: 31, carbs: 0, fat: 3.6 },
                        { name: 'Гречка', calories: 343, protein: 13, carbs: 72, fat: 3.4 },
                        { name: 'Овощи', calories: 50, protein: 2, carbs: 10, fat: 0 },
                        { name: 'Рис', calories: 130, protein: 2.7, carbs: 28, fat: 0.3 }
                    ],
                    dinner: [
                        { name: 'Рыба', calories: 206, protein: 22, carbs: 0, fat: 13 },
                        { name: 'Овощной салат', calories: 80, protein: 3, carbs: 15, fat: 2 },
                        { name: 'Авокадо', calories: 160, protein: 2, carbs: 9, fat: 15 }
                    ],
                    snacks: [
                        { name: 'Протеиновый коктейль', calories: 120, protein: 25, carbs: 3, fat: 1 },
                        { name: 'Орехи', calories: 607, protein: 20, carbs: 21, fat: 53 },
                        { name: 'Йогурт', calories: 59, protein: 10, carbs: 3.6, fat: 0.4 }
                    ]
                };
                
                const mealDistribution = {
                    breakfast: 0.25,
                    lunch: 0.35,
                    dinner: 0.25,
                    snacks: 0.15
                };
                
                const dailyMenu = {};
                
                Object.entries(mealDistribution).forEach(([meal, percentage]) => {
                    const mealCalories = Math.round(nutritionData.calories * percentage);
                    const foods = foodDatabase[meal];
                    
                    if (foods && foods.length > 0) {
                        const selectedFoods = [];
                        let remainingCalories = mealCalories;
                        
                        foods.forEach(food => {
                            if (remainingCalories <= 0) return;
                            
                            const foodAmount = Math.round((mealCalories * 0.3) / (food.calories / 100));
                            if (foodAmount > 0) {
                                selectedFoods.push({
                                    name: food.name,
                                    weight: foodAmount,
                                    calories: Math.round(foodAmount * food.calories / 100)
                                });
                                remainingCalories -= Math.round(foodAmount * food.calories / 100);
                            }
                        });
                        
                        dailyMenu[meal] = selectedFoods;
                    }
                });
                
                return {
                    nutritionData: nutritionData,
                    dailyMenu: dailyMenu,
                    water: this.calculateWaterIntake()
                };
            }
            
            calculateSupplements(userData, goal, sportId) {
                const weight = userData.weight || 70;
                const isStrength = goal === 'muscle' || sportId === 'gym';
                
                const supplements = [
                    {
                        name: 'Креатин моногидрат',
                        dose: Math.min(5, Math.round(weight * 0.07 * 10) / 10) + ' г',
                        timing: 'Сразу после тренировки',
                        description: 'Увеличивает силу и мышечную массу',
                        category: 'energy'
                    },
                    {
                        name: 'Сывороточный протеин',
                        dose: '25 г',
                        timing: 'Между приемами пищи или после тренировки',
                        description: 'Быстро усваиваемый белок для синтеза мышц',
                        category: 'essential'
                    },
                    {
                        name: 'Омега-3',
                        dose: '2000 мг',
                        timing: 'С завтраком',
                        description: 'Снижает воспаление, улучшает здоровье суставов',
                        category: 'essential'
                    },
                    {
                        name: 'Витамин D3',
                        dose: '2000 МЕ',
                        timing: 'С завтраком',
                        description: 'Укрепляет кости и иммунную систему',
                        category: 'essential'
                    }
                ];
                
                if (isStrength) {
                    supplements.push({
                        name: 'BCAA',
                        dose: '10 г',
                        timing: 'До или во время тренировки',
                        description: 'Снижает усталость, ускоряет восстановление',
                        category: 'recovery'
                    });
                }
                
                if (sportId !== 'gym') {
                    supplements.push({
                        name: 'Электролиты',
                        dose: 'По необходимости',
                        timing: 'Во время тренировки',
                        description: 'Восполняет потерю солей при потоотделении',
                        category: 'recovery'
                    });
                }
                
                return supplements;
            }
            
            updateSupplementsByCategory(supplements) {
                const container = document.getElementById('supplementsCategories');
                
                const categories = {
                    essential: { title: 'Основное', icon: '⭐', supplements: [] },
                    energy: { title: 'Для энергии', icon: '⚡', supplements: [] },
                    recovery: { title: 'Для восстановления', icon: '🔄', supplements: [] }
                };
                
                supplements.forEach(supplement => {
                    if (categories[supplement.category]) {
                        categories[supplement.category].supplements.push(supplement);
                    } else {
                        categories.essential.supplements.push(supplement);
                    }
                });
                
                container.innerHTML = '';
                
                Object.entries(categories).forEach(([categoryId, category]) => {
                    if (category.supplements.length === 0) return;
                    
                    const categoryHtml = `
                        <div class="supplement-category">
                            <div class="category-header">
                                <div class="category-icon">${category.icon}</div>
                                <div class="category-title">${category.title}</div>
                            </div>
                            <ul class="supplements-list">
                                ${category.supplements.map(supplement => `
                                    <li class="supplement-item">
                                        <div class="supplement-name">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                            ${supplement.name}
                                        </div>
                                        <div class="supplement-desc">
                                            <strong>Доза:</strong> ${supplement.dose}<br>
                                            <strong>Когда:</strong> ${supplement.timing}<br>
                                            ${supplement.description}
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                    
                    container.innerHTML += categoryHtml;
                });
            }
            
            selectRandomExercises(pool, count) {
                const shuffled = [...pool].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            }
            
            calculateExerciseWeight(exercise, userData, isBeginner) {
                if (!userData.weight) return null;
                
                const weight = userData.weight;
                let percentage = 0;
                
                if (exercise.name.includes('Приседания') || exercise.name.includes('Становая')) {
                    percentage = isBeginner ? 0.5 : 0.8;
                } else if (exercise.name.includes('Жим лежа')) {
                    percentage = isBeginner ? 0.3 : 0.6;
                } else if (exercise.name.includes('гантел')) {
                    percentage = isBeginner ? 0.1 : 0.2;
                } else {
                    percentage = isBeginner ? 0.15 : 0.25;
                }
                
                const calculated = Math.round(weight * percentage / 2.5) * 2.5;
                return Math.max(5, Math.min(calculated, weight * 0.8));
            }
            
            getExerciseTip(exercise, userData) {
                const tips = {
                    'Приседания': 'Держите спину прямой, колени не выходят за носки',
                    'Жим лежа': 'Сводите лопатки, создавая устойчивую опору',
                    'Подтягивания': 'В верхней точке старайтесь коснуться перекладины грудью',
                    'Становая тяга': 'Сохраняйте естественный прогиб в пояснице',
                    'Планка': 'Держите корпус напряженным, избегайте провисания таза',
                    'Берпи': 'Сохраняйте высокий темп, но следите за техникой',
                    'Выпады': 'Колено передней ноги не должно выходить за носок'
                };
                
                for (const [key, tip] of Object.entries(tips)) {
                    if (exercise.name.includes(key)) {
                        return tip;
                    }
                }
                
                return 'Фокусируйтесь на правильной технике выполнения';
            }
            
            updateGymDetails(sport, goal) {
                const goalData = sport.goals[goal];
                const isBeginner = this.isBeginnerLevel();
                
                const workouts = this.calculateWorkoutProgram('gym', goal);
                const workoutList = document.getElementById('workoutList');
                
                if (workouts.length === 0) {
                    workoutList.innerHTML = '<li class="workout-item"><div class="workout-name">Тренировка адаптирована под ваш ИМТ</div><div class="workout-tip">При высоком ИМТ исключены прыжковые упражнения для безопасности суставов</div></li>';
                } else {
                    workoutList.innerHTML = workouts.map(workout => `
                        <li class="workout-item">
                            <div class="workout-header">
                                <div class="workout-name">${workout.name}</div>
                                <div class="text-muted" style="font-size: var(--font-xs);">
                                    ${workout.type === 'plyometric' ? '⚡ Взрывное' : 
                                      workout.type === 'compound' ? '🏋️ База' : 
                                      workout.type === 'isolation' ? '🔬 Изоляция' :
                                      workout.type === 'static' ? '⏱️ Статика' : '🏃 Кардио'}
                                </div>
                            </div>
                            <div class="workout-details">
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                        <path d="M8 12H16M12 8V16" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    Подходы: ${workout.sets}
                                </span>
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    Повторения: ${workout.reps}
                                </span>
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 20V10M8 20V14M16 20V14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    Отдых: ${workout.rest}
                                </span>
                            </div>
                            ${workout.weight ? `<div class="dumbbell-weight">🏋️ Вес: ${workout.weight} ${workout.weightNote ? '(' + workout.weightNote + ')' : ''}</div>` : ''}
                            ${workout.tip ? `<div class="workout-tip">💡 ${workout.tip}</div>` : ''}
                            ${workout.adaptiveNote ? `<div class="adaptive-note">⚡ ${workout.adaptiveNote}</div>` : ''}
                            ${isBeginner ? `<div class="adaptive-note">⚡ Начните с легких весов, фокусируйтесь на технике</div>` : ''}
                        </li>
                    `).join('');
                }
                
                const nutritionProgram = this.calculateNutritionProgram('gym', goal);
                if (nutritionProgram) {
                    const waterIntake = this.calculateWaterIntake();
                    
                    const nutritionGrid = document.getElementById('nutritionGrid');
                    nutritionGrid.innerHTML = `
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionProgram.nutritionData.calories} ккал</div>
                            <div class="nutrition-label">Калории</div>
                            <div class="nutrition-dynamic-note">TDEE + ${goalData.nutritionFormula.calorieSurplus * 100}%</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionProgram.nutritionData.protein} г</div>
                            <div class="nutrition-label">Белок</div>
                            <div class="nutrition-dynamic-note">${goalData.nutritionFormula.proteinPerKg} г/кг</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionProgram.nutritionData.carbs} г</div>
                            <div class="nutrition-label">Углеводы</div>
                            <div class="nutrition-dynamic-note">${goalData.nutritionFormula.carbsPerKg} г/кг</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${waterIntake} л</div>
                            <div class="nutrition-label">Вода</div>
                            <div class="nutrition-dynamic-note">Формула: (вес × 0.033) + (спорт × 0.01)</div>
                        </div>
                    `;
                    
                    const dailyMenu = document.getElementById('dailyMenu');
                    let menuHtml = '<div style="margin-top: var(--spacing-sm);">';
                    
                    Object.entries(nutritionProgram.dailyMenu).forEach(([meal, foods]) => {
                        const mealNames = {
                            breakfast: 'Завтрак',
                            lunch: 'Обед',
                            dinner: 'Ужин',
                            snacks: 'Перекусы'
                        };
                        
                        menuHtml += `<div style="margin-bottom: var(--spacing-sm);"><strong>${mealNames[meal]}:</strong><br>`;
                        foods.forEach(food => {
                            menuHtml += `<div class="menu-item">
                                <span class="menu-food">${food.name}</span>
                                <span class="menu-weight">${food.weight} г</span>
                            </div>`;
                        });
                        menuHtml += '</div>';
                    });
                    
                    menuHtml += `<div class="text-muted" style="margin-top: var(--spacing-sm);">
                        💧 Вода: ${waterIntake} л в день<br>
                        ⏱️ ${this.state.workoutFrequency} тренировка(и) в день<br>
                        ${goal === 'muscle' ? '📈 Избыток калорий для набора массы' : '📉 Поддержание калоража для рельефа'}
                    </div></div>`;
                    dailyMenu.innerHTML = menuHtml;
                }
                
                const supplements = this.calculateSupplements(this.state.userData, goal, 'gym');
                this.updateSupplementsByCategory(supplements);
            }
        }

        // Инициализация приложения
        const SportAI = new SportAIPro();
        window.SportAI = SportAI;
        window.SportAIPro = SportAIPro;
        window.LoadCalculator = LoadCalculator;
        
        console.log('SportAI с продвинутой системой расчета нагрузки инициализирован');
    </script>
</body>
    </html>
