<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SportAI Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables - Dark Theme by Default */
        :root {
            /* Dark Theme (Default) */
            --bg-primary: #000000;
            --bg-secondary: #111111;
            --bg-tertiary: #1A1A1A;
            --text-primary: #FFFFFF;
            --text-secondary: #CCCCCC;
            --text-tertiary: #999999;
            --border-color: #333333;
            --border-light: #444444;
            --accent-color: #FFFFFF;
            --accent-secondary: #666666;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --info-color: #3B82F6;
            --calendar-today: #3B82F6;
            --calendar-workout: #10B981;
            --calendar-rest: #8B5CF6;
            
            /* Spacing - Уменьшено для компактности */
            --spacing-xs: 3px;
            --spacing-sm: 6px;
            --spacing-md: 10px;
            --spacing-lg: 14px;
            --spacing-xl: 18px;
            --spacing-xxl: 24px;
            
            /* Typography - Уменьшено для компактности */
            --font-xs: 11px;
            --font-sm: 13px;
            --font-base: 16px;
            --font-lg: 18px;
            --font-xl: 22px;
            --font-xxl: 26px;
            
            /* Border Radius */
            --radius-sm: 3px;
            --radius: 6px;
            --radius-lg: 10px;
            
            /* Line Height */
            --line-height: 1.3;
            
            /* Transitions */
            --transition-fast: 0.12s ease;
            --transition-base: 0.25s ease;
            --transition-slow: 0.4s ease;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 2px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        /* Light Theme Variables */
        [data-theme="light"] {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F5F5F5;
            --bg-tertiary: #EEEEEE;
            --text-primary: #000000;
            --text-secondary: #333333;
            --text-tertiary: #666666;
            --border-color: #DDDDDD;
            --border-light: #EEEEEE;
            --accent-color: #000000;
            --accent-secondary: #888888;
            --success-color: #059669;
            --warning-color: #D97706;
            --danger-color: #DC2626;
            --info-color: #2563EB;
            --calendar-today: #2563EB;
            --calendar-workout: #059669;
            --calendar-rest: #7C3AED;
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            font-size: 14px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: var(--line-height);
            font-weight: 400;
            font-size: var(--font-base);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* App Container */
        .app-container {
            min-height: 100vh;
            max-width: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Header - Компактный */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-md);
            z-index: 1000;
            backdrop-filter: blur(20px);
            background-color: rgba(17, 17, 17, 0.95);
        }

        [data-theme="light"] .header {
            background-color: rgba(245, 245, 245, 0.95);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo-icon {
            width: 24px;
            height: 24px;
        }

        .logo-text {
            font-size: var(--font-base);
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* Profile button in header - уменьшен */
        .profile-btn-header {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-base);
            padding: 0;
        }

        .profile-btn-header:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        /* Main Content */
        .main {
            flex: 1;
            padding: 52px var(--spacing-md) 52px;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        /* Sections */
        .section {
            display: none;
            flex-direction: column;
            gap: var(--spacing-lg);
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mini Calendar */
        .calendar-mini {
            margin: var(--spacing-sm) 0 var(--spacing-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--spacing-sm);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            padding: 0 var(--spacing-xs);
        }

        .calendar-title {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--text-primary);
        }

        .calendar-nav {
            display: flex;
            gap: var(--spacing-xs);
        }

        .calendar-nav-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .calendar-nav-btn:hover {
            background: var(--border-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            padding: var(--spacing-xs) 0;
            font-weight: 500;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-xs);
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            border: 1px solid transparent;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-tertiary);
        }

        .calendar-day.today {
            background: var(--calendar-today);
            color: white;
            border-color: var(--calendar-today);
        }

        .calendar-day.workout {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .calendar-day.rest {
            background: rgba(139, 92, 246, 0.15);
            color: var(--calendar-rest);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .calendar-day.other-month {
            color: var(--text-tertiary);
            opacity: 0.5;
        }

        .calendar-day.active {
            border: 2px solid var(--accent-color);
        }

        /* Calendar Modal */
        .calendar-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 4000;
            overflow-y: auto;
            padding: 0;
            display: none;
        }

        .calendar-modal.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .calendar-modal-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .calendar-modal-content {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }

        .calendar-modal-day {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-secondary);
        }

        .calendar-modal-title {
            font-size: var(--font-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--accent-color);
        }

        .calendar-modal-subtitle {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .workout-schedule {
            margin: var(--spacing-md) 0;
        }

        .schedule-item {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-xs);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .schedule-time {
            font-weight: 600;
            color: var(--success-color);
            min-width: 60px;
            font-size: var(--font-sm);
        }

        .schedule-activity {
            flex: 1;
            font-size: var(--font-sm);
        }

        /* Onboarding */
        .onboarding {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-md);
            gap: var(--spacing-md);
            overflow-y: auto;
        }

        .onboarding.hidden {
            display: none;
        }

        .onboarding-step {
            display: none;
            flex-direction: column;
            gap: var(--spacing-md);
            flex: 1;
        }

        .onboarding-step.active {
            display: flex;
        }

        .onboarding-progress {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
        }

        .progress-step {
            flex: 1;
            height: 2px;
            background: var(--border-color);
            border-radius: 1px;
            transition: var(--transition-base);
        }

        .progress-step.active {
            background: var(--accent-color);
        }

        /* Test Grid Layout - уменьшен */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-xs);
            margin: var(--spacing-sm) 0;
        }

        .test-option-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--font-xs);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-base);
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .test-option-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-color);
        }

        .test-option-btn.selected {
            background: var(--accent-color);
            color: var(--bg-primary);
            border-color: var(--accent-color);
        }

        /* Typography */
        .h1 {
            font-size: var(--font-xxl);
            font-weight: 700;
            letter-spacing: -0.03em;
            line-height: 1.2;
            margin-bottom: var(--spacing-xs);
        }

        .h2 {
            font-size: var(--font-xl);
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: var(--spacing-sm);
        }

        .h3 {
            font-size: var(--font-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .subtitle {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            line-height: var(--line-height);
            margin-bottom: var(--spacing-sm);
        }

        .caption {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--spacing-sm);
            transition: var(--transition-base);
        }

        .card:hover {
            border-color: var(--border-light);
            box-shadow: var(--shadow-sm);
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--spacing-sm);
        }

        .form-label {
            display: block;
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: var(--font-base);
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition-base);
            line-height: var(--line-height);
            height: 36px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        [data-theme="light"] .form-input:focus {
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        .form-row {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }

        .form-col {
            flex: 1;
        }

        /* Buttons - уменьшены */
        .btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: var(--font-sm);
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: var(--transition-base);
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            text-align: center;
            text-decoration: none;
            min-height: 36px;
            line-height: var(--line-height);
        }

        .btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--accent-color);
            color: var(--bg-primary);
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background: var(--text-secondary);
            border-color: var(--text-secondary);
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-xs);
            min-height: 30px;
        }

        .icon-btn {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Test Components - уменьшены */
        .test-area {
            width: 100%;
            height: 200px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
            margin: var(--spacing-sm) 0;
        }

        .reaction-target {
            position: absolute;
            width: 44px;
            height: 44px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: transform 0.1s;
        }

        .test-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .stat-box {
            padding: var(--spacing-xs);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            text-align: center;
        }

        .stat-value {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Home - Main Hub */
        .welcome-section {
            margin-bottom: var(--spacing-md);
        }

        .greeting {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .time-based-section {
            margin-bottom: var(--spacing-md);
        }

        .time-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            font-size: var(--font-sm);
        }

        .time-icon {
            width: 14px;
            height: 14px;
        }

        .favorite-sport {
            margin-bottom: var(--spacing-md);
        }

        .sport-card-large {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transition: var(--transition-base);
            cursor: pointer;
        }

        .sport-card-large:hover {
            border-color: var(--border-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .sport-icon-large {
            width: 44px;
            height: 44px;
            flex-shrink: 0;
        }

        .sport-info {
            flex: 1;
        }

        .sport-name {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .sport-desc {
            color: var(--text-secondary);
            font-size: var(--font-xs);
            line-height: var(--line-height);
        }

        /* Sports Grid */
        .sports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: var(--spacing-xs);
            margin: var(--spacing-sm) 0;
        }

        .sport-card {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            position: relative;
        }

        .sport-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .sport-card.favorite {
            border-color: var(--warning-color);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent);
        }

        .favorite-star {
            position: absolute;
            top: var(--spacing-xs);
            right: var(--spacing-xs);
            width: 16px;
            height: 16px;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .favorite-star:hover {
            transform: scale(1.1);
        }

        .sport-icon {
            width: 32px;
            height: 32px;
            margin-bottom: var(--spacing-xs);
        }

        /* Today Recommendations */
        .today-recommendations {
            margin: var(--spacing-md) 0;
        }

        .recommendation-card {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-xs);
            background: var(--bg-secondary);
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
        }

        .recommendation-icon {
            width: 20px;
            height: 20px;
        }

        .recommendation-title {
            font-size: var(--font-sm);
            font-weight: 600;
        }

        .recommendation-list {
            list-style: none;
        }

        .recommendation-item {
            padding: var(--spacing-xs) 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            line-height: var(--line-height);
            font-size: var(--font-xs);
        }

        .recommendation-item:last-child {
            border-bottom: none;
        }

        .check-icon {
            width: 14px;
            height: 14px;
            color: var(--success-color);
            flex-shrink: 0;
        }

        /* Profile Section */
        .profile-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-base);
            font-weight: 600;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .profile-meta {
            color: var(--text-secondary);
            font-size: var(--font-xs);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-xs);
            margin: var(--spacing-md) 0;
        }

        .profile-stat-card {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            text-align: center;
            background: var(--bg-secondary);
        }

        .profile-stat-value {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .personal-records {
            margin: var(--spacing-md) 0;
        }

        .record-list {
            list-style: none;
        }

        .record-item {
            padding: var(--spacing-xs);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-xs);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
        }

        .record-info {
            flex: 1;
        }

        .record-name {
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            font-size: var(--font-sm);
        }

        .record-date {
            color: var(--text-tertiary);
            font-size: var(--font-xs);
        }

        .record-value {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--success-color);
        }

        /* Analysis Section */
        .analysis-tabs {
            display: flex;
            gap: var(--spacing-xs);
            background: var(--bg-tertiary);
            padding: var(--spacing-xs);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-sm);
        }

        .analysis-tab {
            flex: 1;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            font-size: var(--font-xs);
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition-base);
        }

        .analysis-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .analysis-content {
            display: none;
            opacity: 0;
            transform: translateY(5px);
            transition: opacity var(--transition-base), transform var(--transition-base);
        }

        .analysis-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Sport Details Modal */
        .sport-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 3000;
            overflow-y: auto;
            padding: 0;
            display: none;
        }

        .sport-details-modal.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .sport-details-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sport-details-content {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }

        .sport-details-section {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-secondary);
        }

        .sport-details-section h3 {
            margin-bottom: var(--spacing-sm);
            color: var(--accent-color);
            font-size: var(--font-base);
            border-bottom: 1px solid var(--border-light);
            padding-bottom: var(--spacing-xs);
        }

        /* Workout list */
        .workout-list {
            list-style: none;
            margin: var(--spacing-sm) 0;
        }

        .workout-item {
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            background: var(--bg-tertiary);
            border-left: 3px solid var(--info-color);
        }

        .workout-item:last-child {
            margin-bottom: 0;
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-xs);
        }

        .workout-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-sm);
        }

        .workout-details {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            display: flex;
            gap: var(--spacing-sm);
        }

        .workout-detail-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .workout-tip {
            font-size: var(--font-xs);
            color: var(--success-color);
            font-style: italic;
            margin-top: var(--spacing-xs);
            padding: var(--spacing-xs);
            background: rgba(16, 185, 129, 0.1);
            border-radius: var(--radius-sm);
            border-left: 2px solid var(--success-color);
        }

        .adaptive-note {
            display: inline-block;
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-xs);
            margin-top: var(--spacing-xs);
            border-left: 2px solid var(--warning-color);
        }

        .dumbbell-weight {
            font-weight: 600;
            color: var(--warning-color);
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
            margin: var(--spacing-sm) 0;
        }

        .nutrition-item {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            text-align: center;
            background: var(--bg-tertiary);
            border-top: 2px solid var(--success-color);
        }

        .nutrition-value {
            font-size: var(--font-base);
            font-weight: 600;
            color: var(--success-color);
            margin-bottom: var(--spacing-xs);
        }

        .nutrition-label {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        .nutrition-dynamic-note {
            font-size: var(--font-xs);
            color: var(--text-tertiary);
            margin-top: var(--spacing-xs);
            font-style: italic;
        }

        /* Supplements */
        .supplements-categories {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin: var(--spacing-sm) 0;
        }

        .supplement-category {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            background: var(--bg-tertiary);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
            padding-bottom: var(--spacing-xs);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .category-icon {
            width: 20px;
            height: 20px;
            color: var(--warning-color);
        }

        .category-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-sm);
        }

        .supplements-list {
            list-style: none;
        }

        .supplement-item {
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            background: var(--bg-primary);
        }

        .supplement-item:last-child {
            margin-bottom: 0;
        }

        .supplement-name {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-sm);
        }

        .supplement-desc {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            line-height: 1.4;
        }

        .disclaimer {
            padding: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            border: 1px solid var(--warning-color);
            border-radius: var(--radius);
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            font-size: var(--font-xs);
            text-align: center;
        }

        .gym-goal-selector {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .goal-btn {
            flex: 1;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: var(--font-xs);
            font-weight: 500;
            transition: var(--transition-base);
        }

        .goal-btn.active {
            background: var(--accent-color);
            color: var(--bg-primary);
            border-color: var(--accent-color);
        }

        /* Mark workout button */
        .mark-workout-btn {
            margin-top: var(--spacing-md);
            width: 100%;
        }

        /* AI Trainer Chat Window */
        .chat-container {
            position: fixed;
            bottom: 70px;
            right: var(--spacing-md);
            width: 350px;
            height: 500px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            z-index: 2000;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .chat-title {
            font-weight: 600;
            font-size: var(--font-sm);
        }

        .chat-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .chat-close:hover {
            background: var(--border-color);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-sm);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .chat-message {
            padding: var(--spacing-sm);
            border-radius: var(--radius);
            max-width: 80%;
            font-size: var(--font-sm);
            line-height: 1.4;
        }

        .chat-message.user {
            align-self: flex-end;
            background: var(--info-color);
            color: white;
        }

        .chat-message.assistant {
            align-self: flex-start;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .chat-input-area {
            padding: var(--spacing-sm);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-xs);
            background: var(--bg-tertiary);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .chat-input {
            flex: 1;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-sm);
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .chat-send-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--accent-color);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: var(--font-sm);
            font-weight: 500;
        }

        .chat-send-btn:hover {
            background: var(--text-secondary);
        }

        /* AI Generate Button */
        .ai-generate-btn {
            margin-top: var(--spacing-sm);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .ai-generate-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-1px);
        }

        .ai-loading {
            display: none;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            justify-content: center;
            color: var(--text-secondary);
        }

        .ai-loading.active {
            display: flex;
        }

        /* AI Trainer Button in Header */
        .ai-trainer-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-base);
            padding: 0;
        }

        .ai-trainer-btn:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        /* Navigation */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            padding: var(--spacing-xs) var(--spacing-sm);
            gap: var(--spacing-xs);
            z-index: 1000;
            backdrop-filter: blur(20px);
            background-color: rgba(17, 17, 17, 0.95);
        }

        [data-theme="light"] .nav {
            background-color: rgba(245, 245, 245, 0.95);
        }

        .nav-btn {
            flex: 1;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            font-size: var(--font-xs);
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius);
            transition: var(--transition-base);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .nav-btn:hover {
            background: var(--bg-tertiary);
        }

        .nav-btn.active {
            color: var(--accent-color);
            background: var(--bg-tertiary);
        }

        .nav-icon {
            width: 16px;
            height: 16px;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-md);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility Classes */
        .mt-1 { margin-top: var(--spacing-xs); }
        .mt-2 { margin-top: var(--spacing-sm); }
        .mt-3 { margin-top: var(--spacing-md); }
        .mt-4 { margin-top: var(--spacing-lg); }
        .mt-6 { margin-top: var(--spacing-xl); }
        .mb-1 { margin-bottom: var(--spacing-xs); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mb-4 { margin-bottom: var(--spacing-lg); }
        .mb-6 { margin-bottom: var(--spacing-xl); }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-tertiary); }
        .d-none { display: none !important; }
        .d-flex { display: flex; }
        .d-block { display: block; }
        .flex-column { flex-direction: column; }
        .align-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: var(--spacing-sm); }
        .gap-4 { gap: var(--spacing-md); }
        .gap-6 { gap: var(--spacing-lg); }
        .w-100 { width: 100%; }

        /* Responsive */
        @media (max-width: 768px) {
            .main {
                padding: 52px var(--spacing-sm) 52px;
            }
            
            .header {
                padding: 0 var(--spacing-sm);
            }
            
            .nav {
                padding: var(--spacing-xs) var(--spacing-sm);
            }
            
            .form-row {
                flex-direction: column;
                gap: var(--spacing-xs);
            }
            
            .sports-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
            
            .nutrition-grid {
                grid-template-columns: 1fr;
            }
            
            .gym-goal-selector {
                flex-direction: column;
            }
            
            .chat-container {
                width: calc(100% - var(--spacing-md) * 2);
                height: 400px;
                bottom: 60px;
            }
        }

        @media (max-width: 480px) {
            .main {
                padding: 52px var(--spacing-xs) 52px;
            }
            
            .onboarding {
                padding: var(--spacing-sm);
            }
            
            .sport-card-large {
                flex-direction: column;
                text-align: center;
                gap: var(--spacing-xs);
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: var(--spacing-xs);
            }
            
            .sports-grid {
                grid-template-columns: 1fr;
            }
            
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                gap: 1px;
            }
            
            .chat-container {
                width: calc(100% - var(--spacing-xs) * 2);
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- AI Trainer Chat Window -->
        <div class="chat-container" id="aiChat">
            <div class="chat-header">
                <div class="chat-title">ИИ-Тренер</div>
                <button class="chat-close" onclick="SportAI.closeChat()">×</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message assistant">
                    Привет! Я ваш персональный ИИ-тренер. Спросите меня о тренировках, питании или восстановлении.
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="Введите ваш вопрос...">
                <button class="chat-send-btn" onclick="SportAI.sendMessage()">→</button>
            </div>
            <div class="ai-loading" id="chatLoading">
                <div class="spinner"></div>
                <span>ИИ думает...</span>
            </div>
        </div>

        <!-- Onboarding Screen (Fullscreen) -->
        <div class="onboarding" id="onboarding">
            <!-- Step 1: Welcome -->
            <div class="onboarding-step active" id="onboardingStep1">
                <div class="onboarding-progress">
                    <div class="progress-step active"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                </div>
                
                <div class="card">
                    <h1 class="h1">Добро пожаловать в SportAI Pro</h1>
                    <p class="subtitle">Персональный тренер, который подберет идеальный спорт и программу тренировок на основе ваших данных.</p>
                    
                    <div class="mt-4">
                        <h3 class="h3">Как это работает:</h3>
                        <div class="d-flex flex-column gap-4 mt-2">
                            <div class="d-flex gap-3 align-center">
                                <div style="width: 28px; height: 28px; background: var(--bg-tertiary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">1</div>
                                <div>
                                    <div style="font-weight: 500;">Ввод данных</div>
                                    <div class="text-muted">Рост, вес, возраст и замеры тела</div>
                                </div>
                            </div>
                            <div class="d-flex gap-3 align-center">
                                <div style="width: 28px; height: 28px; background: var(--bg-tertiary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">2</div>
                                <div>
                                    <div style="font-weight: 500;">Тестирование</div>
                                    <div class="text-muted">Реакция и упражнения с весом тела</div>
                                </div>
                            </div>
                            <div class="d-flex gap-3 align-center">
                                <div style="width: 28px; height: 28px; background: var(--bg-tertiary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">3</div>
                                <div>
                                    <div style="font-weight: 500;">Анализ</div>
                                    <div class="text-muted">AI подбирает лучший спорт и программу</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary btn-block mt-4" onclick="SportAI.onboardingNext()">
                        Начать настройку →
                    </button>
                </div>
            </div>

            <!-- Step 2: Basic Data -->
            <div class="onboarding-step" id="onboardingStep2">
                <div class="onboarding-progress">
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                </div>
                
                <div class="card">
                    <h2 class="h2">Ваши базовые данные</h2>
                    <p class="subtitle">Эти данные нужны для точного расчета соматотипа и рекомендаций</p>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Возраст</label>
                            <input type="number" class="form-input" id="age" min="14" max="80" placeholder="25">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Пол</label>
                            <select class="form-input" id="gender">
                                <option value="">Выбрать</option>
                                <option value="male">Мужской</option>
                                <option value="female">Женский</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Рост (см)</label>
                            <input type="number" class="form-input" id="height" min="120" max="220" placeholder="175">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Вес (кг)</label>
                            <input type="number" class="form-input" id="weight" min="30" max="150" placeholder="70">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Обхват запястья (см)</label>
                            <input type="number" class="form-input" id="wrist" min="12" max="25" step="0.1" placeholder="16.5">
                            <div class="caption mt-1">Измерьте самую тонкую часть запястья</div>
                        </div>
                        <div class="form-col">
                            <label class="form-label">Обхват щиколотки (см)</label>
                            <input type="number" class="form-input" id="ankle" min="15" max="30" step="0.1" placeholder="22.5">
                            <div class="caption mt-1">Над косточкой щиколотки</div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3 mt-4">
                        <button class="btn" onclick="SportAI.onboardingPrev()">
                            ← Назад
                        </button>
                        <button class="btn btn-primary" onclick="SportAI.onboardingNext()">
                            Далее: Тест реакции →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Reaction Test -->
            <div class="onboarding-step" id="onboardingStep3">
                <div class="onboarding-progress">
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                    <div class="progress-step"></div>
                </div>
                
                <div class="card">
                    <h2 class="h2">Тест на скорость реакции</h2>
                    <p class="subtitle">Нажимайте на появляющиеся круги как можно быстрее. Тест займет 30 секунд.</p>
                    
                    <div class="test-area" id="reactionArea">
                        <div class="text-center" style="margin-top: 80px; color: var(--text-tertiary); font-size: var(--font-sm);" id="reactionMessage">
                            Нажмите "Начать тест"
                        </div>
                    </div>
                    
                    <div class="test-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="reactionAvg">-</div>
                            <div class="stat-label">Среднее время (мс)</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="reactionBest">-</div>
                            <div class="stat-label">Лучшее время (мс)</div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3">
                        <button class="btn" onclick="SportAI.onboardingPrev()">
                            ← Назад
                        </button>
                        <button class="btn btn-primary" id="startReaction" onclick="SportAI.startReactionTest()">
                            Начать тест
                        </button>
                        <button class="btn btn-primary d-none" id="continueBtn" onclick="SportAI.onboardingNext()">
                            Продолжить →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Bodyweight Test -->
            <div class="onboarding-step" id="onboardingStep4">
                <div class="onboarding-progress">
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                    <div class="progress-step active"></div>
                </div>
                
                <div class="card">
                    <h2 class="h2">Тест с весом тела</h2>
                    <p class="subtitle">Введите свои максимальные результаты. Если не можете выполнить - введите 0.</p>
                    
                    <div class="form-group">
                        <label class="form-label">Сколько раз можете отжаться? (полные отжимания)</label>
                        <input type="number" class="form-input" id="pushups" placeholder="0" min="0" value="0">
                        <div class="caption mt-1">Лягте на пол, руки на ширине плеч, опуститесь до угла 90° в локтях</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Сколько секунд можете простоять в планке?</label>
                        <input type="number" class="form-input" id="plank" placeholder="0" min="0" value="0">
                        <div class="caption mt-1">На локтях, тело прямое, таз не провисает</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Сколько раз можете подтянуться?</label>
                        <input type="number" class="form-input" id="pullups" placeholder="0" min="0" value="0">
                        <div class="caption mt-1">Если не можете - введите 0. Используйте прямой хват</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Сколько раз присядете за 1 минуту?</label>
                        <input type="number" class="form-input" id="squats" placeholder="0" min="0" value="0">
                        <div class="caption mt-1">Без веса, бедра параллельны полу, спина прямая</div>
                    </div>
                    
                    <!-- Тест выбора спортивных предпочтений -->
                    <div class="form-group mt-4">
                        <label class="form-label">Какие виды активности вам больше нравятся? (можно выбрать несколько)</label>
                        <div class="test-grid" id="sportPreferences">
                            <button class="test-option-btn" data-value="team">Командные игры</button>
                            <button class="test-option-btn" data-value="strength">Силовые</button>
                            <button class="test-option-btn" data-value="endurance">Выносливость</button>
                            <button class="test-option-btn" data-value="coordination">Координация</button>
                            <button class="test-option-btn" data-value="water">Водные виды</button>
                            <button class="test-option-btn" data-value="martial">Боевые искусства</button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="caption mb-1">Уровень подготовки:</div>
                        <div class="stat-value" id="fitnessLevel">Не определен</div>
                        <div class="text-muted mt-1" id="fitnessDescription"></div>
                    </div>
                    
                    <div class="d-flex gap-3 mt-4">
                        <button class="btn" onclick="SportAI.onboardingPrev()">
                            ← Назад
                        </button>
                        <button class="btn btn-primary btn-block" onclick="SportAI.completeOnboarding()">
                            Завершить настройку
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sport Details Modal -->
        <div class="sport-details-modal" id="sportDetailsModal">
            <div class="sport-details-header">
                <button class="btn btn-sm" onclick="SportAI.closeSportDetails()" style="background: var(--bg-tertiary); border-color: var(--border-light);">
                    ← Назад к спортам
                </button>
                <h2 class="h2" id="sportDetailsTitle">Название спорта</h2>
            </div>
            
            <div class="sport-details-content">
                <!-- Для зала показываем переключатель целей -->
                <div class="gym-goal-selector d-none" id="gymGoalSelector">
                    <button class="goal-btn active" data-goal="muscle">Набор мышц</button>
                    <button class="goal-btn" data-goal="shape">Форма и рельеф</button>
                </div>
                
                <!-- Тренировки с AI генерацией -->
                <div class="sport-details-section">
                    <div class="d-flex justify-center align-center gap-4 mb-3">
                        <h3 class="h3">Тренировочная программа</h3>
                        <button class="btn ai-generate-btn btn-sm" onclick="SportAI.generateWorkout()">
                            <svg class="icon-btn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 18V22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 4.93L7.76 7.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 16.24L19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M2 12H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M18 12H22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 19.07L7.76 16.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 7.76L19.07 4.93" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Сгенерировать ИИ
                        </button>
                    </div>
                    <div class="ai-loading" id="workoutLoading">
                        <div class="spinner"></div>
                        <span>ИИ создает тренировку...</span>
                    </div>
                    <ul class="workout-list" id="workoutList">
                        <!-- Заполняется JavaScript -->
                    </ul>
                </div>
                
                <!-- Питание -->
                <div class="sport-details-section">
                    <h3 class="h3">Питание и КБЖУ</h3>
                    <div class="nutrition-grid" id="nutritionGrid">
                        <!-- Заполняется JavaScript -->
                    </div>
                    <div class="mt-3">
                        <strong>Рекомендации по питанию:</strong>
                        <div id="nutritionTips"></div>
                    </div>
                </div>
                
                <!-- Добавки с AI генерацией -->
                <div class="sport-details-section">
                    <div class="d-flex justify-center align-center gap-4 mb-3">
                        <h3 class="h3">Добавки и БАДы</h3>
                        <button class="btn ai-generate-btn btn-sm" onclick="SportAI.generateSupplements()">
                            <svg class="icon-btn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 18V22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 4.93L7.76 7.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 16.24L19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M2 12H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M18 12H22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 19.07L7.76 16.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 7.76L19.07 4.93" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Подобрать ИИ
                        </button>
                    </div>
                    <div class="ai-loading" id="supplementsLoading">
                        <div class="spinner"></div>
                        <span>ИИ подбирает добавки...</span>
                    </div>
                    <div class="supplements-categories" id="supplementsCategories">
                        <!-- Заполняется JavaScript -->
                    </div>
                    <div class="disclaimer">
                        <strong>Важно:</strong> Перед приемом любых добавок проконсультируйтесь с врачом. 
                        Данные рекомендации носят ознакомительный характер.
                    </div>
                </div>

                <!-- Кнопка отметки тренировки -->
                <button class="btn btn-primary mark-workout-btn" onclick="SportAI.markWorkoutToday()">
                    <svg class="icon-btn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Отметить тренировку сегодня
                </button>
            </div>
        </div>

        <!-- Calendar Modal -->
        <div class="calendar-modal" id="calendarModal">
            <div class="calendar-modal-header">
                <button class="btn btn-sm" onclick="SportAI.closeCalendarModal()" style="background: var(--bg-tertiary); border-color: var(--border-light);">
                    ← Назад
                </button>
                <h2 class="h2" id="calendarModalTitle">Календарь тренировок</h2>
            </div>
            
            <div class="calendar-modal-content">
                <div class="calendar-modal-day" id="calendarDayInfo">
                    <!-- Заполняется JavaScript -->
                </div>
            </div>
        </div>

        <!-- Main App (Hidden until onboarding complete) -->
        <div id="mainApp" class="d-none">
            <!-- Header -->
            <header class="header">
                <div class="logo">
                    <svg class="logo-icon" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 3C9.72 3 3 9.72 3 18C3 26.28 9.72 33 18 33C26.28 33 33 26.28 33 18C33 9.72 26.28 3 18 3Z" stroke="currentColor" stroke-width="2.5"/>
                        <path d="M18 24C21.3137 24 24 21.3137 24 18C24 14.6863 21.3137 12 18 12C14.6863 12 12 14.6863 12 18C12 21.3137 14.6863 24 18 24Z" stroke="currentColor" stroke-width="2.5"/>
                        <path d="M18 30C23.5228 30 28 25.5228 28 20C28 14.4772 23.5228 10 18 10C12.4772 10 8 14.4772 8 20C8 25.5228 12.4772 30 18 30Z" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span class="logo-text">SportAI Pro</span>
                </div>
                
                <div class="header-actions">
                    <div class="ai-trainer-btn" onclick="SportAI.toggleChat()" title="ИИ-Тренер">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 11.5C21 16.7467 16.7467 21 11.5 21C6.25329 21 2 16.7467 2 11.5C2 6.25329 6.25329 2 11.5 2C16.7467 2 21 6.25329 21 11.5Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M8 9H15M8 13H12M17.5 15L15.5 17L12.5 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="profile-btn-header" onclick="SportAI.showSection('profile')" title="Профиль">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 12C14.2091 12 16 10.2091 16 8C16 5.79086 14.2091 4 12 4C9.79086 4 8 5.79086 8 8C8 10.2091 9.79086 12 12 12Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main">
                <!-- Home Section -->
                <section id="home" class="section active">
                    <!-- Welcome Section -->
                    <div class="welcome-section">
                        <div class="greeting" id="greetingText">Доброе утро!</div>
                        <p class="subtitle">Ваши рекомендации на сегодня</p>
                    </div>

                    <!-- Mini Calendar -->
                    <div class="card">
                        <div class="calendar-mini">
                            <div class="calendar-header">
                                <div class="calendar-title" id="calendarMonthTitle">Январь 2025</div>
                                <div class="calendar-nav">
                                    <button class="calendar-nav-btn" onclick="SportAI.changeCalendarMonth(-1)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                    <button class="calendar-nav-btn" onclick="SportAI.changeCalendarMonth(1)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="miniCalendar">
                                <!-- Заполняется JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Time-Based Section -->
                    <div class="time-based-section">
                        <div class="time-indicator" id="timeIndicator">
                            <svg class="time-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span id="timePeriod">Утренние рекомендации</span>
                        </div>
                        
                        <div class="today-recommendations" id="todayRecommendations">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>

                    <!-- Favorite Sport -->
                    <div class="favorite-sport" id="favoriteSportSection">
                        <!-- Filled by JavaScript -->
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <h3 class="h3">Быстрые действия</h3>
                        <div class="d-flex gap-3 mt-2">
                            <button class="btn btn-primary" onclick="SportAI.showSection('analysis')">
                                <svg class="icon-btn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 21H13V15H21V21ZM11 21H3V11H11V21ZM21 13H13V3H21V13ZM11 9H3V3H11V9Z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Анализ
                            </button>
                            <button class="btn" onclick="SportAI.showSection('sports')">
                                <svg class="icon-btn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 8V16M8 12H16" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Виды спорта
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Sports Section -->
                <section id="sports" class="section">
                    <div class="card">
                        <h2 class="h2">Рекомендованные виды спорта</h2>
                        <p class="subtitle">Нажмите на карточку для получения подробной программы. Звездочка - добавить в избранное.</p>
                        
                        <div class="sports-grid" id="sportsGrid">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>
                </section>

                <!-- Analysis Section -->
                <section id="analysis" class="section">
                    <div class="card">
                        <h2 class="h2">Анализ и тестирование</h2>
                        <p class="subtitle">Обновите данные или пройдите тесты заново</p>
                        
                        <div class="analysis-tabs">
                            <button class="analysis-tab active" onclick="SportAI.showAnalysisTab('data')">Данные</button>
                            <button class="analysis-tab" onclick="SportAI.showAnalysisTab('tests')">Тесты</button>
                            <button class="analysis-tab" onclick="SportAI.showAnalysisTab('results')">Результаты</button>
                        </div>
                        
                        <!-- Data Tab -->
                        <div class="analysis-content active" id="analysisData">
                            <div class="form-group">
                                <label class="form-label">Рост (см)</label>
                                <input type="number" class="form-input" id="updateHeight" placeholder="175">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Вес (кг)</label>
                                <input type="number" class="form-input" id="updateWeight" placeholder="70">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <label class="form-label">Обхват запястья (см)</label>
                                    <input type="number" class="form-input" id="updateWrist" step="0.1" placeholder="16.5">
                                </div>
                                <div class="form-col">
                                    <label class="form-label">Обхват щиколотки (см)</label>
                                    <input type="number" class="form-input" id="updateAnkle" step="0.1" placeholder="22.5">
                                </div>
                            </div>
                            
                            <button class="btn btn-primary btn-block mt-3" onclick="SportAI.updateUserData()">
                                Обновить данные и пересчитать питание
                            </button>
                        </div>
                        
                        <!-- Tests Tab -->
                        <div class="analysis-content" id="analysisTests">
                            <div class="card">
                                <h3 class="h3">Тест на реакцию</h3>
                                <p class="subtitle">Проверьте скорость реакции</p>
                                <button class="btn btn-block mt-3" onclick="SportAI.startReactionTest()">
                                    Пройти тест заново
                                </button>
                            </div>
                            
                            <div class="card mt-3">
                                <h3 class="h3">Тест с весом тела</h3>
                                <p class="subtitle">Обновите свои рекорды</p>
                                
                                <div class="form-group mt-3">
                                    <label class="form-label">Отжимания (раз)</label>
                                    <input type="number" class="form-input" id="updatePushups" placeholder="0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Планка (секунд)</label>
                                    <input type="number" class="form-input" id="updatePlank" placeholder="0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Подтягивания (раз)</label>
                                    <input type="number" class="form-input" id="updatePullups" placeholder="0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Приседания за минуту (раз)</label>
                                    <input type="number" class="form-input" id="updateSquats" placeholder="0">
                                </div>
                                
                                <button class="btn btn-primary btn-block mt-3" onclick="SportAI.updateBodyweightTest()">
                                    Обновить рекорды
                                </button>
                            </div>
                        </div>
                        
                        <!-- Results Tab -->
                        <div class="analysis-content" id="analysisResults">
                            <div class="test-stats">
                                <div class="stat-box">
                                    <div class="stat-value" id="analysisReaction">-</div>
                                    <div class="stat-label">Скорость реакции</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="analysisStrength">-</div>
                                    <div class="stat-label">Уровень силы</div>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <h3 class="h3">Соматотип</h3>
                                <div class="stat-value mt-1" id="analysisBodyType">Не определен</div>
                                <div class="text-muted mt-1" id="analysisBodyTypeDesc"></div>
                            </div>
                            
                            <div class="card mt-3">
                                <h3 class="h3">Индекс массы тела (BMI)</h3>
                                <div class="stat-value mt-1" id="analysisBmi">-</div>
                                <div class="text-muted mt-1" id="analysisBmiCategory"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Profile Section -->
                <section id="profile" class="section">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">
                            U
                        </div>
                        <div class="profile-info">
                            <div class="profile-name" id="profileName">Пользователь</div>
                            <div class="profile-meta">
                                <div id="profileAge">Возраст не указан</div>
                                <div id="profileGender">Пол не указан</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="profile-stat-card">
                            <div class="profile-stat-value" id="profileBmi">-</div>
                            <div class="caption">Индекс массы тела</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="profile-stat-value" id="profileBodyType">-</div>
                            <div class="caption">Соматотип</div>
                        </div>
                    </div>
                    
                    <div class="personal-records">
                        <h3 class="h3">Личные рекорды</h3>
                        <p class="subtitle">Ваши лучшие результаты в тестах</p>
                        
                        <div class="record-list" id="personalRecords">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <button class="btn btn-block" onclick="SportAI.resetApp()">
                            <svg class="icon-btn" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 18V22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 4.93L7.76 7.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 16.24L19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M2 12H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M18 12H22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 19.07L7.76 16.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 7.76L19.07 4.93" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Сбросить и начать заново
                        </button>
                    </div>
                </section>
            </main>

            <!-- Navigation -->
            <nav class="nav">
                <button class="nav-btn active" onclick="SportAI.showSection('home')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Главная
                </button>
                <button class="nav-btn" onclick="SportAI.showSection('sports')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 8V16M8 12H16" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Спорт
                </button>
                <button class="nav-btn" onclick="SportAI.showSection('analysis')">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 21H13V15H21V21ZM11 21H3V11H11V21ZM21 13H13V3H21V13ZM11 9H3V3H11V9Z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Анализ
                </button>
            </nav>
        </div>
    </div>

    <script>
        /**
         * SportAI Pro - Enhanced Version with Telegram CloudStorage & Calendar & AI Trainer
         * Версия 8.0: Интеграция с LM Studio API для ИИ-тренера
         */

        // Конфигурация LM Studio API
        const LM_STUDIO_CONFIG = {
            endpoint: 'http://127.0.0.1:1234/v1/chat/completions',
            model: 'mistralai/mistral-3-3b',
            temperature: 0.3,
            max_tokens: 1000
        };

        // Проверяем наличие Telegram WebApp
        const isTelegramApp = typeof window.Telegram !== 'undefined' && 
                              typeof window.Telegram.WebApp !== 'undefined' &&
                              typeof window.Telegram.WebApp.CloudStorage !== 'undefined';

        // Конфигурация тренировочных дней (Пн, Ср, Пт - тренировки, остальное - отдых)
        const TRAINING_SCHEDULE = {
            workoutDays: [1, 3, 5], // Пн=1, Ср=3, Пт=5
            workoutTime: "18:00-20:00",
            restDays: [0, 2, 4, 6]  // Вс=0, Вт=2, Чт=4, Сб=6
        };

        // База данных спорта с адаптивными тренировками
        const SPORTS_DATABASE = {
            football: {
                id: 'football',
                name: 'Футбол',
                description: 'Командная игра, кардио, выносливость',
                icon: '<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2"/><path d="M20 8V32M32 20H8M28 12L12 28M28 28L12 12" stroke="currentColor" stroke-width="2"/></svg>',
                category: 'team',
                activityMultiplier: 1.725,
                nutritionFormula: {
                    proteinPerKg: 1.6,
                    carbsPerKg: 6,
                    fatPerKg: 1,
                    calorieSurplus: 0.15
                },
                workouts: [
                    { 
                        name: 'Бег с ускорениями', 
                        sets: '4-6', 
                        reps: '30-40 метров', 
                        rest: '90 секунд',
                        tip: 'Сосредоточьтесь на максимальном ускорении в первые 10 метров'
                    },
                    { 
                        name: 'Прыжки на тумбу', 
                        sets: '3-4', 
                        reps: '10-12 повторений', 
                        rest: '60 секунд',
                        tip: 'Приземляйтесь мягко, сгибая колени для амортизации'
                    },
                    { 
                        name: 'Приседания с весом', 
                        sets: '4', 
                        reps: '12-15 повторений', 
                        rest: '90 секунд',
                        tip: 'Держите спину прямой, колени не выходят за носки'
                    },
                    { 
                        name: 'Выпады с гантелями', 
                        sets: '3', 
                        reps: '12-15 на каждую ногу', 
                        rest: '60 секунд',
                        tip: 'Делайте широкий шаг для лучшей проработки ягодичных мышц'
                    },
                    { 
                        name: 'Планка с поднятием ноги', 
                        sets: '3', 
                        reps: '30-45 секунд', 
                        rest: '30 секунд',
                        tip: 'Держите корпус напряженным, избегайте провисания таза'
                    }
                ],
                supplements: [
                    { 
                        name: 'BCAA', 
                        description: 'Снижает мышечную усталость, ускоряет восстановление после интенсивных тренировок',
                        category: 'recovery'
                    },
                    { 
                        name: 'Электролиты', 
                        description: 'Восполняют потерю солей при интенсивном потоотделении, предотвращают судороги',
                        category: 'energy'
                    },
                    { 
                        name: 'Омега-3', 
                        description: 'Уменьшает воспаление, поддерживает здоровье суставов и сердечно-сосудистой системы',
                        category: 'essential'
                    },
                    { 
                        name: 'Коллаген', 
                        description: 'Укрепляет связки и суставы, снижает риск травм',
                        category: 'essential'
                    }
                ]
            },
            basketball: {
                id: 'basketball',
                name: 'Баскетбол',
                description: 'Координация, прыжки, скорость',
                icon: '<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2"/><path d="M20 12V28M12 20H28" stroke="currentColor" stroke-width="2"/><circle cx="20" cy="20" r="6" stroke="currentColor" stroke-width="2"/></svg>',
                category: 'team',
                activityMultiplier: 1.725,
                nutritionFormula: {
                    proteinPerKg: 1.7,
                    carbsPerKg: 5.5,
                    fatPerKg: 1,
                    calorieSurplus: 0.15
                },
                workouts: [
                    { 
                        name: 'Приседания со штангой', 
                        sets: '4', 
                        reps: '8-10 повторений', 
                        rest: '120 секунд',
                        tip: 'Опускайтесь до параллели бедер с полом, сохраняя нейтральное положение позвоночника'
                    },
                    { 
                        name: 'Выпады с гантелями', 
                        sets: '3', 
                        reps: '10-12 на каждую ногу', 
                        rest: '90 секунд',
                        tip: 'Колено передней ноги не должно выходить за носок'
                    },
                    { 
                        name: 'Подъемы на носки', 
                        sets: '4', 
                        reps: '15-20 повторений', 
                        rest: '60 секунд',
                        tip: 'В верхней точке задержитесь на 1-2 секунды для максимального сокращения икр'
                    },
                    { 
                        name: 'Прыжки на тумбу', 
                        sets: '4', 
                        reps: '8-10 повторений', 
                        rest: '90 секунд',
                        tip: 'Используйте взмах руками для увеличения высоты прыжка'
                    },
                    { 
                        name: 'Берпи', 
                        sets: '3', 
                        reps: '10-12 повторений', 
                        rest: '60 секунд',
                        tip: 'Сохраняйте высокий темп, но следите за техникой'
                    }
                ],
                supplements: [
                    { 
                        name: 'Креатин', 
                        description: 'Увеличивает взрывную силу и мощность прыжка, улучшает силовые показатели',
                        category: 'energy'
                    },
                    { 
                        name: 'Бета-аланин', 
                        description: 'Повышает выносливость, уменьшает мышечную усталость во время интенсивных нагрузок',
                        category: 'energy'
                    },
                    { 
                        name: 'Цитруллин малат', 
                        description: 'Улучшает кровоток и доставку кислорода к мышцам, уменьшает мышечную боль',
                        category: 'recovery'
                    },
                    { 
                        name: 'Витамин С', 
                        description: 'Укрепляет иммунитет, особенно важно в периоды интенсивных тренировок',
                        category: 'essential'
                    }
                ]
            },
            volleyball: {
                id: 'volleyball',
                name: 'Волейбол',
                description: 'Реакция, команда, прыгучесть',
                icon: '<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2"/><path d="M12 16L28 24M28 16L12 24M20 10V30" stroke="currentColor" stroke-width="2"/></svg>',
                category: 'team',
                activityMultiplier: 1.725,
                nutritionFormula: {
                    proteinPerKg: 1.6,
                    carbsPerKg: 5,
                    fatPerKg: 1,
                    calorieSurplus: 0.15
                },
                workouts: [
                    { 
                        name: 'Жим штанги стоя', 
                        sets: '4', 
                        reps: '8-10 повторений', 
                        rest: '90 секунд',
                        tip: 'Не выгибайте спину, держите корпус напряженным'
                    },
                    { 
                        name: 'Тяга штанги к подбородку', 
                        sets: '3', 
                        reps: '10-12 повторений', 
                        rest: '60 секунд',
                        tip: 'Локти поднимайте выше плеч для максимальной проработки дельт'
                    },
                    { 
                        name: 'Прыжки из приседа', 
                        sets: '4', 
                        reps: '8-10 повторений', 
                        rest: '90 секунд',
                        tip: 'Приземляйтесь мягко, сразу уходя в следующий прыжок'
                    },
                    { 
                        name: 'Отжимания на брусьях', 
                        sets: '3', 
                        reps: '10-12 повторений', 
                        rest: '60 секунд',
                        tip: 'Наклон корпуса вперед смещает нагрузку на грудные мышцы'
                    },
                    { 
                        name: 'Планка с поворотами', 
                        sets: '3', 
                        reps: '30-45 секунд', 
                        rest: '30 секунд',
                        tip: 'Поворачивайте корпус медленно, контролируя каждое движение'
                    }
                ],
                supplements: [
                    { 
                        name: 'Глюкозамин + Хондроитин', 
                        description: 'Поддерживает здоровье суставов, особенно важно для прыжковых видов спорта',
                        category: 'essential'
                    },
                    { 
                        name: 'MSM (Метилсульфонилметан)', 
                        description: 'Уменьшает воспаление в суставах, ускоряет восстановление',
                        category: 'recovery'
                    },
                    { 
                        name: 'Магний', 
                        description: 'Снижает мышечные спазмы, улучшает качество сна и восстановления',
                        category: 'essential'
                    },
                    { 
                        name: 'Витамин D3', 
                        description: 'Укрепляет кости, поддерживает иммунную систему, особенно при тренировках в зале',
                        category: 'essential'
                    }
                ]
            },
            gym: {
                id: 'gym',
                name: 'Тренажерный зал',
                description: 'Сила, здоровье, эстетика',
                icon: '<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="8" y="8" width="24" height="24" rx="4" stroke="currentColor" stroke-width="2"/><path d="M16 12V28M24 12V28M12 16H28M12 24H28" stroke="currentColor" stroke-width="2"/></svg>',
                category: 'strength',
                goals: {
                    muscle: {
                        name: 'Набор мышечной массы',
                        activityMultiplier: 1.55,
                        nutritionFormula: {
                            proteinPerKg: 2.2,
                            carbsPerKg: 4,
                            fatPerKg: 1,
                            calorieSurplus: 0.20
                        },
                        baseWorkouts: [
                            { 
                                name: 'Жим штанги лежа', 
                                sets: '4', 
                                reps: '8-10 повторений', 
                                rest: '120 секунд',
                                tip: 'Сводите лопатки, создавая устойчивую опору на скамье',
                                requiresBarbell: true
                            },
                            { 
                                name: 'Приседания со штангой', 
                                sets: '4', 
                                reps: '8-10 повторений', 
                                rest: '120 секунд',
                                tip: 'Держите грудь расправленной, смотрите вперед, а не вниз',
                                requiresBarbell: true
                            },
                            { 
                                name: 'Тяга штанги в наклоне', 
                                sets: '4', 
                                reps: '8-10 повторений', 
                                rest: '120 секунд',
                                tip: 'Сохраняйте естественный прогиб в пояснице на протяжении всего движения',
                                requiresBarbell: true
                            },
                            { 
                                name: 'Армейский жим', 
                                sets: '3', 
                                reps: '8-10 повторений', 
                                rest: '90 секунд',
                                tip: 'В нижней точке штанга должна касаться ключиц, в верхней - полностью выпрямляйте руки',
                                requiresBarbell: true
                            },
                            { 
                                name: 'Подтягивания широким хватом', 
                                sets: '3', 
                                reps: '6-8 повторений', 
                                rest: '90 секунд',
                                tip: 'В верхней точке старайтесь коснуться перекладины грудью, а не подбородком',
                                requiresBarbell: false
                            }
                        ],
                        adaptiveWorkouts: [
                            { 
                                name: 'Жим гантелей лежа', 
                                sets: '4', 
                                reps: '10-12 повторений', 
                                rest: '90 секунд',
                                tip: 'Используйте гантели для лучшей амплитуды движения',
                                adaptiveNote: 'Вместо штанги используйте гантели'
                            },
                            { 
                                name: 'Приседания с собственным весом + выпрыгивания', 
                                sets: '4', 
                                reps: '15-20 повторений', 
                                rest: '60 секунд',
                                tip: 'После каждого приседа делайте максимально высокий прыжок',
                                adaptiveNote: 'Адаптировано для новичков вместо штанги'
                            },
                            { 
                                name: 'Тяга гантелей в наклоне', 
                                sets: '4', 
                                reps: '10-12 повторений', 
                                rest: '90 секунд',
                                tip: 'Держите спину параллельно полу, тяните гантели к поясу',
                                adaptiveNote: 'Используйте гантели вместо штанги'
                            },
                            { 
                                name: 'Жим гантелей стоя', 
                                sets: '3', 
                                reps: '10-12 повторений', 
                                rest: '60 секунд',
                                tip: 'Начинайте с легких гантелей, фокусируйтесь на технике',
                                adaptiveNote: 'Адаптированная версия армейского жима'
                            },
                            { 
                                name: 'Австралийские подтягивания', 
                                sets: '3', 
                                reps: '10-15 повторений', 
                                rest: '60 секунд',
                                tip: 'Чем выше перекладина, тем легче выполнять упражнение',
                                adaptiveNote: 'Для тех, кто не может подтягиваться'
                            }
                        ],
                        supplements: [
                            { 
                                name: 'Сывороточный протеин', 
                                description: 'Быстро усваиваемый белок для синтеза мышц после тренировки',
                                category: 'essential'
                            },
                            { 
                                name: 'Креатин моногидрат', 
                                description: 'Увеличивает силу, мощность и мышечную массу, улучшает гидратацию клеток',
                                category: 'energy'
                            },
                            { 
                                name: 'BCAA', 
                                description: 'Снижает катаболизм, ускоряет восстановление между тренировками',
                                category: 'recovery'
                            },
                            { 
                                name: 'Цинк + Магний + B6 (ZMA)', 
                                description: 'Улучшает качество сна, повышает уровень тестостерона',
                                category: 'recovery'
                            }
                        ]
                    },
                    shape: {
                        name: 'Форма и рельеф',
                        activityMultiplier: 1.55,
                        nutritionFormula: {
                            proteinPerKg: 2.2,
                            carbsPerKg: 2.5,
                            fatPerKg: 0.8,
                            calorieSurplus: 0
                        },
                        baseWorkouts: [
                            { 
                                name: 'Суперсет: бицепс + трицепс', 
                                sets: '3', 
                                reps: '12-15 повторений', 
                                rest: '60 секунд',
                                tip: 'Выполняйте упражнения на бицепс и трицепс без отдыха между ними',
                                requiresBarbell: false
                            },
                            { 
                                name: 'Кардио на беговой дорожке', 
                                sets: '1', 
                                reps: '30-40 минут', 
                                rest: '0',
                                tip: 'Поддерживайте пульс в зоне 60-70% от максимального',
                                requiresBarbell: false
                            },
                            { 
                                name: 'Планка с вариациями', 
                                sets: '3', 
                                reps: '60 секунд', 
                                rest: '30 секунд',
                                tip: 'Чередуйте классическую планку, боковую и планку с поднятием ноги',
                                requiresBarbell: false
                            },
                            { 
                                name: 'Выпады с гантелями', 
                                sets: '3', 
                                reps: '12-15 на каждую ногу', 
                                rest: '60 секунд',
                                tip: 'Сделайте паузу в нижней точке для максимального растяжения мышц',
                                requiresBarbell: false
                            },
                            { 
                                name: 'Жим гантелей на наклонной скамье', 
                                sets: '3', 
                                reps: '12-15 повторений', 
                                rest: '60 секунд',
                                tip: 'Угол наклона 30-45 градусов лучше всего прорабатывает верх груди',
                                requiresBarbell: false
                            }
                        ],
                        adaptiveWorkouts: [
                            { 
                                name: 'Суперсет: бицепс + трицепс', 
                                sets: '3', 
                                reps: '12-15 повторений', 
                                rest: '60 секунд',
                                tip: 'Начните с легких весов, фокусируйтесь на ощущении работы мышц'
                            },
                            { 
                                name: 'Кардио на беговой дорожке', 
                                sets: '1', 
                                reps: '30-40 минут', 
                                rest: '0',
                                tip: 'Начните с ходьбы, постепенно увеличивая скорость'
                            },
                            { 
                                name: 'Планка с вариациями', 
                                sets: '3', 
                                reps: '60 секунд', 
                                rest: '30 секунд',
                                tip: 'Если сложно - начните с 30 секунд и постепенно увеличивайте время'
                            },
                            { 
                                name: 'Выпады с гантелями', 
                                sets: '3', 
                                reps: '12-15 на каждую ногу', 
                                rest: '60 секунд',
                                tip: 'Начните без веса, затем добавьте легкие гантели'
                            },
                            { 
                                name: 'Жим гантелей на наклонной скамье', 
                                sets: '3', 
                                reps: '12-15 повторений', 
                                rest: '60 секунд',
                                tip: 'Начните с легких гантелей, постепенно увеличивайте вес'
                            }
                        ],
                        supplements: [
                            { 
                                name: 'L-карнитин', 
                                description: 'Помогает транспортировать жирные кислоты в митохондрии для сжигания',
                                category: 'energy'
                            },
                            { 
                                name: 'Зеленый чай экстракт', 
                                description: 'Ускоряет метаболизм, обладает антиоксидантными свойствами',
                                category: 'essential'
                            },
                            { 
                                name: 'Омега-3', 
                                description: 'Снижает воспаление, улучшает чувствительность к инсулину',
                                category: 'essential'
                            },
                            { 
                                name: 'Витаминно-минеральный комплекс', 
                                description: 'Восполняет дефициты при снижении калорийности рациона',
                                category: 'essential'
                            }
                        ]
                    }
                }
            }
        };

        class SportAIPro {
            constructor() {
                this.state = {
                    userData: {},
                    testResults: { reaction: [], bodyweight: {} },
                    preferences: [],
                    favorites: [],
                    hasCompletedOnboarding: false,
                    theme: 'dark',
                    currentSportDetails: null,
                    currentGymGoal: 'muscle',
                    lastWorkoutDate: null,
                    todayWorkoutCompleted: false,
                    workoutHistory: {}, // История тренировок по датам
                    calendarCurrentMonth: new Date().getMonth(),
                    calendarCurrentYear: new Date().getFullYear(),
                    chatHistory: [] // История чата с ИИ
                };
                
                this.currentOnboardingStep = 1;
                this.reactionTest = null;
                this.reactionTimeouts = [];
                this.isTelegram = isTelegramApp;
                
                this.init();
            }
            
            async init() {
                // Инициализация Telegram WebApp
                if (this.isTelegram) {
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                }
                
                // Загрузка данных из CloudStorage или localStorage
                await this.loadState();
                this.checkOnboarding();
                this.setupEventListeners();
                this.initTimeBasedContent();
                this.checkWorkoutStatus();
                this.initMiniCalendar();
                this.setupChatInput();
            }
            
            // Асинхронное сохранение данных в Telegram CloudStorage или localStorage
            async saveState() {
                const stateString = JSON.stringify(this.state);
                
                if (this.isTelegram) {
                    try {
                        // Сохраняем в Telegram CloudStorage
                        await window.Telegram.WebApp.CloudStorage.setItem('sportAIState', stateString);
                        console.log('Данные сохранены в Telegram CloudStorage');
                    } catch (error) {
                        console.error('Ошибка сохранения в Telegram CloudStorage:', error);
                        // Fallback на localStorage
                        localStorage.setItem('sportAIState', stateString);
                    }
                } else {
                    // Fallback на localStorage для браузера
                    localStorage.setItem('sportAIState', stateString);
                    localStorage.setItem('user_tested', 'true');
                }
            }
            
            // Асинхронная загрузка данных из Telegram CloudStorage или localStorage
            async loadState() {
                try {
                    let savedData = null;
                    
                    if (this.isTelegram) {
                        // Пытаемся загрузить из Telegram CloudStorage
                        const cloudData = await window.Telegram.WebApp.CloudStorage.getItem('sportAIState');
                        if (cloudData) {
                            savedData = JSON.parse(cloudData);
                            console.log('Данные загружены из Telegram CloudStorage');
                        }
                    }
                    
                    // Если в CloudStorage нет данных, пробуем localStorage
                    if (!savedData) {
                        const localData = localStorage.getItem('sportAIState');
                        if (localData) {
                            savedData = JSON.parse(localData);
                            console.log('Данные загружены из localStorage');
                        }
                    }
                    
                    if (savedData) {
                        // Мерджим состояния, сохраняя новые поля
                        this.state = { 
                            ...this.state, 
                            ...savedData,
                            // Убедимся, что новые поля инициализированы
                            workoutHistory: savedData.workoutHistory || {},
                            calendarCurrentMonth: savedData.calendarCurrentMonth !== undefined ? 
                                savedData.calendarCurrentMonth : new Date().getMonth(),
                            calendarCurrentYear: savedData.calendarCurrentYear !== undefined ? 
                                savedData.calendarCurrentYear : new Date().getFullYear(),
                            chatHistory: savedData.chatHistory || []
                        };
                    }
                } catch (e) {
                    console.error('Ошибка загрузки данных:', e);
                }
            }
            
            checkOnboarding() {
                if (this.state.hasCompletedOnboarding) {
                    document.getElementById('onboarding').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('d-none');
                    this.updateHomeContent();
                    this.updateProfile();
                    this.updateSportsGrid();
                } else {
                    document.getElementById('onboarding').classList.remove('hidden');
                    document.getElementById('mainApp').classList.add('d-none');
                    this.showOnboardingStep(1);
                }
            }
            
            checkWorkoutStatus() {
                const today = new Date().toDateString();
                if (this.state.lastWorkoutDate === today) {
                    this.state.todayWorkoutCompleted = true;
                } else {
                    this.state.todayWorkoutCompleted = false;
                }
            }
            
            markWorkoutToday() {
                const today = new Date();
                const todayString = today.toDateString();
                
                // Сохраняем дату последней тренировки
                this.state.lastWorkoutDate = todayString;
                this.state.todayWorkoutCompleted = true;
                
                // Добавляем в историю тренировок
                if (!this.state.workoutHistory[todayString]) {
                    this.state.workoutHistory[todayString] = {
                        date: todayString,
                        sport: this.state.currentSportDetails,
                        completed: true
                    };
                }
                
                this.saveState();
                
                // Обновляем вечерние рекомендации и календарь
                this.updateTimeBasedContent();
                this.initMiniCalendar();
                
                alert('Тренировка отмечена! Рекомендации обновлены.');
                this.closeSportDetails();
            }
            
            setupEventListeners() {
                // Настройка кнопок выбора предпочтений
                document.querySelectorAll('.test-option-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        btn.classList.toggle('selected');
                        const value = btn.dataset.value;
                        const index = this.state.preferences.indexOf(value);
                        
                        if (index > -1) {
                            this.state.preferences.splice(index, 1);
                        } else {
                            this.state.preferences.push(value);
                        }
                    });
                });

                // Настройка переключателя целей для зала
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('goal-btn')) {
                        const goal = e.target.dataset.goal;
                        this.state.currentGymGoal = goal;
                        
                        // Обновляем активную кнопку
                        document.querySelectorAll('.goal-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        
                        // Обновляем детали для зала
                        if (this.state.currentSportDetails === 'gym') {
                            this.showSportDetails('gym');
                        }
                    }
                });
            }
            
            setupChatInput() {
                const chatInput = document.getElementById('chatInput');
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }
            
            onboardingNext() {
                if (this.currentOnboardingStep === 2 && !this.validateBasicData()) {
                    return;
                }
                
                this.currentOnboardingStep++;
                if (this.currentOnboardingStep <= 4) {
                    this.showOnboardingStep(this.currentOnboardingStep);
                }
            }
            
            onboardingPrev() {
                this.currentOnboardingStep = Math.max(1, this.currentOnboardingStep - 1);
                this.showOnboardingStep(this.currentOnboardingStep);
            }
            
            showOnboardingStep(step) {
                document.querySelectorAll('.onboarding-step').forEach(stepEl => {
                    stepEl.classList.remove('active');
                });
                document.querySelectorAll('.progress-step').forEach((stepEl, index) => {
                    stepEl.classList.toggle('active', index < step);
                });
                
                document.getElementById(`onboardingStep${step}`).classList.add('active');
            }
            
            validateBasicData() {
                const age = document.getElementById('age').value;
                const gender = document.getElementById('gender').value;
                const height = document.getElementById('height').value;
                const weight = document.getElementById('weight').value;
                const wrist = document.getElementById('wrist').value;
                const ankle = document.getElementById('ankle').value;
                
                if (!age || !gender || !height || !weight || !wrist || !ankle) {
                    alert('Пожалуйста, заполните все поля');
                    return false;
                }
                
                this.state.userData = {
                    age: parseInt(age),
                    gender: gender,
                    height: parseInt(height),
                    weight: parseInt(weight),
                    wrist: parseFloat(wrist),
                    ankle: parseFloat(ankle)
                };
                
                return true;
            }
            
            // Метод расчета BMR по формуле Миффлина-Сан Жеора
            calculateBMR() {
                const { age, gender, height, weight } = this.state.userData;
                
                if (!age || !gender || !height || !weight) {
                    return null;
                }
                
                if (gender === 'male') {
                    return (10 * weight) + (6.25 * height) - (5 * age) + 5;
                } else {
                    return (10 * weight) + (6.25 * height) - (5 * age) - 161;
                }
            }
            
            // Расчет TDEE с учетом уровня активности
            calculateTDEE(activityMultiplier = 1.55) {
                const bmr = this.calculateBMR();
                if (!bmr) return null;
                
                return Math.round(bmr * activityMultiplier);
            }
            
            // Расчет калорий для конкретного вида спорта
            calculateSportCalories(sportId, goal = null) {
                const tdee = this.calculateTDEE();
                if (!tdee) return null;
                
                let sportData = SPORTS_DATABASE[sportId];
                
                if (!sportData) return null;
                
                let formula;
                let activityMultiplier;
                
                if (sportId === 'gym' && goal) {
                    formula = sportData.goals[goal].nutritionFormula;
                    activityMultiplier = sportData.goals[goal].activityMultiplier;
                } else {
                    formula = sportData.nutritionFormula;
                    activityMultiplier = sportData.activityMultiplier;
                }
                
                if (!formula) return null;
                
                const adjustedTDEE = this.calculateTDEE(activityMultiplier);
                const calories = Math.round(adjustedTDEE * (1 + formula.calorieSurplus));
                
                return {
                    calories: calories,
                    protein: Math.round(formula.proteinPerKg * this.state.userData.weight),
                    carbs: Math.round(formula.carbsPerKg * this.state.userData.weight),
                    fat: Math.round(formula.fatPerKg * this.state.userData.weight)
                };
            }
            
            // Расчет рекомендуемого веса гантелей
            calculateDumbbellWeight() {
                if (!this.state.userData.weight) return null;
                
                // Берем 10% от веса тела, округляем до ближайших 2 кг
                const weight = this.state.userData.weight * 0.1;
                const rounded = Math.round(weight / 2) * 2;
                
                // Минимальный вес 4 кг, максимальный 20 кг для безопасности
                return Math.max(4, Math.min(20, rounded));
            }
            
            // Проверка уровня силы для адаптации тренировок
            isBeginnerLevel() {
                const bodyweight = this.state.testResults.bodyweight;
                if (!bodyweight) return true;
                
                // Если подтягиваний 0-5 или вес меньше 65 кг - считаем новичком
                const isLowStrength = bodyweight.pullups <= 5;
                const isLowWeight = this.state.userData.weight < 65;
                
                return isLowStrength || isLowWeight;
            }
            
            startReactionTest() {
                this.clearAllTimeouts();
                
                this.state.testResults.reaction = [];
                document.getElementById('reactionAvg').textContent = '-';
                document.getElementById('reactionBest').textContent = '-';
                document.getElementById('reactionMessage').textContent = 'Приготовьтесь...';
                document.getElementById('startReaction').classList.add('d-none');
                document.getElementById('continueBtn').classList.add('d-none');
                
                const area = document.getElementById('reactionArea');
                area.innerHTML = '';
                area.style.cursor = 'pointer';
                
                this.reactionTest = {
                    startTime: null,
                    targetsShown: 0,
                    totalTargets: 5,
                    times: [],
                    completed: false
                };
                
                setTimeout(() => {
                    this.showNextReactionTarget();
                }, 1000);
            }
            
            showNextReactionTarget() {
                if (this.reactionTest.completed || this.reactionTest.targetsShown >= this.reactionTest.totalTargets) {
                    this.endReactionTest();
                    return;
                }
                
                const area = document.getElementById('reactionArea');
                area.innerHTML = '';
                
                const target = document.createElement('div');
                target.className = 'reaction-target';
                
                const margin = 30;
                const x = margin + Math.random() * (area.offsetWidth - margin * 2);
                const y = margin + Math.random() * (area.offsetHeight - margin * 2);
                
                target.style.left = `${x}px`;
                target.style.top = `${y}px`;
                
                target.addEventListener('mousedown', () => this.handleReactionHit(target));
                target.addEventListener('touchstart', (e) => {
                    this.handleReactionHit(target);
                    e.preventDefault();
                });
                
                area.appendChild(target);
                this.reactionTest.startTime = Date.now();
                this.reactionTest.targetsShown++;
                
                const timeout = setTimeout(() => {
                    if (target.parentElement && !this.reactionTest.completed) {
                        target.style.display = 'none';
                        const nextTimeout = setTimeout(() => {
                            this.showNextReactionTarget();
                        }, 300);
                        this.reactionTimeouts.push(nextTimeout);
                    }
                }, 1500);
                
                this.reactionTimeouts.push(timeout);
            }
            
            handleReactionHit(target) {
                if (this.reactionTest.completed) return;
                
                const reactionTime = Date.now() - this.reactionTest.startTime;
                this.reactionTest.times.push(reactionTime);
                
                const avg = this.reactionTest.times.length > 0 ? 
                    Math.round(this.reactionTest.times.reduce((a, b) => a + b) / this.reactionTest.times.length) : 0;
                const best = this.reactionTest.times.length > 0 ? Math.min(...this.reactionTest.times) : 0;
                
                document.getElementById('reactionAvg').textContent = `${avg}мс`;
                document.getElementById('reactionBest').textContent = `${best}мс`;
                
                this.clearAllTimeouts();
                
                target.style.display = 'none';
                
                const timeout = setTimeout(() => {
                    this.showNextReactionTarget();
                }, 300);
                this.reactionTimeouts.push(timeout);
            }
            
            endReactionTest() {
                this.reactionTest.completed = true;
                this.clearAllTimeouts();
                
                document.getElementById('reactionArea').innerHTML = 
                    '<div class="text-center" style="margin-top: 80px; color: var(--text-tertiary); font-size: var(--font-sm);">Тест завершен!</div>';
                
                this.state.testResults.reaction = this.reactionTest.times;
                this.saveState();
                
                document.getElementById('continueBtn').classList.remove('d-none');
            }
            
            clearAllTimeouts() {
                this.reactionTimeouts.forEach(timeout => clearTimeout(timeout));
                this.reactionTimeouts = [];
            }
            
            calculateFitnessLevel() {
                const bodyweight = this.state.testResults.bodyweight;
                if (!bodyweight) return;
                
                let score = 0;
                if (bodyweight.pushups >= 30) score += 30;
                else if (bodyweight.pushups >= 20) score += 25;
                else if (bodyweight.pushups >= 15) score += 20;
                else if (bodyweight.pushups >= 10) score += 15;
                else if (bodyweight.pushups >= 5) score += 10;
                else if (bodyweight.pushups >= 1) score += 5;
                
                if (bodyweight.plank >= 180) score += 30;
                else if (bodyweight.plank >= 120) score += 25;
                else if (bodyweight.plank >= 90) score += 20;
                else if (bodyweight.plank >= 60) score += 15;
                else if (bodyweight.plank >= 30) score += 10;
                else if (bodyweight.plank >= 10) score += 5;
                
                if (bodyweight.pullups >= 10) score += 20;
                else if (bodyweight.pullups >= 5) score += 15;
                else if (bodyweight.pullups >= 3) score += 10;
                else if (bodyweight.pullups >= 1) score += 5;
                
                if (bodyweight.squats >= 50) score += 20;
                else if (bodyweight.squats >= 40) score += 15;
                else if (bodyweight.squats >= 30) score += 10;
                else if (bodyweight.squats >= 20) score += 5;
                
                let level, description;
                if (score >= 90) {
                    level = "Продвинутый";
                    description = "Отличная физическая форма!";
                } else if (score >= 70) {
                    level = "Выше среднего";
                    description = "Хорошая база для развития.";
                } else if (score >= 50) {
                    level = "Средний";
                    description = "Нормальный уровень для начала.";
                } else if (score >= 30) {
                    level = "Начинающий";
                    description = "Начнем с основ, главное - регулярность!";
                } else {
                    level = "Новичок";
                    description = "Идеальное время для начала тренировок!";
                }
                
                document.getElementById('fitnessLevel').textContent = level;
                document.getElementById('fitnessDescription').textContent = description;
            }
            
            async completeOnboarding() {
                this.state.testResults.bodyweight = {
                    pushups: parseInt(document.getElementById('pushups').value) || 0,
                    plank: parseInt(document.getElementById('plank').value) || 0,
                    pullups: parseInt(document.getElementById('pullups').value) || 0,
                    squats: parseInt(document.getElementById('squats').value) || 0
                };
                
                this.calculateFitnessLevel();
                this.state.hasCompletedOnboarding = true;
                
                await this.saveState();
                
                document.getElementById('onboarding').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('d-none');
                
                this.updateHomeContent();
                this.updateProfile();
                this.updateSportsGrid();
                this.initMiniCalendar();
            }
            
            initTimeBasedContent() {
                this.updateTimeBasedContent();
                setInterval(() => this.updateTimeBasedContent(), 60000);
            }
            
            updateTimeBasedContent() {
                const hours = new Date().getHours();
                let period, greeting;
                
                if (hours >= 6 && hours < 11) {
                    period = 'morning';
                    greeting = 'Доброе утро!';
                } else if (hours >= 11 && hours < 18) {
                    period = 'day';
                    greeting = 'Добрый день!';
                } else {
                    period = 'evening';
                    greeting = 'Добрый вечер!';
                }
                
                document.getElementById('greetingText').textContent = greeting;
                document.getElementById('timePeriod').textContent = 
                    period === 'morning' ? 'Утренние рекомендации' :
                    period === 'day' ? 'Дневные рекомендации' : 'Вечерние рекомендации';
                
                this.updateTodayRecommendations(period);
            }
            
            updateTodayRecommendations(period) {
                const container = document.getElementById('todayRecommendations');
                let html = `
                    <div class="recommendation-card">
                        <div class="recommendation-header">
                            <svg class="recommendation-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 4.93L7.76 7.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M2 12H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4.93 19.07L7.76 16.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 18V22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 16.24L19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M18 12H22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16.24 7.76L19.07 4.93" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <div class="recommendation-title">Рекомендации на ${period === 'morning' ? 'утро' : period === 'day' ? 'день' : 'вечер'}</div>
                        </div>
                        <ul class="recommendation-list">
                `;
                
                const tips = [
                    'Выпейте стакан воды комнатной температуры',
                    period === 'morning' ? 'Легкий завтрак за 30-60 минут до активности' : 
                    period === 'day' ? 'Основной прием пищи за 2-3 часа до тренировки' : 'Легкий ужин за 2-3 часа до сна',
                    'Разминка 10-15 минут перед основной активностью',
                    'Восстановление и растяжка после тренировки'
                ];
                
                // Динамическая вечерняя рекомендация
                if (period === 'evening') {
                    if (this.state.todayWorkoutCompleted) {
                        tips.push('Примите магний для улучшения качества сна и восстановления');
                    } else {
                        tips.push('Сделайте легкую растяжку для расслабления мышц');
                    }
                }
                
                tips.forEach(tip => {
                    html += `
                        <li class="recommendation-item">
                            <svg class="check-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            ${tip}
                        </li>
                    `;
                });
                
                html += `</ul></div>`;
                container.innerHTML = html;
            }
            
            showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById(sectionId).classList.add('active');
                document.querySelector(`[onclick="SportAI.showSection('${sectionId}')"]`).classList.add('active');
            }
            
            showAnalysisTab(tabId) {
                document.querySelectorAll('.analysis-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.analysis-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const tabName = tabId.charAt(0).toUpperCase() + tabId.slice(1);
                document.getElementById('analysis' + tabName).classList.add('active');
                document.querySelector(`[onclick="SportAI.showAnalysisTab('${tabId}')"]`).classList.add('active');
                
                if (tabId === 'data') {
                    this.populateUpdateForm();
                } else if (tabId === 'results') {
                    this.updateAnalysisResults();
                }
            }
            
            updateHomeContent() {
                const favoriteSport = this.getFavoriteSport();
                const favoriteSection = document.getElementById('favoriteSportSection');
                
                if (favoriteSport) {
                    favoriteSection.innerHTML = `
                        <h3 class="h3">Твой основной спорт</h3>
                        <div class="sport-card-large mt-2" onclick="SportAI.showSportDetails('${favoriteSport.id}')">
                            <div class="sport-icon-large">
                                ${favoriteSport.icon}
                            </div>
                            <div class="sport-info">
                                <div class="sport-name">${favoriteSport.name}</div>
                                <div class="sport-desc">${favoriteSport.description}</div>
                            </div>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    `;
                } else {
                    favoriteSection.innerHTML = `
                        <h3 class="h3">Выберите основной спорт</h3>
                        <p class="subtitle">Отметьте спорт звездочкой, чтобы закрепить его здесь</p>
                        <button class="btn btn-primary mt-2" onclick="SportAI.showSection('sports')">
                            Выбрать спорт
                        </button>
                    `;
                }
            }
            
            updateSportsGrid() {
                const container = document.getElementById('sportsGrid');
                container.innerHTML = '';
                
                Object.values(SPORTS_DATABASE).forEach(sport => {
                    const isFavorite = this.state.favorites.includes(sport.id);
                    
                    const card = document.createElement('div');
                    card.className = `sport-card ${isFavorite ? 'favorite' : ''}`;
                    card.innerHTML = `
                        <div class="favorite-star" onclick="event.stopPropagation(); SportAI.toggleFavorite('${sport.id}')">
                            ${isFavorite ? 
                                '<svg viewBox="0 0 24 24" fill="#F59E0B" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="#F59E0B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' :
                                '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
                            }
                        </div>
                        <div class="sport-icon">
                            ${sport.icon}
                        </div>
                        <div class="sport-name">${sport.name}</div>
                        <div class="text-muted" style="font-size: var(--font-xs);">${sport.description}</div>
                    `;
                    
                    card.addEventListener('click', () => {
                        this.showSportDetails(sport.id);
                    });
                    
                    container.appendChild(card);
                });
            }
            
            getFavoriteSport() {
                if (this.state.favorites.length > 0) {
                    return SPORTS_DATABASE[this.state.favorites[0]];
                }
                return null;
            }
            
            async toggleFavorite(sportId) {
                const index = this.state.favorites.indexOf(sportId);
                
                if (index > -1) {
                    this.state.favorites.splice(index, 1);
                } else {
                    if (this.state.favorites.length < 3) {
                        this.state.favorites.push(sportId);
                    } else {
                        alert('Можно выбрать не более 3 избранных видов спорта');
                        return;
                    }
                }
                
                await this.saveState();
                this.updateSportsGrid();
                this.updateHomeContent();
            }
            
            showSportDetails(sportId) {
                this.state.currentSportDetails = sportId;
                const sport = SPORTS_DATABASE[sportId];
                
                if (!sport) return;
                
                document.getElementById('sportDetailsTitle').textContent = sport.name;
                
                // Показываем или скрываем переключатель целей для зала
                const goalSelector = document.getElementById('gymGoalSelector');
                if (sportId === 'gym') {
                    goalSelector.classList.remove('d-none');
                    
                    // Устанавливаем активную цель
                    document.querySelectorAll('.goal-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.goal === this.state.currentGymGoal);
                    });
                    
                    this.updateGymDetails(sport, this.state.currentGymGoal);
                } else {
                    goalSelector.classList.add('d-none');
                    this.updateRegularSportDetails(sport);
                }
                
                document.getElementById('sportDetailsModal').classList.add('active');
            }
            
            updateRegularSportDetails(sport) {
                // Расчет калорий
                const nutritionData = this.calculateSportCalories(sport.id);
                
                // Тренировки
                const workoutList = document.getElementById('workoutList');
                workoutList.innerHTML = sport.workouts.map(workout => `
                    <li class="workout-item">
                        <div class="workout-header">
                            <div class="workout-name">${workout.name}</div>
                        </div>
                        <div class="workout-details">
                            <span class="workout-detail-item">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                    <path d="M8 12H16M12 8V16" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Подходы: ${workout.sets}
                            </span>
                            <span class="workout-detail-item">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Повторения: ${workout.reps}
                            </span>
                            <span class="workout-detail-item">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 20V10M8 20V14M16 20V14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Отдых: ${workout.rest}
                            </span>
                        </div>
                        ${workout.tip ? `<div class="workout-tip">💡 ${workout.tip}</div>` : ''}
                    </li>
                `).join('');
                
                // Питание
                const nutritionGrid = document.getElementById('nutritionGrid');
                if (nutritionData) {
                    nutritionGrid.innerHTML = `
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionData.calories} ккал</div>
                            <div class="nutrition-label">Калории</div>
                            <div class="nutrition-dynamic-note">Рассчитано под ваш вес</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionData.protein} г</div>
                            <div class="nutrition-label">Белок</div>
                            <div class="nutrition-dynamic-note">${sport.nutritionFormula.proteinPerKg} г/кг</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionData.carbs} г</div>
                            <div class="nutrition-label">Углеводы</div>
                            <div class="nutrition-dynamic-note">${sport.nutritionFormula.carbsPerKg} г/кг</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionData.fat} г</div>
                            <div class="nutrition-label">Жиры</div>
                            <div class="nutrition-dynamic-note">${sport.nutritionFormula.fatPerKg} г/кг</div>
                        </div>
                    `;
                }
                
                // Советы по питанию
                const nutritionTips = document.getElementById('nutritionTips');
                const tips = [
                    'Углеводы за 2 часа до тренировки (овсянка, рис)',
                    'Белок после тренировки в течение 30 минут (сывороточный протеин)',
                    'Жиры из орехов и авокадо для здоровья суставов',
                    `Гидратация: ${Math.round(this.state.userData.weight * 30)} мл воды в день`
                ];
                
                nutritionTips.innerHTML = `
                    <ul class="workout-list">
                        ${tips.map(tip => `<li class="workout-item" style="border: none; padding: var(--spacing-xs);">${tip}</li>`).join('')}
                    </ul>
                `;
                
                // Добавки (группировка по категориям)
                this.updateSupplementsByCategory(sport.supplements);
            }
            
            updateGymDetails(sport, goal) {
                const goalData = sport.goals[goal];
                const isBeginner = this.isBeginnerLevel();
                const dumbbellWeight = this.calculateDumbbellWeight();
                
                // Выбираем тренировки в зависимости от уровня
                const workouts = isBeginner ? goalData.adaptiveWorkouts : goalData.baseWorkouts;
                
                // Расчет калорий
                const nutritionData = this.calculateSportCalories('gym', goal);
                
                // Тренировки
                const workoutList = document.getElementById('workoutList');
                workoutList.innerHTML = workouts.map(workout => {
                    let workoutHtml = `
                        <li class="workout-item">
                            <div class="workout-header">
                                <div class="workout-name">${workout.name}</div>
                            </div>
                            <div class="workout-details">
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                        <path d="M8 12H16M12 8V16" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    Подходы: ${workout.sets}
                                </span>
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    Повторения: ${workout.reps}
                                </span>
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 20V10M8 20V14M16 20V14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    Отдых: ${workout.rest}
                                </span>
                            </div>
                    `;
                    
                    // Добавляем совет по выполнению
                    if (workout.tip) {
                        workoutHtml += `<div class="workout-tip">💡 ${workout.tip}</div>`;
                    }
                    
                    // Добавляем адаптивную заметку для новичков
                    if (isBeginner && workout.adaptiveNote) {
                        workoutHtml += `<div class="adaptive-note">⚡ ${workout.adaptiveNote}</div>`;
                    }
                    
                    // Добавляем расчет веса гантелей для упражнений с гантелями
                    if (dumbbellWeight && workout.name.includes('гантел') && isBeginner) {
                        workoutHtml += `<div class="adaptive-note">🏋️ Используйте гантели по <span class="dumbbell-weight">${dumbbellWeight} кг</span> (10% от вашего веса)</div>`;
                    }
                    
                    workoutHtml += `</li>`;
                    return workoutHtml;
                }).join('');
                
                // Питание
                const nutritionGrid = document.getElementById('nutritionGrid');
                if (nutritionData) {
                    nutritionGrid.innerHTML = `
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionData.calories} ккал</div>
                            <div class="nutrition-label">Калории</div>
                            <div class="nutrition-dynamic-note">TDEE + ${goalData.nutritionFormula.calorieSurplus * 100}%</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionData.protein} г</div>
                            <div class="nutrition-label">Белок</div>
                            <div class="nutrition-dynamic-note">${goalData.nutritionFormula.proteinPerKg} г/кг</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionData.carbs} г</div>
                            <div class="nutrition-label">Углеводы</div>
                            <div class="nutrition-dynamic-note">${goalData.nutritionFormula.carbsPerKg} г/кг</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionData.fat} г</div>
                            <div class="nutrition-label">Жиры</div>
                            <div class="nutrition-dynamic-note">${goalData.nutritionFormula.fatPerKg} г/кг</div>
                        </div>
                    `;
                }
                
                // Советы по питанию
                const nutritionTips = document.getElementById('nutritionTips');
                const tips = goal === 'muscle' ? [
                    'Протеиновый коктейль сразу после тренировки',
                    'Углеводы в течение дня для поддержания энергии',
                    'Жиры для выработки тестостерона и гормонального здоровья',
                    'Питание каждые 3-4 часа для постоянного поступления нутриентов'
                ] : [
                    'Контроль углеводов во второй половине дня',
                    'Больше овощей для клетчатки и насыщения',
                    'Дробное питание 5-6 раз в день для контроля аппетита',
                    'Достаточное количество воды для подавления аппетита и метаболизма'
                ];
                
                nutritionTips.innerHTML = `
                    <ul class="workout-list">
                        ${tips.map(tip => `<li class="workout-item" style="border: none; padding: var(--spacing-xs);">${tip}</li>`).join('')}
                    </ul>
                `;
                
                // Добавки (группировка по категориям)
                this.updateSupplementsByCategory(goalData.supplements);
            }
            
            updateSupplementsByCategory(supplements) {
                const container = document.getElementById('supplementsCategories');
                
                // Группировка добавок по категориям
                const categories = {
                    essential: { title: 'Основное', icon: '⭐', supplements: [] },
                    energy: { title: 'Для энергии', icon: '⚡', supplements: [] },
                    recovery: { title: 'Для восстановления', icon: '🔄', supplements: [] }
                };
                
                supplements.forEach(supplement => {
                    if (categories[supplement.category]) {
                        categories[supplement.category].supplements.push(supplement);
                    } else {
                        categories.essential.supplements.push(supplement);
                    }
                });
                
                // Рендеринг категорий
                container.innerHTML = '';
                
                Object.entries(categories).forEach(([categoryId, category]) => {
                    if (category.supplements.length === 0) return;
                    
                    const categoryHtml = `
                        <div class="supplement-category">
                            <div class="category-header">
                                <div class="category-icon">${category.icon}</div>
                                <div class="category-title">${category.title}</div>
                            </div>
                            <ul class="supplements-list">
                                ${category.supplements.map(supplement => `
                                    <li class="supplement-item">
                                        <div class="supplement-name">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                            ${supplement.name}
                                        </div>
                                        <div class="supplement-desc">${supplement.description}</div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                    
                    container.innerHTML += categoryHtml;
                });
            }
            
            closeSportDetails() {
                document.getElementById('sportDetailsModal').classList.remove('active');
                this.state.currentSportDetails = null;
            }
            
            // Инициализация мини-календаря
            initMiniCalendar() {
                const monthNames = [
                    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                ];
                
                const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                
                const today = new Date();
                const currentMonth = this.state.calendarCurrentMonth;
                const currentYear = this.state.calendarCurrentYear;
                
                // Обновляем заголовок календаря
                document.getElementById('calendarMonthTitle').textContent = 
                    `${monthNames[currentMonth]} ${currentYear}`;
                
                // Получаем первый день месяца и количество дней
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay(); // 0 = Воскресенье
                
                // Создаем сетку календаря
                let calendarHTML = '';
                
                // Заголовки дней недели
                dayNames.forEach(day => {
                    calendarHTML += `<div class="calendar-day-header">${day}</div>`;
                });
                
                // Пустые ячейки перед первым днем месяца
                for (let i = 0; i < startingDay; i++) {
                    calendarHTML += `<div class="calendar-day other-month"></div>`;
                }
                
                // Дни месяца
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const dayOfWeek = date.getDay();
                    const dateString = date.toDateString();
                    
                    let dayClass = 'calendar-day';
                    let isToday = false;
                    let isWorkoutDay = false;
                    let isRestDay = false;
                    let hasWorkout = false;
                    
                    // Проверяем, сегодня ли это
                    if (date.getDate() === today.getDate() && 
                        date.getMonth() === today.getMonth() && 
                        date.getFullYear() === today.getFullYear()) {
                        dayClass += ' today';
                        isToday = true;
                    }
                    
                    // Проверяем, тренировочный ли это день
                    if (TRAINING_SCHEDULE.workoutDays.includes(dayOfWeek)) {
                        dayClass += ' workout';
                        isWorkoutDay = true;
                    } else if (TRAINING_SCHEDULE.restDays.includes(dayOfWeek)) {
                        dayClass += ' rest';
                        isRestDay = true;
                    }
                    
                    // Проверяем, есть ли запись о тренировке в этот день
                    if (this.state.workoutHistory[dateString]) {
                        hasWorkout = true;
                    }
                    
                    // Добавляем индикатор выполненной тренировки
                    let indicator = '';
                    if (hasWorkout) {
                        indicator = ' ✓';
                    }
                    
                    calendarHTML += `
                        <div class="${dayClass}" 
                             data-day="${day}" 
                             data-month="${currentMonth}" 
                             data-year="${currentYear}"
                             onclick="SportAI.showDayInfo(${day}, ${currentMonth}, ${currentYear})">
                            ${day}${indicator}
                        </div>
                    `;
                }
                
                // Оставшиеся пустые ячейки
                const totalCells = 42; // 6 строк * 7 дней
                const filledCells = startingDay + daysInMonth;
                const remainingCells = totalCells - filledCells;
                
                for (let i = 0; i < remainingCells; i++) {
                    calendarHTML += `<div class="calendar-day other-month"></div>`;
                }
                
                document.getElementById('miniCalendar').innerHTML = calendarHTML;
            }
            
            // Смена месяца в календаре
            changeCalendarMonth(direction) {
                let newMonth = this.state.calendarCurrentMonth + direction;
                let newYear = this.state.calendarCurrentYear;
                
                if (newMonth < 0) {
                    newMonth = 11;
                    newYear--;
                } else if (newMonth > 11) {
                    newMonth = 0;
                    newYear++;
                }
                
                this.state.calendarCurrentMonth = newMonth;
                this.state.calendarCurrentYear = newYear;
                
                this.saveState();
                this.initMiniCalendar();
            }
            
            // Показать информацию о дне
            showDayInfo(day, month, year) {
                const date = new Date(year, month, day);
                const dateString = date.toDateString();
                const dayOfWeek = date.getDay();
                const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
                const monthNames = [
                    'Января', 'Февраля', 'Марта', 'Апреля', 'Мая', 'Июня',
                    'Июля', 'Августа', 'Сентября', 'Октября', 'Ноября', 'Декабря'
                ];
                
                const dayName = dayNames[dayOfWeek];
                const monthName = monthNames[month];
                
                // Проверяем, тренировочный ли это день
                const isWorkoutDay = TRAINING_SCHEDULE.workoutDays.includes(dayOfWeek);
                const hasWorkout = this.state.workoutHistory[dateString];
                
                let dayInfoHTML = '';
                
                if (isWorkoutDay) {
                    // Тренировочный день
                    dayInfoHTML = `
                        <div class="calendar-modal-day workout">
                            <h3 class="calendar-modal-title">${day} ${monthName} - ${dayName}</h3>
                            <p class="calendar-modal-subtitle">🏋️ Тренировочный день</p>
                            
                            ${hasWorkout ? 
                                `<div style="background: rgba(16, 185, 129, 0.2); padding: var(--spacing-sm); border-radius: var(--radius); margin-bottom: var(--spacing-sm);">
                                    <strong>✓ Тренировка выполнена</strong>
                                </div>` : 
                                `<div style="background: rgba(245, 158, 11, 0.2); padding: var(--spacing-sm); border-radius: var(--radius); margin-bottom: var(--spacing-sm);">
                                    <strong>📝 Запланирована тренировка</strong>
                                </div>`
                            }
                            
                            <div class="workout-schedule">
                                <h4 style="margin-bottom: var(--spacing-sm);">Расписание тренировки:</h4>
                                <div class="schedule-item">
                                    <div class="schedule-time">${TRAINING_SCHEDULE.workoutTime}</div>
                                    <div class="schedule-activity">Силовая тренировка</div>
                                </div>
                                <div class="schedule-item">
                                    <div class="schedule-time">20:00-20:15</div>
                                    <div class="schedule-activity">Растяжка и заминка</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: var(--spacing-md);">
                                <h4 style="margin-bottom: var(--spacing-sm);">Рекомендации:</h4>
                                <ul style="list-style: none; padding-left: 0;">
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• Прием пищи за 2-3 часа до тренировки</li>
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• 500 мл воды во время тренировки</li>
                                    <li style="padding: var(--spacing-xs) 0;">• Протеиновый коктейль в течение 30 минут после</li>
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    // День отдыха
                    const proteinTarget = this.state.userData.weight ? 
                        Math.round(this.state.userData.weight * 2.2) : 'X';
                    
                    dayInfoHTML = `
                        <div class="calendar-modal-day rest">
                            <h3 class="calendar-modal-title">${day} ${monthName} - ${dayName}</h3>
                            <p class="calendar-modal-subtitle">🧘 День отдыха и восстановления</p>
                            
                            <div style="background: rgba(139, 92, 246, 0.2); padding: var(--spacing-sm); border-radius: var(--radius); margin-bottom: var(--spacing-sm);">
                                <strong>Важно дать мышцам восстановиться!</strong>
                            </div>
                            
                            <div style="margin-top: var(--spacing-md);">
                                <h4 style="margin-bottom: var(--spacing-sm);">Цели на день:</h4>
                                <ul style="list-style: none; padding-left: 0;">
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• <strong>Белок:</strong> ${proteinTarget} грамм</li>
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• <strong>Сон:</strong> не менее 8 часов</li>
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• <strong>Вода:</strong> 2-3 литра</li>
                                    <li style="padding: var(--spacing-xs) 0;">• <strong>Активность:</strong> легкая прогулка 30-40 минут</li>
                                </ul>
                            </div>
                            
                            <div style="margin-top: var(--spacing-md);">
                                <h4 style="margin-bottom: var(--spacing-sm);">Рекомендации по восстановлению:</h4>
                                <ul style="list-style: none; padding-left: 0;">
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• Сделайте легкую растяжку утром и вечером</li>
                                    <li style="padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--border-light);">• Примите магний перед сном для улучшения восстановления</li>
                                    <li style="padding: var(--spacing-xs) 0;">• Избегайте интенсивной активности</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Проверяем, сегодня ли это
                const today = new Date();
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                if (isToday && isWorkoutDay && !hasWorkout) {
                    dayInfoHTML += `
                        <button class="btn btn-primary btn-block mt-4" onclick="SportAI.markWorkoutToday(); SportAI.closeCalendarModal();">
                            Отметить тренировку сегодня
                        </button>
                    `;
                }
                
                document.getElementById('calendarDayInfo').innerHTML = dayInfoHTML;
                document.getElementById('calendarModal').classList.add('active');
            }
            
            closeCalendarModal() {
                document.getElementById('calendarModal').classList.remove('active');
            }
            
            updateProfile() {
                const avatar = document.getElementById('profileAvatar');
                const name = document.getElementById('profileName');
                
                if (this.state.userData.gender) {
                    avatar.textContent = this.state.userData.gender === 'male' ? 'М' : 'Ж';
                }
                
                const age = document.getElementById('profileAge');
                const gender = document.getElementById('profileGender');
                
                if (this.state.userData.age) {
                    age.textContent = `${this.state.userData.age} лет`;
                }
                
                if (this.state.userData.gender) {
                    gender.textContent = this.state.userData.gender === 'male' ? 'Мужской' : 'Женский';
                }
                
                const bmi = this.calculateBMI();
                const bmiElement = document.getElementById('profileBmi');
                if (bmi) {
                    bmiElement.textContent = bmi.toFixed(1);
                }
                
                const bodyType = this.calculateBodyType();
                const bodyTypeElement = document.getElementById('profileBodyType');
                if (bodyType) {
                    bodyTypeElement.textContent = bodyType.name;
                }
                
                this.updatePersonalRecords();
            }
            
            calculateBMI() {
                if (!this.state.userData.height || !this.state.userData.weight) {
                    return null;
                }
                
                const heightM = this.state.userData.height / 100;
                return this.state.userData.weight / (heightM * heightM);
            }
            
            calculateBodyType() {
                if (!this.state.userData.wrist || !this.state.userData.height || !this.state.userData.gender) {
                    return null;
                }
                
                const solovyovIndex = (this.state.userData.wrist * this.state.userData.height) / 240;
                
                let bodyType;
                if (this.state.userData.gender === 'male') {
                    if (solovyovIndex < 15) bodyType = { name: 'Астеник', desc: 'Худощавое телосложение' };
                    else if (solovyovIndex <= 17) bodyType = { name: 'Нормостеник', desc: 'Среднее телосложение' };
                    else bodyType = { name: 'Гиперстеник', desc: 'Крупное телосложение' };
                } else {
                    if (solovyovIndex < 13) bodyType = { name: 'Астеник', desc: 'Худощавое телосложение' };
                    else if (solovyovIndex <= 15) bodyType = { name: 'Нормостеник', desc: 'Среднее телосложение' };
                    else bodyType = { name: 'Гиперстеник', desc: 'Крупное телосложение' };
                }
                
                return bodyType;
            }
            
            updatePersonalRecords() {
                const container = document.getElementById('personalRecords');
                
                if (!this.state.testResults.bodyweight || Object.keys(this.state.testResults.bodyweight).length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted" style="padding: var(--spacing-md);">
                            Пройдите тестирование
                        </div>
                    `;
                    return;
                }
                
                const records = [
                    { name: 'Отжимания', value: this.state.testResults.bodyweight.pushups, unit: 'раз' },
                    { name: 'Планка', value: this.state.testResults.bodyweight.plank, unit: 'сек' },
                    { name: 'Подтягивания', value: this.state.testResults.bodyweight.pullups, unit: 'раз' },
                    { name: 'Приседания', value: this.state.testResults.bodyweight.squats, unit: 'раз' }
                ];
                
                let html = '';
                records.forEach(record => {
                    if (record.value > 0) {
                        html += `
                            <li class="record-item">
                                <div class="record-info">
                                    <div class="record-name">${record.name}</div>
                                    <div class="record-date">Последний тест</div>
                                </div>
                                <div class="record-value">${record.value} ${record.unit}</div>
                            </li>
                        `;
                    }
                });
                
                if (html === '') {
                    html = `
                        <div class="text-center text-muted" style="padding: var(--spacing-md);">
                            Пока нет рекордов
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }
            
            populateUpdateForm() {
                if (this.state.userData.height) {
                    document.getElementById('updateHeight').value = this.state.userData.height;
                }
                if (this.state.userData.weight) {
                    document.getElementById('updateWeight').value = this.state.userData.weight;
                }
                if (this.state.userData.wrist) {
                    document.getElementById('updateWrist').value = this.state.userData.wrist;
                }
                if (this.state.userData.ankle) {
                    document.getElementById('updateAnkle').value = this.state.userData.ankle;
                }
                if (this.state.testResults.bodyweight.pushups !== undefined) {
                    document.getElementById('updatePushups').value = this.state.testResults.bodyweight.pushups;
                }
                if (this.state.testResults.bodyweight.plank !== undefined) {
                    document.getElementById('updatePlank').value = this.state.testResults.bodyweight.plank;
                }
                if (this.state.testResults.bodyweight.pullups !== undefined) {
                    document.getElementById('updatePullups').value = this.state.testResults.bodyweight.pullups;
                }
                if (this.state.testResults.bodyweight.squats !== undefined) {
                    document.getElementById('updateSquats').value = this.state.testResults.bodyweight.squats;
                }
            }
            
            async updateUserData() {
                const height = parseInt(document.getElementById('updateHeight').value);
                const weight = parseInt(document.getElementById('updateWeight').value);
                const wrist = parseFloat(document.getElementById('updateWrist').value);
                const ankle = parseFloat(document.getElementById('updateAnkle').value);
                
                if (!height || !weight || !wrist || !ankle) {
                    alert('Заполните все поля');
                    return;
                }
                
                this.state.userData.height = height;
                this.state.userData.weight = weight;
                this.state.userData.wrist = wrist;
                this.state.userData.ankle = ankle;
                
                await this.saveState();
                this.updateProfile();
                
                // Пересчитываем все данные питания
                if (this.state.currentSportDetails) {
                    this.showSportDetails(this.state.currentSportDetails);
                }
                
                alert('Данные обновлены! Питание пересчитано под ваш новый вес.');
            }
            
            async updateBodyweightTest() {
                const pushups = parseInt(document.getElementById('updatePushups').value) || 0;
                const plank = parseInt(document.getElementById('updatePlank').value) || 0;
                const pullups = parseInt(document.getElementById('updatePullups').value) || 0;
                const squats = parseInt(document.getElementById('updateSquats').value) || 0;
                
                this.state.testResults.bodyweight = {
                    pushups: pushups,
                    plank: plank,
                    pullups: pullups,
                    squats: squats
                };
                
                await this.saveState();
                this.calculateFitnessLevel();
                this.updateProfile();
                alert('Рекорды обновлены!');
            }
            
            updateAnalysisResults() {
                // Реакция
                if (this.state.testResults.reaction && this.state.testResults.reaction.length > 0) {
                    const avg = Math.round(this.state.testResults.reaction.reduce((a, b) => a + b) / this.state.testResults.reaction.length);
                    let reactionLevel;
                    if (avg < 200) reactionLevel = 'Отличная';
                    else if (avg < 250) reactionLevel = 'Хорошая';
                    else if (avg < 300) reactionLevel = 'Средняя';
                    else reactionLevel = 'Низкая';
                    
                    document.getElementById('analysisReaction').textContent = reactionLevel;
                } else {
                    document.getElementById('analysisReaction').textContent = 'Не тестирована';
                }
                
                // Сила
                const strength = this.calculateStrengthScore();
                if (strength) {
                    let strengthLevel;
                    if (strength >= 80) strengthLevel = 'Высокий';
                    else if (strength >= 60) strengthLevel = 'Выше среднего';
                    else if (strength >= 40) strengthLevel = 'Средний';
                    else if (strength >= 20) strengthLevel = 'Ниже среднего';
                    else strengthLevel = 'Низкий';
                    
                    document.getElementById('analysisStrength').textContent = strengthLevel;
                } else {
                    document.getElementById('analysisStrength').textContent = 'Не тестирован';
                }
                
                // Соматотип
                const bodyType = this.calculateBodyType();
                if (bodyType) {
                    document.getElementById('analysisBodyType').textContent = bodyType.name;
                    document.getElementById('analysisBodyTypeDesc').textContent = bodyType.desc;
                }
                
                // BMI
                const bmi = this.calculateBMI();
                if (bmi) {
                    document.getElementById('analysisBmi').textContent = bmi.toFixed(1);
                    
                    let category;
                    if (bmi < 18.5) category = 'Недостаточный вес';
                    else if (bmi < 25) category = 'Нормальный вес';
                    else if (bmi < 30) category = 'Избыточный вес';
                    else category = 'Ожирение';
                    
                    document.getElementById('analysisBmiCategory').textContent = category;
                }
            }
            
            calculateStrengthScore() {
                const bodyweight = this.state.testResults.bodyweight;
                if (!bodyweight) return null;
                
                let score = 0;
                if (bodyweight.pushups > 0) score += Math.min(30, bodyweight.pushups * 1.5);
                if (bodyweight.pullups > 0) score += Math.min(30, bodyweight.pullups * 8);
                if (bodyweight.plank > 0) score += Math.min(20, bodyweight.plank / 3);
                if (bodyweight.squats > 0) score += Math.min(20, bodyweight.squats / 2);
                
                return Math.min(100, score);
            }
            
            // === ИИ ФУНКЦИОНАЛ ===
            
            // Генерация тренировки через ИИ
            async generateWorkout() {
                if (!this.state.currentSportDetails) {
                    alert('Сначала выберите спорт');
                    return;
                }
                
                const sport = SPORTS_DATABASE[this.state.currentSportDetails];
                const goal = this.state.currentGymGoal;
                const weight = this.state.userData.weight || 70;
                const height = this.state.userData.height || 175;
                const isBeginner = this.isBeginnerLevel();
                
                const loading = document.getElementById('workoutLoading');
                loading.classList.add('active');
                
                try {
                    let prompt = '';
                    
                    if (this.state.currentSportDetails === 'gym') {
                        prompt = `Ты персональный тренер. Создай список из 5 упражнений для тренажерного зала для цели "${goal === 'muscle' ? 'набор мышечной массы' : 'форма и рельеф'}".
Данные пользователя: вес ${weight} кг, рост ${height} см, уровень подготовки: ${isBeginner ? 'новичок' : 'средний'}.
Выведи ТОЛЬКО список упражнений в формате:
1. Название упражнения (подходы x повторения, отдых: время)
2. Название упражнения (подходы x повторения, отдых: время)
и т.д.
Без вступлений и пояснений, только сухой список.`;
                    } else {
                        prompt = `Ты персональный тренер. Создай список из 5 упражнений для вида спорта "${sport.name}".
Данные пользователя: вес ${weight} кг, рост ${height} см.
Выведи ТОЛЬКО список упражнений в формате:
1. Название упражнения (подходы x повторения, отдых: время)
2. Название упражнения (подходы x повторения, отдых: время)
и т.д.
Без вступлений и пояснений, только сухой список.`;
                    }
                    
                    const workoutText = await this.callLMStudioAPI(prompt);
                    
                    // Парсим ответ ИИ и преобразуем в формат тренировок
                    const workouts = this.parseAIWorkoutResponse(workoutText);
                    
                    // Обновляем список тренировок
                    const workoutList = document.getElementById('workoutList');
                    workoutList.innerHTML = workouts.map(workout => `
                        <li class="workout-item">
                            <div class="workout-header">
                                <div class="workout-name">${workout.name}</div>
                            </div>
                            <div class="workout-details">
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                        <path d="M8 12H16M12 8V16" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    Подходы: ${workout.sets}
                                </span>
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    Повторения: ${workout.reps}
                                </span>
                                <span class="workout-detail-item">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 20V10M8 20V14M16 20V14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    Отдых: ${workout.rest}
                                </span>
                            </div>
                            ${workout.tip ? `<div class="workout-tip">💡 ${workout.tip}</div>` : ''}
                        </li>
                    `).join('');
                    
                } catch (error) {
                    console.error('Ошибка генерации тренировки:', error);
                    alert('Не удалось сгенерировать тренировку. Проверьте подключение к LM Studio.');
                } finally {
                    loading.classList.remove('active');
                }
            }
            
            // Генерация добавок через ИИ
            async generateSupplements() {
                const weight = this.state.userData.weight || 70;
                const height = this.state.userData.height || 175;
                const sport = this.state.currentSportDetails ? SPORTS_DATABASE[this.state.currentSportDetails] : null;
                
                if (!weight) {
                    alert('Укажите ваш вес в профиле');
                    return;
                }
                
                const loading = document.getElementById('supplementsLoading');
                loading.classList.add('active');
                
                try {
                    let prompt = '';
                    
                    if (sport && sport.id === 'gym') {
                        prompt = `Ты персональный тренер. Подбери добавки для тренажерного зала для цели "${this.state.currentGymGoal === 'muscle' ? 'набор мышечной массы' : 'форма и рельеф'}".
Данные пользователя: вес ${weight} кг.
Выведи ТОЛЬКО список добавок в формате:
Название добавки: граммовка/дозировка в день
Название добавки: граммовка/дозировка в день
и т.д.
Пример: Креатин моногидрат: 5 г в день
Без вступлений и пояснений, только сухой список.`;
                    } else if (sport) {
                        prompt = `Ты персональный тренер. Подбери добавки для вида спорта "${sport.name}".
Данные пользователя: вес ${weight} кг.
Выведи ТОЛЬКО список добавок в формате:
Название добавки: граммовка/дозировка в день
Название добавки: граммовка/дозировка в день
и т.д.
Пример: Креатин моногидрат: 5 г в день
Без вступлений и пояснений, только сухой список.`;
                    } else {
                        prompt = `Ты персональный тренер. Подбери базовые добавки для активного образа жизни.
Данные пользователя: вес ${weight} кг.
Выведи ТОЛЬКО список добавок в формате:
Название добавки: граммовка/дозировка в день
Название добавки: граммовка/дозировка в день
и т.д.
Пример: Омега-3: 2000 мг в день
Без вступлений и пояснений, только сухой список.`;
                    }
                    
                    const supplementsText = await this.callLMStudioAPI(prompt);
                    
                    // Парсим ответ ИИ и преобразуем в формат добавок
                    const supplements = this.parseAISupplementsResponse(supplementsText);
                    
                    // Обновляем список добавок
                    const container = document.getElementById('supplementsCategories');
                    
                    // Группируем по категориям (упрощенно)
                    const categories = {
                        essential: { title: 'Основное', icon: '⭐', supplements: supplements.slice(0, 2) },
                        recovery: { title: 'Для восстановления', icon: '🔄', supplements: supplements.slice(2, 4) }
                    };
                    
                    // Рендеринг категорий
                    container.innerHTML = '';
                    
                    Object.entries(categories).forEach(([categoryId, category]) => {
                        if (category.supplements.length === 0) return;
                        
                        const categoryHtml = `
                            <div class="supplement-category">
                                <div class="category-header">
                                    <div class="category-icon">${category.icon}</div>
                                    <div class="category-title">${category.title}</div>
                                </div>
                                <ul class="supplements-list">
                                    ${category.supplements.map(supplement => `
                                        <li class="supplement-item">
                                            <div class="supplement-name">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                    <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                </svg>
                                                ${supplement.name}
                                            </div>
                                            <div class="supplement-desc">${supplement.description}</div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                        
                        container.innerHTML += categoryHtml;
                    });
                    
                } catch (error) {
                    console.error('Ошибка генерации добавок:', error);
                    alert('Не удалось подобрать добавки. Проверьте подключение к LM Studio.');
                } finally {
                    loading.classList.remove('active');
                }
            }
            
            // Чат с ИИ-тренером
            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                // Очищаем поле ввода
                input.value = '';
                
                // Добавляем сообщение пользователя в чат
                this.addChatMessage(message, 'user');
                
                // Показываем индикатор загрузки
                const loading = document.getElementById('chatLoading');
                loading.classList.add('active');
                
                try {
                    // Собираем данные пользователя для системного промпта
                    const weight = this.state.userData.weight || 'не указан';
                    const height = this.state.userData.height || 'не указан';
                    const goal = this.state.currentGymGoal === 'muscle' ? 'набор мышечной массы' : 
                                this.state.currentGymGoal === 'shape' ? 'форма и рельеф' : 'не указана';
                    const sport = this.state.currentSportDetails ? SPORTS_DATABASE[this.state.currentSportDetails].name : 'не выбран';
                    
                    // Системный промпт
                    const systemPrompt = `Ты персональный тренер. Данные пользователя: вес ${weight} кг, рост ${height} см, цель ${goal}, основной спорт: ${sport}. 
                    Отвечай кратко и по делу, только по теме тренировок, питания и восстановления. Не пиши вступлений типа "Конечно, вот ответ".`;
                    
                    // Формируем промпт для ИИ
                    const prompt = `${systemPrompt}\n\nВопрос пользователя: ${message}`;
                    
                    // Вызываем API
                    const response = await this.callLMStudioAPI(prompt);
                    
                    // Добавляем ответ ИИ в чат
                    this.addChatMessage(response, 'assistant');
                    
                    // Сохраняем в историю
                    this.state.chatHistory.push({
                        role: 'user',
                        content: message
                    });
                    this.state.chatHistory.push({
                        role: 'assistant',
                        content: response
                    });
                    
                    // Сохраняем состояние
                    await this.saveState();
                    
                } catch (error) {
                    console.error('Ошибка отправки сообщения:', error);
                    this.addChatMessage('Извините, произошла ошибка. Проверьте подключение к LM Studio.', 'assistant');
                } finally {
                    loading.classList.remove('active');
                }
            }
            
            // Добавление сообщения в чат
            addChatMessage(message, role) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${role}`;
                messageDiv.textContent = message;
                messagesContainer.appendChild(messageDiv);
                
                // Прокручиваем вниз
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // Открыть/закрыть чат
            toggleChat() {
                const chat = document.getElementById('aiChat');
                chat.classList.toggle('active');
                
                if (chat.classList.contains('active')) {
                    document.getElementById('chatInput').focus();
                }
            }
            
            closeChat() {
                document.getElementById('aiChat').classList.remove('active');
            }
            
            // Вызов LM Studio API
            async callLMStudioAPI(prompt) {
                try {
                    const response = await fetch(LM_STUDIO_CONFIG.endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: LM_STUDIO_CONFIG.model,
                            messages: [
                                {
                                    role: "system",
                                    content: "Ты персональный тренер. Отвечай кратко и по делу."
                                },
                                {
                                    role: "user",
                                    content: prompt
                                }
                            ],
                            temperature: LM_STUDIO_CONFIG.temperature,
                            max_tokens: LM_STUDIO_CONFIG.max_tokens,
                            stream: false
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        return data.choices[0].message.content.trim();
                    } else {
                        throw new Error('Invalid response format from LM Studio');
                    }
                    
                } catch (error) {
                    console.error('Error calling LM Studio API:', error);
                    
                    // Fallback: возвращаем тестовые данные если API недоступно
                    if (prompt.includes('упражнения')) {
                        return `1. Приседания со штангой (4x8-12, отдых: 90 сек)
2. Жим штанги лежа (4x8-12, отдых: 90 сек)
3. Тяга штанги в наклоне (3x10-12, отдых: 60 сек)
4. Жим гантелей сидя (3x10-12, отдых: 60 сек)
5. Подтягивания (3xмакс, отдых: 60 сек)`;
                    } else if (prompt.includes('добавки')) {
                        return `Креатин моногидрат: 5 г в день
Сывороточный протеин: 30 г после тренировки
Омега-3: 2000 мг в день
Витамин D3: 2000 МЕ в день
Магний: 400 мг перед сном`;
                    } else {
                        return `Извините, сервис временно недоступен. Проверьте, что LM Studio запущен на http://127.0.0.1:1234 и модель mistralai/mistral-3-3b загружена.`;
                    }
                }
            }
            
            // Парсинг ответа ИИ для тренировок
            parseAIWorkoutResponse(text) {
                const lines = text.split('\n').filter(line => line.trim());
                const workouts = [];
                
                lines.forEach(line => {
                    // Пытаемся извлечь данные из формата: "1. Название (подходы x повторения, отдых: время)"
                    const match = line.match(/(\d+)\.\s+(.+?)\s+\((.+?)\)/);
                    if (match) {
                        const [, number, name, details] = match;
                        
                        // Парсим детали
                        let sets = '3-4';
                        let reps = '10-12';
                        let rest = '60-90 сек';
                        
                        if (details.includes('x')) {
                            const setsRepsMatch = details.match(/(\d+)(?:-(\d+))?x(\d+)(?:-(\d+))?/);
                            if (setsRepsMatch) {
                                const [, setMin, setMax, repMin, repMax] = setsRepsMatch;
                                sets = setMax ? `${setMin}-${setMax}` : setMin;
                                reps = repMax ? `${repMin}-${repMax}` : repMin;
                            }
                        }
                        
                        // Ищем время отдыха
                        const restMatch = details.match(/отдых:\s*([^,]+)/i);
                        if (restMatch) {
                            rest = restMatch[1].trim();
                        }
                        
                        workouts.push({
                            name: name.trim(),
                            sets: sets,
                            reps: reps,
                            rest: rest,
                            tip: 'Сгенерировано ИИ на основе ваших данных'
                        });
                    } else if (line.includes('.')) {
                        // Упрощенный парсинг
                        const parts = line.split('.');
                        if (parts.length > 1) {
                            workouts.push({
                                name: parts[1].trim(),
                                sets: '3-4',
                                reps: '10-12',
                                rest: '60-90 сек',
                                tip: 'Сгенерировано ИИ на основе ваших данных'
                            });
                        }
                    }
                });
                
                // Если не удалось распарсить, создаем тестовые данные
                if (workouts.length === 0) {
                    return [
                        { name: 'Приседания со штангой', sets: '4', reps: '8-12', rest: '90 сек', tip: 'Сгенерировано ИИ на основе ваших данных' },
                        { name: 'Жим штанги лежа', sets: '4', reps: '8-12', rest: '90 сек', tip: 'Сгенерировано ИИ на основе ваших данных' },
                        { name: 'Тяга штанги в наклоне', sets: '3', reps: '10-12', rest: '60 сек', tip: 'Сгенерировано ИИ на основе ваших данных' },
                        { name: 'Армейский жим', sets: '3', reps: '10-12', rest: '60 сек', tip: 'Сгенерировано ИИ на основе ваших данных' },
                        { name: 'Подтягивания', sets: '3', reps: 'макс', rest: '60 сек', tip: 'Сгенерировано ИИ на основе ваших данных' }
                    ];
                }
                
                return workouts.slice(0, 5); // Берем максимум 5 упражнений
            }
            
            // Парсинг ответа ИИ для добавок
            parseAISupplementsResponse(text) {
                const lines = text.split('\n').filter(line => line.trim());
                const supplements = [];
                
                lines.forEach(line => {
                    // Пытаемся извлечь данные из формата: "Название: дозировка"
                    const colonMatch = line.match(/^(.+?):\s*(.+)$/);
                    if (colonMatch) {
                        const [, name, dosage] = colonMatch;
                        supplements.push({
                            name: name.trim(),
                            description: `Рекомендуемая дозировка: ${dosage.trim()}. Сгенерировано ИИ на основе вашего веса.`,
                            category: supplements.length < 2 ? 'essential' : 'recovery'
                        });
                    }
                });
                
                // Если не удалось распарсить, создаем тестовые данные
                if (supplements.length === 0) {
                    return [
                        { name: 'Креатин моногидрат', description: 'Рекомендуемая дозировка: 5 г в день. Сгенерировано ИИ на основе вашего веса.', category: 'essential' },
                        { name: 'Сывороточный протеин', description: 'Рекомендуемая дозировка: 30 г после тренировки. Сгенерировано ИИ на основе вашего веса.', category: 'essential' },
                        { name: 'Омега-3', description: 'Рекомендуемая дозировка: 2000 мг в день. Сгенерировано ИИ на основе вашего веса.', category: 'recovery' },
                        { name: 'Магний', description: 'Рекомендуемая дозировка: 400 мг перед сном. Сгенерировано ИИ на основе вашего веса.', category: 'recovery' }
                    ];
                }
                
                return supplements.slice(0, 4); // Берем максимум 4 добавки
            }
            
            async resetApp() {
                if (confirm('Сбросить все данные и начать заново?')) {
                    if (this.isTelegram) {
                        try {
                            await window.Telegram.WebApp.CloudStorage.removeItem('sportAIState');
                        } catch (error) {
                            console.error('Ошибка удаления из CloudStorage:', error);
                        }
                    }
                    
                    localStorage.removeItem('sportAIState');
                    localStorage.removeItem('user_tested');
                    location.reload();
                }
            }
        }

        // Инициализация приложения
        const SportAI = new SportAIPro();
        window.SportAI = SportAI;

        // Экспорт функций для использования в HTML
        window.SportAIPro = SportAIPro;
    </script>
</body>
</html>
